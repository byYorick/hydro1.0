# –û—Ç—á–µ—Ç –æ–± –∞–Ω–∞–ª–∏–∑–µ –∫–æ–¥–∞ PID-—Å–∏—Å—Ç–µ–º—ã

**–î–∞—Ç–∞:** 2025-10-10  
**–°—Ç–∞—Ç—É—Å:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –Ω–∞–π–¥–µ–Ω—ã

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. **–£—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –≤ UI —ç–∫—Ä–∞–Ω–∞—Ö** (CRITICAL)
**–§–∞–π–ª—ã:** –í—Å–µ `*_screen.c` —Ñ–∞–π–ª—ã

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–∫—Ä–∞–Ω–æ–≤ —Å–æ–∑–¥–∞—é—Ç—Å—è LVGL –æ–±—ä–µ–∫—Ç—ã
- –ù–ï–¢ —Ñ—É–Ω–∫—Ü–∏–π cleanup/destroy –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —ç–∫—Ä–∞–Ω–æ–≤
- –ü—Ä–∏ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å cleanup —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∫–∞–∂–¥—ã–π —ç–∫—Ä–∞–Ω:
```c
void pid_detail_screen_destroy(lv_obj_t *screen) {
    if (screen) {
        lv_obj_del(screen);
    }
}
```

---

### 2. **Race Condition –≤ pump_manager_compute_and_execute** (CRITICAL)
**–§–∞–π–ª:** `pump_manager.c:369-482`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```c
// Line 457: –ú—å—é—Ç–µ–∫—Å –æ—Ç–ø—É—â–µ–Ω –ü–ï–†–ï–î –∑–∞–ø—É—Å–∫–æ–º –Ω–∞—Å–æ—Å–∞!
xSemaphoreGive(g_pump_mutexes[pump_idx]);

// Line 460: –ù–∞—Å–æ—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ë–ï–ó –∑–∞—â–∏—Ç—ã –º—å—é—Ç–µ–∫—Å–∞
esp_err_t result = run_pump_with_retry(pump_idx, duration_ms);

// Line 464: –°–Ω–æ–≤–∞ –±–µ—Ä–µ—Ç—Å—è –º—å—é—Ç–µ–∫—Å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
if (xSemaphoreTake(g_pump_mutexes[pump_idx], pdMS_TO_TICKS(1000)) == pdTRUE)
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ú–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏ 457-464 –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å g_pump_stats
- –í–æ–∑–º–æ–∂–Ω–∞ –≥–æ–Ω–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ daily_volume_ml
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π

**–†–µ—à–µ–Ω–∏–µ:**
```c
// –ù–µ –æ—Ç–ø—É—Å–∫–∞—Ç—å –º—å—é—Ç–µ–∫—Å –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
// –ò–õ–ò –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤
```

---

### 3. **Deadlock —Ä–∏—Å–∫ –≤ pump_manager_task** (HIGH)
**–§–∞–π–ª:** `pump_manager.c:223-237`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```c
for (int i = 0; i < PUMP_INDEX_COUNT; i++) {
    if (xSemaphoreTake(g_pump_mutexes[i], pdMS_TO_TICKS(1000)) == pdTRUE) {
        // ...
        xSemaphoreGive(g_pump_mutexes[i]);
    }
}
```

–ï—Å–ª–∏ –æ–¥–∏–Ω –º—å—é—Ç–µ–∫—Å –∑–∞–Ω—è—Ç > 1 —Å–µ–∫, loop –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏!

**–†–µ—à–µ–Ω–∏–µ:**
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å failed takes
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–π timeout –∏–ª–∏ –ø–æ–ø—ã—Ç–∫–∏ retry

---

### 4. **–ù–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π PID integral limits** (HIGH)
**–§–∞–π–ª:** `pump_manager.c:91-135`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```c
// Line 106-109: integral –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è output_max
if (pid->integral > pid->output_max) {
    pid->integral = pid->output_max;
}
```

–ù–û –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è `g_pid_configs[pump_idx].integral_max` –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏!

**–†–µ—à–µ–Ω–∏–µ:**
```c
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
float integral_limit = /* –ø–æ–ª—É—á–∏—Ç—å –∏–∑ g_pid_configs */;
if (pid->integral > integral_limit) {
    pid->integral = integral_limit;
}
```

---

### 5. **–£—Ç–µ—á–∫–∞ –º—å—é—Ç–µ–∫—Å–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏** (MEDIUM)
**–§–∞–π–ª:** `pump_manager.c:245-326`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```c
// Line 254-260: –°–æ–∑–¥–∞—é—Ç—Å—è –º—å—é—Ç–µ–∫—Å—ã
for (int i = 0; i < PUMP_INDEX_COUNT; i++) {
    g_pump_mutexes[i] = xSemaphoreCreateMutex();
    if (g_pump_mutexes[i] == NULL) {
        ESP_LOGE(TAG, "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –º—å—é—Ç–µ–∫—Å –¥–ª—è –Ω–∞—Å–æ—Å–∞ %d", i);
        return ESP_ERR_NO_MEM; // <-- –£–¢–ï–ß–ö–ê! –ù–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –º—å—é—Ç–µ–∫—Å—ã
    }
}
```

**–†–µ—à–µ–Ω–∏–µ:**
```c
// –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –º—å—é—Ç–µ–∫—Å—ã
for (int j = 0; j < i; j++) {
    vSemaphoreDelete(g_pump_mutexes[j]);
}
```

---

### 6. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ PID integral –≤ compute_pid_internal** (HIGH)
**–§–∞–π–ª:** `pump_manager.c:91-135`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- PID –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `g_pid_configs[pump_idx]` –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
  - `deadband` –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è
  - `integral_max` –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è output_max)
  - `auto_reset_integral` –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
  - `use_derivative_filter` –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω

**–†–µ—à–µ–Ω–∏–µ:**
–ü–µ—Ä–µ–¥–∞—Ç—å `pump_idx` –≤ `compute_pid_internal` –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞

---

### 7. **–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏** (LOW - –Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞)

**–§–∞–π–ª—ã —Å warnings:**
- `pumps_manual_screen.c:31`: `g_selected_pump` unused
- `pumps_manual_screen.c:40`: `on_confirm_pump_start` unused
- `pid_graph_screen.c`: –º–Ω–æ–∂–µ—Å—Ç–≤–æ unused –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- `ph_ec_controller.c:60`: `run_pump_with_interface` unused
- `system_tasks.c:467,511`: unused functions

**–†–µ—à–µ–Ω–∏–µ:**
–£–¥–∞–ª–∏—Ç—å –∏–ª–∏ –ø–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ `__attribute__((unused))`

---

### 8. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ pump_manager_init** (MEDIUM)

**–§–∞–π–ª:** `pump_manager.c:245`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```c
if (g_initialized) {
    ESP_LOGW(TAG, "pump_manager —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
    return ESP_OK; // –ù–æ –º—å—é—Ç–µ–∫—Å—ã –∏ –∑–∞–¥–∞—á–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã!
}
```

–ï—Å–ª–∏ –≤—ã–∑–≤–∞—Ç—å –¥–≤–∞–∂–¥—ã, –º—å—é—Ç–µ–∫—Å—ã –∏ –∑–∞–¥–∞—á–∞ –ù–ï —É–¥–∞–ª—è—é—Ç—Å—è, –Ω–æ –Ω–æ–≤—ã–µ –ù–ï —Å–æ–∑–¥–∞—é—Ç—Å—è.

---

### 9. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç Division by Zero** (LOW)

**–§–∞–π–ª:** `pump_manager.c:442`

```c
uint32_t duration_ms = (uint32_t)((output.output / flow_rate) * 1000.0f);
```

–ï—Å–ª–∏ `flow_rate == 0`, –±—É–¥–µ—Ç –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ 0!

**–†–µ—à–µ–Ω–∏–µ:**
```c
if (flow_rate < 0.001f) flow_rate = 0.001f; // –∑–∞—â–∏—Ç–∞
```

---

### 10. **–ù–µ–ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è PID –ø–æ—Ä–æ–≥–æ–≤ activation/deactivation** (HIGH)

**–§–∞–π–ª:** `pump_manager.c:369-482`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `activation_threshold` –∏ `deactivation_threshold` –ù–ï –ò–°–ü–û–õ–¨–ó–£–Æ–¢–°–Ø –≤ `pump_manager_compute_and_execute`!
- PID —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ–≥–¥–∞, –∫–æ–≥–¥–∞ `error >= deadband`
- –ü–æ—Ä–æ–≥–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥–µ, –Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è –≤ –ª–æ–≥–∏–∫–µ

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Ä–æ–≥–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º PID

---

## üü° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

1. **–î–æ–±–∞–≤–∏—Ç—å cleanup —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö UI —ç–∫—Ä–∞–Ω–æ–≤**
2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å race condition —Å –º—å—é—Ç–µ–∫—Å–∞–º–∏**
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã PID –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞**
4. **–î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç division by zero**
5. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ—Ä–æ–≥–∏ activation/deactivation**
6. **–û—Å–≤–æ–±–æ–¥–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏**
7. **–£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**
8. **–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ failed mutex takes**

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º:** 2
- **–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** 4
- **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** 2
- **–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** 2

**–ò–¢–û–ì–û:** 10 –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º


