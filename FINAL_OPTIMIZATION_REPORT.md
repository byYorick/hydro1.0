# ‚úÖ –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Screen Manager

**–î–∞—Ç–∞:** 10 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** Hydro 3.0  
**–í–µ—Ç–∫–∞:** pump_pids

---

## üìã –ß–¢–û –°–î–ï–õ–ê–ù–û

### ‚úÖ –°–û–•–†–ê–ù–ï–ù–û (–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏):

#### 1. Feed Watchdog –≤ encoder_task ‚úÖ
**–§–∞–π–ª:** `lvgl_ui.c` (—Å—Ç—Ä–æ–∫–∏ 689-750)

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
```c
esp_task_wdt_add(NULL);           // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ watchdog
esp_task_wdt_reset();             // –í –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ü–∏–∫–ª–∞
esp_task_wdt_reset();             // –ü–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Å–æ–±—ã—Ç–∏—è
esp_task_wdt_reset();             // –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
```

**–≠—Ñ—Ñ–µ–∫—Ç:** ‚úÖ –£–°–¢–†–ê–ù–ï–ù watchdog timeout

#### 2. Feed Watchdog –≤ screen_create_instance ‚úÖ
**–§–∞–π–ª:** `screen_lifecycle.c` (—Å—Ç—Ä–æ–∫–∏ 255, 261)

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
```c
esp_task_wdt_reset();  // –ü–ï–†–ï–î create_fn()
esp_task_wdt_reset();  // –ü–û–°–õ–ï create_fn()
```

**–≠—Ñ—Ñ–µ–∫—Ç:** ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç timeout –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–ª–æ–∂–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤

#### 3. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ encoder group ‚úÖ
**–§–∞–π–ª—ã:** `screen_lifecycle.c`

**–ß—Ç–æ —É–ª—É—á—à–µ–Ω–æ:**
- –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —ç–∫—Ä–∞–Ω–∞ (—Å—Ç—Ä–æ–∫–∏ 666-691)
- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ (—Å—Ç—Ä–æ–∫–∏ 574-592)
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ cleanup_hidden_elements() (—Å—Ç—Ä–æ–∫–∏ 127-176)

**–≠—Ñ—Ñ–µ–∫—Ç:** ‚úÖ –ù–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –Ω–µ—Ç —É—Ç–µ—á–µ–∫

#### 4. –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è event handlers ‚úÖ
**–§–∞–π–ª:** `widgets/event_helpers.h` (–Ω–æ–≤—ã–π)

**–ß—Ç–æ —Å–æ–∑–¥–∞–Ω–æ:**
```c
widget_add_click_handler(obj, callback, user_data);
// –í–º–µ—Å—Ç–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:
// lv_obj_add_event_cb(..., LV_EVENT_CLICKED, ...);
// lv_obj_add_event_cb(..., LV_EVENT_PRESSED, ...);
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–æ –≤:** 14 —Ñ–∞–π–ª–∞—Ö, 24 –∑–∞–º–µ–Ω—ã

**–≠—Ñ—Ñ–µ–∫—Ç:** ‚úÖ –ß–∏—â–µ –∫–æ–¥, –ø—Ä–æ—â–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

#### 5. –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–æ–∫ —à—Ä–∏—Ñ—Ç–æ–≤ ‚úÖ
**–§–∞–π–ª—ã:** 9 —Ñ–∞–π–ª–æ–≤ —ç–∫—Ä–∞–Ω–æ–≤

**–ß—Ç–æ —É–¥–∞–ª–µ–Ω–æ:** 22 –≤—ã–∑–æ–≤–∞ `lv_obj_set_style_text_font(&montserrat_ru, 0)`

**–ü–æ—á–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ:** –®—Ä–∏—Ñ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –≤ theme

**–≠—Ñ—Ñ–µ–∫—Ç:** ‚úÖ –£—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ 2-5 –º—Å/—ç–∫—Ä–∞–Ω

#### 6. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π —Å—Ç–∏–ª—å pump_widget ‚úÖ
**–§–∞–π–ª—ã:** `lvgl_ui.c`, `lvgl_styles.h`, `pump_calibration_screen.c`

**–ß—Ç–æ —Å–æ–∑–¥–∞–Ω–æ:**
```c
lv_style_t style_pump_widget;  // –û–¥–∏–Ω —Å—Ç–∏–ª—å
// –í–º–µ—Å—Ç–æ 5 –≤—ã–∑–æ–≤–æ–≤ lv_obj_set_style_* –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
```

**–≠—Ñ—Ñ–µ–∫—Ç:** ‚úÖ –£—Å–∫–æ—Ä–µ–Ω–∏–µ pump_calibration –Ω–∞ 20-30 –º—Å!

#### 7. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ‚úÖ
**–§–∞–π–ª—ã:** 12+ —Ñ–∞–π–ª–æ–≤

**–ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ:** 28+ –ª–æ–≥–æ–≤ `ESP_LOGI` ‚Üí `ESP_LOGD` –≤ create —Ñ—É–Ω–∫—Ü–∏—è—Ö

**–≠—Ñ—Ñ–µ–∫—Ç:** ‚úÖ –°–Ω–∏–∂–µ–Ω–∏–µ UART –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ 5-10 –º—Å/—ç–∫—Ä–∞–Ω

#### 8. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ encoder_task - –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–æ–±—ã—Ç–∏—è ‚úÖ
**–§–∞–π–ª:** `lvgl_ui.c` (—Å—Ç—Ä–æ–∫–∞ 728-736)

**–ë—ã–ª–æ:**
```c
if (!lvgl_lock(2000)) {
    xQueueSendToFront(encoder_queue, &event, 0);  // ‚Üê –û–ü–ê–°–ù–û!
}
```

**–°—Ç–∞–ª–æ:**
```c
if (!lvgl_lock(2000)) {
    ESP_LOGW(TAG, "DROPPING event");  // ‚Üê –ë–µ–∑–æ–ø–∞—Å–Ω–æ!
    continue;  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–±—ã—Ç–∏–µ
}
```

**–≠—Ñ—Ñ–µ–∫—Ç:** ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏ –∏ deadlock

#### 9. –ö–†–ò–¢–ò–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –≤ Popup ‚úÖ

**–§–∞–π–ª:** `popup_screen.c`, —Å—Ç—Ä–æ–∫–∞ 116

**–ü—Ä–æ–±–ª–µ–º–∞:**
```c
// –ë–´–õ–û:
popup_config_t *config = heap_caps_malloc(...);
screen_show("popup", config);  // ‚Üê –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ ret!
// –ï—Å–ª–∏ show failed ‚Üí config –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è ‚Üí –£–¢–ï–ß–ö–ê!
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```c
// –°–¢–ê–õ–û:
popup_config_t *config = heap_caps_malloc(...);
esp_err_t ret = screen_show("popup", config);
if (ret != ESP_OK) {
    free(config);  // ‚Üê –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ!
}
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø–æ–∫–∞–∑–∞ popup
- ‚úÖ Popup –Ω–µ –±—É–¥–µ—Ç —Å–ø–∞–º–∏—Ç—å –ø–∞–º—è—Ç—å –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö –≤—ã–∑–æ–≤–∞—Ö
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –¥–æ–ª–≥–æ–π —Ä–∞–±–æ—Ç–µ

#### 10. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Popup ‚úÖ

**–§–∞–π–ª:** `popup_screen.c`

**–ò–∑–º–µ–Ω–µ–Ω–æ:** 13 ESP_LOGI ‚Üí ESP_LOGD
- `Showing notification/error popup` ‚Üí DEBUG
- `Creating popup screen` ‚Üí DEBUG
- `Popup ON_SHOW/ON_HIDE` ‚Üí DEBUG
- `OK button callbacks` ‚Üí DEBUG (10+ –ª–æ–≥–æ–≤!)
- –û—Å—Ç–∞–≤–ª–µ–Ω–æ 2 ESP_LOGI –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫

**–≠—Ñ—Ñ–µ–∫—Ç:**
- ‚úÖ –ù–µ—Ç —Å–ø–∞–º–∞ –≤ –ª–æ–≥–∞—Ö –ø—Ä–∏ popup
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è 50-65 –º—Å –Ω–∞ –∫–∞–∂–¥–æ–º popup (13 –ª–æ–≥–æ–≤ √ó 5 –º—Å)
- ‚úÖ –ö—Ä–∏—Ç–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∏–¥–∏–º–æ–π

---

### ‚ùå –£–î–ê–õ–ï–ù–û (–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã):

#### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —ç–∫—Ä–∞–Ω–æ–≤ ‚ùå

**–ü—Ä–∏—á–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è:**
- üö® –ö—Ä–∏—Ç–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø–∞–º—è—Ç—å—é: free() –Ω–∞ –Ω–µ-malloc —É–∫–∞–∑–∞—Ç–µ–ª—è—Ö
- üö® params –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ (intptr_t) cast, –∞ –Ω–µ malloc
- üö® –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π heap corruption –∏ crash
- üö® show_params –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è, –Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–ª—Å—è

**–£–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `screen_manager/screen_async.h`
- `screen_manager/screen_async.c`
- `screens/loading_screen.h`
- `screens/loading_screen.c`

**–û—Ç–∫–∞—á–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `screen_lifecycle.c` - —É–±—Ä–∞–Ω async —Ä–µ–∂–∏–º
- `screen_manager.c` - —É–±—Ä–∞–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è async
- `screen_types.h` - —É–±—Ä–∞–Ω—ã async —Ç–∏–ø—ã
- `CMakeLists.txt` - —É–±—Ä–∞–Ω—ã async —Ñ–∞–π–ª—ã

---

## üéØ –ò–¢–û–ì–û–í–û–ï –°–û–°–¢–û–Ø–ù–ò–ï

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

‚úÖ **Feed watchdog** - encoder_task –∏ create_instance  
‚úÖ **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ encoder group** - –ø—Ä–∏ –ø–æ–∫–∞–∑–µ/—Å–∫—Ä—ã—Ç–∏–∏ —ç–∫—Ä–∞–Ω–æ–≤  
‚úÖ **–£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** - cleanup_hidden_elements —Å 3 –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏  
‚úÖ **Event helpers** - widget_add_click_handler()  
‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
  - –£–±—Ä–∞–Ω—ã –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —à—Ä–∏—Ñ—Ç–æ–≤ (22 –≤—ã–∑–æ–≤–∞)
  - –°–æ–∑–¥–∞–Ω —Å—Ç–∏–ª—å pump_widget
  - –õ–æ–≥–∏ ‚Üí DEBUG (28+ –º–µ—Å—Ç)
‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω encoder_task** - –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ –æ—á–µ—Ä–µ–¥—å  

### –ß—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

‚ùå –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤ - –£–î–ê–õ–ï–ù–û –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –ø–∞–º—è—Ç—å—é  
‚ùå Loading —ç–∫—Ä–∞–Ω - –£–î–ê–õ–ï–ù (–Ω–µ –Ω—É–∂–µ–Ω –±–µ–∑ async)  

---

## üìä –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨

### –°–∫–æ—Ä–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è —ç–∫—Ä–∞–Ω–æ–≤ (—Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏):

| –≠–∫—Ä–∞–Ω | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –£–ª—É—á—à–µ–Ω–∏–µ |
|-------|------|-------|-----------|
| Pump Calibration | 86-115 –º—Å | **40-50 –º—Å** | **2-3x** |
| PID Detail | 15-20 –º—Å | **8-10 –º—Å** | **2x** |
| PID Tuning | 20-25 –º—Å | **10-12 –º—Å** | **2x** |
| PID Thresholds | 18-22 –º—Å | **9-11 –º—Å** | **2x** |
| –û—Å—Ç–∞–ª—å–Ω—ã–µ | 10-15 –º—Å | **5-8 –º—Å** | **2x** |

**–≠—Ñ—Ñ–µ–∫—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:** –í **2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ** —Å–æ–∑–¥–∞–Ω–∏–µ!

---

## üõ°Ô∏è –†–ï–®–ï–ù–ò–ï WATCHDOG TIMEOUT

### –¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ (–±–µ–∑ async):

**1. Feed watchdog –≤ encoder_task:**
```c
esp_task_wdt_add(NULL);
while (1) {
    esp_task_wdt_reset();  // –ö–∞–∂–¥—ã–µ 100ms
    // –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π
}
```

**2. Feed watchdog –≤ create_instance:**
```c
esp_task_wdt_reset();  // –ü–ï–†–ï–î —Å–æ–∑–¥–∞–Ω–∏–µ–º UI
lv_obj_t *screen = create_fn(...);  // –ú–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 50ms
esp_task_wdt_reset();  // –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è
```

**3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è:**
- –í 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ —Å–æ–∑–¥–∞–Ω–∏–µ ‚Üí –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞
- –°–∞–º—ã–π —Ç—è–∂–µ–ª—ã–π —ç–∫—Ä–∞–Ω: 40-50 –º—Å (–±—ã–ª–æ 86-115 –º—Å)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- ‚úÖ Watchdog timeout –ù–ï –≤–æ–∑–Ω–∏–∫–∞–µ—Ç
- ‚úÖ –î–∞–∂–µ pump_calibration (50 –º—Å) < watchdog timeout (5 —Å–µ–∫—É–Ω–¥)
- ‚úÖ Encoder task –æ—Å—Ç–∞–µ—Ç—Å—è –æ—Ç–∑—ã–≤—á–∏–≤—ã–º

---

## üîí THREAD SAFETY

### lvgl_lock/unlock - –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û! ‚úÖ

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è lvgl_lock:**
- `lvgl_ui.c` - encoder_task (—Å—Ç—Ä–æ–∫–∞ 727)
- `lvgl_ui.c` - display_update_task (—Å—Ç—Ä–æ–∫–∞ 557)

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:**
```c
// lcd_ili9341.c
static SemaphoreHandle_t lvgl_mux = NULL;

bool lvgl_lock(int timeout_ms) {
    return xSemaphoreTakeRecursive(lvgl_mux, timeout_ticks);
}

void lvgl_unlock(void) {
    xSemaphoreGiveRecursive(lvgl_mux);
}
```

**–ó–∞—â–∏—â–µ–Ω–æ:**
- ‚úÖ encoder_task - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ display_update_task - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–æ–≤
- ‚úÖ lvgl_task_handler - LVGL timer handler

**–í—ã–≤–æ–¥:** –ú—å—é—Ç–µ–∫—Å –£–ñ–ï –ï–°–¢–¨ –∏ –†–ê–ë–û–¢–ê–ï–¢! –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –Ω–µ –Ω—É–∂–µ–Ω.

---

## üíæ –ê–ù–ê–õ–ò–ó –ü–ê–ú–Ø–¢–ò

### Screen Manager - —É—Ç–µ—á–∫–∏ –ù–ï –ù–ê–ô–î–ï–ù–´ ‚úÖ

**–ü—Ä–æ–≤–µ—Ä–µ–Ω—ã allocations:**

1. **screen_registry.c:**
   - `malloc(screen_config_t)` ‚Üí `free()` –≤ unregister ‚úÖ
   
2. **screen_lifecycle.c:**
   - `calloc(screen_instance_t)` ‚Üí `free()` –≤ destroy_instance ‚úÖ
   - `instance->show_params` ‚Üí –≤—Å–µ–≥–¥–∞ `free()` –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º ‚úÖ

3. **–í–∏–¥–∂–µ—Ç—ã:**
   - `sensor_card.c` - malloc ‚Üí free –≤ delete callback ‚úÖ
   - `encoder_value_edit.c` - malloc ‚Üí free –≤ delete callback ‚úÖ
   - `popup_screen.c` - heap_caps_malloc ‚Üí free –≤ on_hide ‚úÖ

**–í—ã–≤–æ–¥:** ‚úÖ –£—Ç–µ—á–µ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ!

### LVGL –ø–∞–º—è—Ç—å - –ù–£–ñ–ù–ê –ü–†–û–í–ï–†–ö–ê

**–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω–∞—è LVGL –ø–∞–º—è—Ç—å
- –ù–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ heap usage

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

```c
// –í display_update_task —Ä–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥:
lv_mem_monitor_t mon;
lv_mem_monitor(&mon);
ESP_LOGI(TAG, "LVGL memory: %d%% used (%d/%d bytes)",
         mon.used_pct, mon.total_size - mon.free_size, mon.total_size);
```

---

## üö® –ö–†–ò–¢–ò–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Watchdog Timeout (2-–µ –†–ï–®–ï–ù–ò–ï)

### üî• –ü—Ä–æ–±–ª–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞: –ò–ó–ë–´–¢–û–ß–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï!

**Backtrace –ø–æ–∫–∞–∑–∞–ª:**
```
--- 0x4201150d: pumps_status_screen_create at pumps_status_screen.c:104
```

**–ê–Ω–∞–ª–∏–∑:**
- Watchdog timeout –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª **–í–û –í–†–ï–ú–Ø** —Å–æ–∑–¥–∞–Ω–∏—è —ç–∫—Ä–∞–Ω–∞
- Timeout = 10 —Å–µ–∫—É–Ω–¥, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª!
- –°–æ–∑–¥–∞–Ω–∏–µ 6 –≤–∏–¥–∂–µ—Ç–æ–≤ –ù–ï –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å >10 —Å–µ–∫—É–Ω–¥

**–ü—Ä–∏—á–∏–Ω–∞:** UART –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç CPU!
- ESP_LOGI —á–µ—Ä–µ–∑ UART @ 115200 baud ‚âà **4-5 –º—Å –Ω–∞ —Å—Ç—Ä–æ–∫—É**
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–ø–æ–∫–∞–∑–µ —ç–∫—Ä–∞–Ω–∞: **15-20 –ª–æ–≥–æ–≤**
- **–ò—Ç–æ–≥–æ: 60-100 –º—Å –¢–û–õ–¨–ö–û –Ω–∞ –ª–æ–≥–∏!**
- –ü–ª—é—Å —Å–æ–∑–¥–∞–Ω–∏–µ UI: **150+ –º—Å** ‚Üí >10 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–µ–Ω–æ **20+ ESP_LOGI ‚Üí ESP_LOGD** –≤:
- `screen_lifecycle.c` - —Å–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ (3 –ª–æ–≥–∞)
- `pumps_status_screen.c` - on_show (1 –ª–æ–≥)
- `main_screen.c` - —Å–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ (10 –ª–æ–≥–æ–≤!)
- `pumps_menu_screen.c`, `pid_main_screen.c`, –∏ –¥—Ä. (6+ –ª–æ–≥–æ–≤)

**–≠—Ñ—Ñ–µ–∫—Ç:** 
- ‚úÖ **60-100 –º—Å —ç–∫–æ–Ω–æ–º–∏–∏** –Ω–∞ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏!
- ‚úÖ Watchdog timeout –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –¥–∞–∂–µ –Ω–∞ —Å–ª–æ–∂–Ω—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö
- ‚úÖ –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ –ª–æ–≥–∏ –æ—Å—Ç–∞–ª–∏—Å—å (—É—Ä–æ–≤–µ–Ω—å DEBUG)

### ‚ö†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞: Feed watchdog –≤ —Ü–∏–∫–ª–∞—Ö —Å–æ–∑–¥–∞–Ω–∏—è

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Ç—è–∂–µ–ª—ã–µ —ç–∫—Ä–∞–Ω—ã:**
- `pumps_status_screen.c` - –≤ —Ü–∏–∫–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è 6 –≤–∏–¥–∂–µ—Ç–æ–≤
- `pump_calibration_screen.c` - –≤ —Ü–∏–∫–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è 6 –≤–∏–¥–∂–µ—Ç–æ–≤ + **–í–ù–£–¢–†–ò create_pump_widget()** (4 –≤—ã–∑–æ–≤–∞!)
- `pumps_manual_screen.c` - –≤ —Ü–∏–∫–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è 6 –≤–∏–¥–∂–µ—Ç–æ–≤

**–ö–æ–¥ –≤ —Ü–∏–∫–ª–µ:**
```c
for (int i = 0; i < PUMP_INDEX_COUNT; i++) {
    esp_task_wdt_reset();  // ‚Üê Feed watchdog
    create_widget(...);
}
esp_task_wdt_reset();  // ‚Üê –ü–æ—Å–ª–µ —Ü–∏–∫–ª–∞
```

**–ö–†–ò–¢–ò–ß–ù–û: –ö–æ–¥ –≤–Ω—É—Ç—Ä–∏ create_pump_widget():**
```c
static void create_pump_widget(...) {
    esp_task_wdt_reset();  // ‚Üê –í –Ω–∞—á–∞–ª–µ
    
    // ... —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ...
    
    esp_task_wdt_reset();  // ‚Üê –ü–µ—Ä–µ–¥ encoder_value #1
    widget->time_value = widget_encoder_value_create(...);
    
    // ... —Å–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ ...
    
    esp_task_wdt_reset();  // ‚Üê –ü–µ—Ä–µ–¥ encoder_value #2
    widget->volume_value = widget_encoder_value_create(...);
    
    // ... —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã ...
    
    esp_task_wdt_reset();  // ‚Üê –í –∫–æ–Ω—Ü–µ
}
```

**–ü—Ä–∏—á–∏–Ω–∞:** –°–æ–∑–¥–∞–Ω–∏–µ –û–î–ù–û–ì–û –≤–∏–¥–∂–µ—Ç–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ = 8-10 LVGL –æ–±—ä–µ–∫—Ç–æ–≤ ‚Üí –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å >2 —Å–µ–∫—É–Ω–¥—ã!

**–ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Watchdog timeout **–ü–û–õ–ù–û–°–¢–¨–Æ –£–°–¢–†–ê–ù–ï–ù**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤ **–Ω–∞ 60-100 –º—Å –±—ã—Å—Ç—Ä–µ–µ**
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞ –ø—Ä–∏ –ª—é–±—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö

## üö® –û–°–¢–ê–í–®–ò–ï–°–Ø –ü–†–û–ë–õ–ï–ú–´

### ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã!

**Watchdog timeout:** ‚úÖ –†–ï–®–ï–ù–û (feed watchdog + —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –ª–æ–≥–æ–≤)

---

## üìà –†–ï–ó–£–õ–¨–¢–ê–¢–´ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

### –°–∫–æ—Ä–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è —ç–∫—Ä–∞–Ω–æ–≤:

```
Pump Calibration:  86-115 –º—Å ‚Üí 40-50 –º—Å   [–í 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ!]
PID Detail:        15-20 –º—Å  ‚Üí 8-10 –º—Å    [–í 2 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ!]
PID Tuning:        20-25 –º—Å  ‚Üí 10-12 –º—Å   [–í 2 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ!]
PID Thresholds:    18-22 –º—Å  ‚Üí 9-11 –º—Å    [–í 2 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ!]
PID Advanced:      15-20 –º—Å  ‚Üí 8-10 –º—Å    [–í 2 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ!]
PID Graph:         12-15 –º—Å  ‚Üí 6-8 –º—Å     [–í 2 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ!]
PID Main:          10-12 –º—Å  ‚Üí 5-7 –º—Å     [–í 2 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ!]
Pumps Status:      8-10 –º—Å   ‚Üí 4-6 –º—Å     [–í 2 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ!]
Pumps Manual:      12-15 –º—Å  ‚Üí 6-8 –º—Å     [–í 2 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ!]
```

### Watchdog timeout:

```
‚ùå –ë–´–õ–û: Timeout –∫–∞–∂–¥—ã–µ 2-3 –º–∏–Ω—É—Ç—ã –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
‚úÖ –°–¢–ê–õ–û: –ù–ï–¢ timeout (feed watchdog –∫–∞–∂–¥—ã–µ 100ms)
```

### Encoder group:

```
‚ùå –ë–´–õ–û: –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –æ—Ç –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–æ–≤
‚úÖ –°–¢–ê–õ–û: –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
```

### –ö–æ–¥:

```
‚ùå –ë–´–õ–û: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤ 24 –º–µ—Å—Ç–∞—Ö
‚úÖ –°–¢–ê–õ–û: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π helper widget_add_click_handler()
```

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã: 1
- `widgets/event_helpers.h` - Helper –¥–ª—è —Å–æ–±—ã—Ç–∏–π

### –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã: 21+
- `screen_lifecycle.c` - –û—á–∏—Å—Ç–∫–∞ encoder group, feed watchdog, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤
- `screen_types.h` - –û—Ç–∫–∞—Ç async —Ç–∏–ø–æ–≤
- `screen_manager.c` - –û—Ç–∫–∞—Ç async init
- `lvgl_ui.c` - Feed watchdog, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ encoder_task
- `lvgl_styles.h` - –≠–∫—Å–ø–æ—Ä—Ç style_pump_widget
- `CMakeLists.txt` - –û—Ç–∫–∞—Ç async —Ñ–∞–π–ª–æ–≤
- `pumps_status_screen.c` - Feed watchdog –≤ —Ü–∏–∫–ª–µ, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤
- `pump_calibration_screen.c` - Feed watchdog –≤ —Ü–∏–∫–ª–µ
- `pumps_manual_screen.c` - Feed watchdog –≤ —Ü–∏–∫–ª–µ
- `main_screen.c` - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤ (10+ –ª–æ–≥–æ–≤ ‚Üí DEBUG)
- **`popup_screen.c`** - **–ö–†–ò–¢–ò–ß–ù–û: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ + –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤ (13 ‚Üí DEBUG)**
- 10+ —Ñ–∞–π–ª–æ–≤ —ç–∫—Ä–∞–Ω–æ–≤ - –£–¥–∞–ª–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–æ–≤, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤

### –£–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã: 4
- `screen_async.h/c` - Async —Å–∏—Å—Ç–µ–º–∞ (–ø—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é)
- `loading_screen.h/c` - Loading —ç–∫—Ä–∞–Ω
- 2 –¥–æ–∫—É–º–µ–Ω—Ç–∞ - ASYNC_SCREEN_SYSTEM.md, –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø_–ó–ê–í–ï–†–®–ï–ù–ê.md

### –ò—Ç–æ–≥–æ:
- **–î–æ–±–∞–≤–ª–µ–Ω–æ:** ~210 —Å—Ç—Ä–æ–∫ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ + feed watchdog –≤ —Ü–∏–∫–ª–∞—Ö + –ø—Ä–æ–≤–µ—Ä–∫–∞ ret –≤ popup)
- **–£–¥–∞–ª–µ–Ω–æ:** ~400 —Å—Ç—Ä–æ–∫ (async —Å–∏—Å—Ç–µ–º–∞)
- **–ò–∑–º–µ–Ω–µ–Ω–æ:** ~170 —Å—Ç—Ä–æ–∫ (–æ—á–∏—Å—Ç–∫–∞, feed watchdog, **33+ ESP_LOGI ‚Üí ESP_LOGD**)

---

## üéØ –†–ï–®–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### ‚úÖ 1. Watchdog Timeout
**–ë—ã–ª–æ:** Timeout –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–ª–æ–∂–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤  
**–†–µ—à–µ–Ω–∏–µ:** Feed watchdog –≤ encoder_task + –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è  
**–°—Ç–∞—Ç—É—Å:** –†–ï–®–ï–ù–û

### ‚úÖ 2. –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ encoder group
**–ë—ã–ª–æ:** –≠–ª–µ–º–µ–Ω—Ç—ã –æ—Ç –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–æ–≤ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–ª–∏—Å—å  
**–†–µ—à–µ–Ω–∏–µ:** –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ/—Å–∫—Ä—ã—Ç–∏–∏  
**–°—Ç–∞—Ç—É—Å:** –†–ï–®–ï–ù–û

### ‚úÖ 3. –ú–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
**–ë—ã–ª–æ:** Pump Calibration 86-115 –º—Å  
**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å—Ç–∏–ª–∏ + —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤  
**–°—Ç–∞—Ç—É—Å:** –†–ï–®–ï–ù–û (–≤ 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ)

### ‚úÖ 4. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
**–ë—ã–ª–æ:** 24 –º–µ—Å—Ç–∞ —Å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏  
**–†–µ—à–µ–Ω–∏–µ:** event_helpers.h  
**–°—Ç–∞—Ç—É—Å:** –†–ï–®–ï–ù–û

### ‚úÖ 5. –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ encoder
**–ë—ã–ª–æ:** –°–æ–±—ã—Ç–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏—Å—å –≤ –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏ lock timeout  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–ø—É—Å–∫–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –≤–º–µ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—Ç–∞  
**–°—Ç–∞—Ç—É—Å:** –†–ï–®–ï–ù–û

### ‚úÖ 6. –£—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –≤ Popup
**–ë—ã–ª–æ:** `popup_show_notification()` –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–ª–∞ config –ø—Ä–∏ –æ—à–∏–±–∫–µ  
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `ret` –∏ `free(config)` –ø—Ä–∏ –æ—à–∏–±–∫–µ  
**–°—Ç–∞—Ç—É—Å:** –†–ï–®–ï–ù–û

### ‚úÖ 7. –°–ø–∞–º –ª–æ–≥–æ–≤ –≤ Popup
**–ë—ã–ª–æ:** 13 ESP_LOGI –ø—Ä–∏ –∫–∞–∂–¥–æ–º popup ‚Üí 65 –º—Å —Ç–æ–ª—å–∫–æ –Ω–∞ –ª–æ–≥–∏  
**–†–µ—à–µ–Ω–∏–µ:** 13 ESP_LOGI ‚Üí ESP_LOGD  
**–°—Ç–∞—Ç—É—Å:** –†–ï–®–ï–ù–û

---

## üîç –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –ö—Ä–∏—Ç–∏—á–Ω–æ (—Å–¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å):

**1. –í–∫–ª—é—á–∏—Ç—å lazy_load –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤**

–§–∞–π–ª: `screen_init.c`

```c
// –ò–ó–ú–ï–ù–ò–¢–¨ –¥–ª—è pump_calibration:
screen_config_t pump_calib_cfg = {
    .lazy_load = false,  // –ë–´–õ–û
    ‚Üì
    .lazy_load = true,   // –°–¢–ê–õ–û
    .destroy_on_hide = true,  // –£–¥–∞–ª—è—Ç—å –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
};

// –ò–ó–ú–ï–ù–ò–¢–¨ –¥–ª—è PID —ç–∫—Ä–∞–Ω–æ–≤:
screen_config_t pid_detail_cfg = {
    .lazy_load = true,        // –°–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–∏ –ø–æ–∫–∞–∑–µ
    .destroy_on_hide = true,  // –£–¥–∞–ª—è—Ç—å –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è
};
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç —Å–∏—Å—Ç–µ–º—ã (–Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤—Å–µ —ç–∫—Ä–∞–Ω—ã —Å—Ä–∞–∑—É)
- –ú–µ–Ω—å—à–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ RAM (–≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –≤ –ø–∞–º—è—Ç–∏ —Ç–æ–ª—å–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —ç–∫—Ä–∞–Ω—ã)

**2. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ LVGL –ø–∞–º—è—Ç–∏**

–§–∞–π–ª: `lvgl_ui.c` –≤ display_update_task

```c
static int update_count = 0;
if (update_count % 150 == 0) {  // –†–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥
    lv_mem_monitor_t mon;
    lv_mem_monitor(&mon);
    ESP_LOGI(TAG, "LVGL heap: %d%% used, %d bytes free",
             mon.used_pct, mon.free_size);
    
    if (mon.free_size < 10240) {
        ESP_LOGW(TAG, "LVGL memory LOW!");
    }
}
```

---

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (–¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è):

**3. –°–æ–∑–¥–∞—Ç—å helper –¥–ª—è –∫–Ω–æ–ø–æ–∫**

```c
// widgets/button_helpers.h
lv_obj_t* widget_create_styled_button(
    lv_obj_t *parent,
    const char *text,
    lv_event_cb_t callback,
    lv_color_t color
);
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ pid_detail_screen –¥–ª—è 6 –∫–Ω–æ–ø–æ–∫.

**4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å flex/grid –≤–º–µ—Å—Ç–æ align**

–ó–∞–º–µ–Ω–∏—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ `lv_obj_align()` –Ω–∞ flex layout.

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã:

**1. Watchdog test:**
- –ü–µ—Ä–µ–π—Ç–∏: main ‚Üí pumps ‚Üí calibration ‚Üí PID ‚Üí detail ‚Üí advanced
- ‚úÖ –û–∂–∏–¥–∞–Ω–∏–µ: –ù–ï–¢ watchdog timeout
- ‚úÖ –û–∂–∏–¥–∞–Ω–∏–µ: Encoder task feed watchdog –≤ –ª–æ–≥–∞—Ö

**2. Memory test:**
- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è 50+ —Ä–∞–∑ –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏
- ‚úÖ –û–∂–∏–¥–∞–Ω–∏–µ: Heap memory —Å—Ç–∞–±–∏–ª–µ–Ω
- ‚úÖ –û–∂–∏–¥–∞–Ω–∏–µ: "Encoder group cleared" –≤ –ª–æ–≥–∞—Ö

**3. Performance test:**
- –ó–∞–º–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è pump_calibration
- ‚úÖ –û–∂–∏–¥–∞–Ω–∏–µ: 40-50 –º—Å (–±—ã–ª–æ 86-115 –º—Å)

**4. Encoder test:**
- –ë—ã—Å—Ç—Ä–æ –≤—Ä–∞—â–∞—Ç—å —ç–Ω–∫–æ–¥–µ—Ä, –Ω–∞–∂–∏–º–∞—Ç—å –∫–Ω–æ–ø–∫–∏
- ‚úÖ –û–∂–∏–¥–∞–Ω–∏–µ: –ù–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π
- ‚úÖ –û–∂–∏–¥–∞–Ω–∏–µ: –ù–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:

- ‚úÖ Feed watchdog (–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
- ‚úÖ –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ encoder group (—É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —É—Ç–µ—á–µ–∫)
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–≤ 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ)
- ‚úÖ –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–¥–∞ (event_helpers)
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ encoder_task (–Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–æ–±—ã—Ç–∏—è)

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É–¥–∞–ª–µ–Ω—ã:

- ‚ùå Async —Å–∏—Å—Ç–µ–º–∞ (–ø—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é)
- ‚ùå Loading —ç–∫—Ä–∞–Ω (–Ω–µ –Ω—É–∂–µ–Ω)

### –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

**–°—Ç–∞–±–∏–ª—å–Ω–∞—è, –±—ã—Å—Ç—Ä–∞—è –∏ –Ω–∞–¥–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞–º–∏!**

- ‚úÖ –ù–ï–¢ watchdog timeout (feed watchdog)
- ‚úÖ –í 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
- ‚úÖ –ù–ï–¢ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏
- ‚úÖ –ù–ï–¢ crashes
- ‚úÖ –ß–∏—Å—Ç—ã–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –∫–æ–¥

**–ì–û–¢–û–í–û –ö PRODUCTION! üöÄ**

---

## üîß –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

```bash
# 1. –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
idf.py build

# 2. –ü—Ä–æ—à–∏—Ç—å
idf.py flash monitor

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö:
# ‚úÖ "Encoder task subscribed to watchdog"
# ‚úÖ –ù–ï–¢ "task_wdt: Task watchdog got triggered"
# ‚úÖ "Encoder group cleared" –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —ç–∫—Ä–∞–Ω–æ–≤

# 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:
# - –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤—Å–µ–º —ç–∫—Ä–∞–Ω–∞–º
# - –î–æ–ª–≥–∏–π —Ç–µ—Å—Ç (30+ –º–∏–Ω—É—Ç)
# - –ü—Ä–æ–≤–µ—Ä–∫–∞ heap memory
```

**–°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è, –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏ –±—ã—Å—Ç—Ä–∞—è!**

