# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ IoT —Å–∏—Å—Ç–µ–º—ã –≥–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∏

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `main/iot_config.h`:

```c
// MQTT Broker (–ª–æ–∫–∞–ª—å–Ω—ã–π Mosquitto)
#define MQTT_BROKER_URI "mqtt://192.168.1.100:1883"
#define MQTT_CLIENT_ID "hydro_gateway_001"

// Telegram Bot
#define TELEGRAM_BOT_TOKEN "123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11"
#define TELEGRAM_CHAT_ID "123456789"

// WiFi
#define WIFI_SSID "YourWiFiName"
#define WIFI_PASSWORD "YourWiFiPassword"

// –í–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
#define IOT_MQTT_ENABLED true
#define IOT_TELEGRAM_ENABLED true
#define IOT_SD_ENABLED true  // –ï—Å–ª–∏ –µ—Å—Ç—å SD-–∫–∞—Ä—Ç–∞
#define IOT_MESH_ENABLED false  // –¢–æ–ª—å–∫–æ –¥–ª—è slave —É–∑–ª–æ–≤
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ MQTT –±—Ä–æ–∫–µ—Ä–∞ (Mosquitto)

–ù–∞ Raspberry Pi –∏–ª–∏ –¥–æ–º–∞—à–Ω–µ–º —Å–µ—Ä–≤–µ—Ä–µ:

```bash
# Ubuntu/Debian/Raspberry Pi OS
sudo apt-get update
sudo apt-get install mosquitto mosquitto-clients

# –ó–∞–ø—É—Å–∫
sudo systemctl start mosquitto
sudo systemctl enable mosquitto

# –ü—Ä–æ–≤–µ—Ä–∫–∞
mosquitto_sub -h localhost -t "hydro/#" -v
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ Telegram Bot

1. –ù–∞–π–¥–∏—Ç–µ @BotFather –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/newbot`
3. –ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏–º—è: `HydroMonitor Bot`
4. –ü—Ä–∏–¥—É–º–∞–π—Ç–µ username: `hydro_monitor_bot`
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ `TELEGRAM_BOT_TOKEN`

–ü–æ–ª—É—á–µ–Ω–∏–µ Chat ID:
```bash
# –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–∞—à–µ–º—É –±–æ—Ç—É –≤ Telegram
# –ó–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
curl https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates
# –ù–∞–π–¥–∏—Ç–µ "chat":{"id":123456789} –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ ID
```

## –ú–æ–¥—É–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã

### –¢–µ—Å—Ç 1: MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1: –ó–∞–ø—É—Å—Ç–∏—Ç–µ subscriber
mosquitto_sub -h 192.168.1.100 -t "hydro/hydro_gateway_001/#" -v

# –¢–µ—Ä–º–∏–Ω–∞–ª 2: –ü—Ä–æ—à–µ–π—Ç–µ ESP32
idf.py build flash monitor

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# hydro/hydro_gateway_001/status {"timestamp":1234567890,"status":"online","device_id":"hydro_gateway_001"}
# hydro/hydro_gateway_001/sensors/ph {"timestamp":1234567890,"value":6.8,"unit":"pH","status":"ok"}
```

### –¢–µ—Å—Ç 2: Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ ESP32 –≤—ã –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å –≤ Telegram:
```
üöÄ –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞

–ì–∏–¥—Ä–æ–ø–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ
```

–í 20:00 –µ–∂–µ–¥–Ω–µ–≤–Ω–æ:
```
üìä –î–Ω–µ–≤–Ω–æ–π –æ—Ç—á–µ—Ç

–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç: 5 —á–∞—Å–æ–≤
–í—Å–µ –¥–∞—Ç—á–∏–∫–∏ –≤ –Ω–æ—Ä–º–µ
–ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
```

### –¢–µ—Å—Ç 3: SD-–∫–∞—Ä—Ç–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ–¥–∫–ª—é—á–∏—Ç–µ SD-–∫–∞—Ä—Ç—É –∫ ESP32:
- MOSI ‚Üí GPIO 23
- MISO ‚Üí GPIO 19
- SCK ‚Üí GPIO 18
- CS ‚Üí GPIO 5

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –Ω–∞ SD:
```
/sdcard/
  /data/
    /sensors/
      all_20251009.csv
    /events/
      alarms_20251009.log
    /config/
```

### –¢–µ—Å—Ç 4: AI –∫–æ—Ä—Ä–µ–∫—Ü–∏—è

–í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç:
```
I (305000) SYS_TASKS: AI –∫–æ—Ä—Ä–µ–∫—Ü–∏—è: pH UP 5.2 –º–ª
I (305005) SYS_TASKS: AI –∫–æ—Ä—Ä–µ–∫—Ü–∏—è: EC A=3.1 B=3.1 C=1.5 –º–ª
```

### –¢–µ—Å—Ç 5: Mesh-—Å–µ—Ç—å (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ slave —É–∑–ª–∞)

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤—Ç–æ—Ä–æ–π ESP32 –∫–∞–∫ slave:
```c
#define MESH_ROLE MESH_ROLE_SLAVE
#define MESH_DEVICE_ID 2
#define IOT_MESH_ENABLED true
#define IOT_MQTT_ENABLED false
```

–í –ª–æ–≥–∞—Ö gateway –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
```
I (30000) MESH_NETWORK: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ 2, —Ç–∏–ø 0
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

### –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –î–∞—Ç—á–∏–∫ ‚Üí AI ‚Üí –ö–æ—Ä—Ä–µ–∫—Ü–∏—è ‚Üí MQTT ‚Üí Telegram

1. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ pH**:
   - –ò–∑–º–µ–Ω–∏—Ç–µ pH —Ä–∞—Å—Ç–≤–æ—Ä–∞ (–¥–æ–±–∞–≤—å—Ç–µ –∫–∏—Å–ª–æ—Ç—É/—â–µ–ª–æ—á—å)
   - –ù–∞–±–ª—é–¥–∞–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö

2. **AI —Ä–µ–∞–∫—Ü–∏—è**:
   - –ß–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç AI –¥–æ–ª–∂–µ–Ω –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
   - –í –ª–æ–≥–∞—Ö: `AI –∫–æ—Ä—Ä–µ–∫—Ü–∏—è: pH DOWN 8.5 –º–ª`

3. **MQTT –ø—É–±–ª–∏–∫–∞—Ü–∏—è**:
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ MQTT Explorer: —Ç–æ–ø–∏–∫ `hydro/hydro_gateway_001/sensors/ph`
   - –ó–Ω–∞—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥

4. **Telegram –∞–ª–∞—Ä–º**:
   - –ï—Å–ª–∏ pH –≤—ã–π–¥–µ—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã (< 5.5 –∏–ª–∏ > 7.5)
   - –í—ã –ø–æ–ª—É—á–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: `üî¥ –ö–†–ò–¢–ò–ß–ù–û: ph_critical - pH –≤—ã—à–µ–ª –∑–∞ –ø—Ä–µ–¥–µ–ª—ã!`

5. **SD –ª–æ–≥**:
   - –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–∞ –≤ `all_20251009.csv`
   - –§–æ—Ä–º–∞—Ç: `timestamp,ph,ec,temperature,humidity,lux,co2`

### Offline-—Ä–µ–∂–∏–º —Ç–µ—Å—Ç

1. –û—Ç–∫–ª—é—á–∏—Ç–µ WiFi —Ä–æ—É—Ç–µ—Ä
2. ESP32 –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç—É
3. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ SD-–∫–∞—Ä—Ç—É
4. –ü—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ WiFi - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### Heap Memory

```
I (60000) app_main: System running. Free heap: 234567 / 512000 bytes
```

–ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ: ~200KB —Å–≤–æ–±–æ–¥–Ω–æ–π –ø–∞–º—è—Ç–∏ –∏–∑ 512KB

### CPU Usage

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É `tasks` –≤ –º–æ–Ω–∏—Ç–æ—Ä–µ:
```
idf.py monitor
# –í –∫–æ–Ω—Å–æ–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+] –∑–∞—Ç–µ–º –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É
```

–û–∂–∏–¥–∞–µ–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞:
- sensor_task: ~5%
- mqtt_publish: ~2%
- ai_correct: ~3%
- –û—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏: <1%

## –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º

### MQTT –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

```
E (5000) MQTT_CLIENT: –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±—Ä–æ–∫–µ—Ä—É
```

–†–µ—à–µ–Ω–∏–µ:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ IP –±—Ä–æ–∫–µ—Ä–∞: `ping 192.168.1.100`
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Mosquitto –∑–∞–ø—É—â–µ–Ω: `sudo systemctl status mosquitto`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ WiFi –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ESP32

### Telegram –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

```
E (10000) TELEGRAM_BOT: –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
```

–†–µ—à–µ–Ω–∏–µ:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Chat ID

### SD-–∫–∞—Ä—Ç–∞ –Ω–µ –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è

```
E (3000) SD_STORAGE: –û—à–∏–±–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è SD-–∫–∞—Ä—Ç—ã
```

–†–µ—à–µ–Ω–∏–µ:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–∏–Ω–æ–≤
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ SD-–∫–∞—Ä—Ç–∞ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ FAT32
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `SD_FORMAT_IF_FAILED true`

### AI –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
W (300000) AI_CONTROLLER: TensorFlow Lite –º–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è PID-–∞–ª–≥–æ—Ä–∏—Ç–º
```

–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! TFLite –º–æ–¥–µ–ª—å –ø–æ–∫–∞ –Ω–µ –æ–±—É—á–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π PID-–∞–ª–≥–æ—Ä–∏—Ç–º.

## –ö–æ–º–∞–Ω–¥—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### MQTT Explorer

–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤—Å–µ —Ç–æ–ø–∏–∫–∏:
```
hydro/hydro_gateway_001/#
```

–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã:
```
Topic: hydro/hydro_gateway_001/commands
Payload: {"command":"set_ph_target","payload":{"value":6.5}}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ SD-–∫–∞—Ä—Ç—ã

```bash
# –ò–∑–≤–ª–µ–∫–∏—Ç–µ SD-–∫–∞—Ä—Ç—É –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ –∫–æ–º–ø—å—é—Ç–µ—Ä
# –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª—ã:
cat /data/sensors/all_20251009.csv
cat /data/events/alarms_20251009.log
```

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏

‚úÖ **–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –µ—Å–ª–∏:**

1. MQTT –ø—É–±–ª–∏–∫—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
2. SD-–∫–∞—Ä—Ç–∞ –ª–æ–≥–∏—Ä—É–µ—Ç –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
3. Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –≤ 20:00
4. AI –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è—Ö pH/EC
5. Free heap > 150KB
6. –ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### Node-RED Dashboard

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Node-RED –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å Mosquitto:
```bash
npm install -g --unsafe-perm node-red
node-red
# –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:1880
```

–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ flow –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ MQTT –¥–∞–Ω–Ω—ã—Ö.

### Home Assistant –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `configuration.yaml`:
```yaml
mqtt:
  sensor:
    - name: "Hydro pH"
      state_topic: "hydro/hydro_gateway_001/sensors/ph"
      value_template: "{{ value_json.value }}"
      unit_of_measurement: "pH"
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

- [ ] –û–±—É—á–∏—Ç—å TensorFlow Lite –º–æ–¥–µ–ª—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–µ–±-dashboard –Ω–∞ ESP32
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å OTA –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- [ ] –î–æ–±–∞–≤–∏—Ç—å multi-language –ø–æ–¥–¥–µ—Ä–∂–∫—É
- [ ] –°–æ–∑–¥–∞—Ç—å –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Flutter/React Native)

