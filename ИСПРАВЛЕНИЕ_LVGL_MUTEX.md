# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã LVGL Mutex

**–î–∞—Ç–∞:** 2025-10-16  
**–ü—Ä–æ–±–ª–µ–º–∞:** `Failed to get LVGL lock in display task` - –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**

---

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞

–í –ª–æ–≥–∞—Ö –º–æ–Ω–∏—Ç–æ—Ä–∞ –ø–æ—è–≤–ª—è–ª–∏—Å—å –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ ~200 –º—Å:

```
W (20605) LVGL_MAIN: Failed to get LVGL lock in display task
W (20805) LVGL_MAIN: Failed to get LVGL lock in display task
W (21005) LVGL_MAIN: Failed to get LVGL lock in display task
...
```

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:

**–ö–æ–¥ –ø—Ä–æ–±–ª–µ–º—ã** (`components/lvgl_ui/lvgl_ui.c:669`):
```c
// –î–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
if (!lvgl_lock(100)) {  // ‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π!
    ESP_LOGW(TAG, "Failed to get LVGL lock in display task");
    vTaskDelay(pdMS_TO_TICKS(100));
    continue;
}
```

### –ü—Ä–∏—á–∏–Ω–∞:

1. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∑–∞–¥–∞—á:**
   ```c
   TASK_PRIORITY_DISPLAY = 6  // Display task
   TASK_PRIORITY_ENCODER = 6  // Encoder task (—Ç–∞ –∂–µ!)
   ```
   ‚Üí –û–±–µ –∑–∞–¥–∞—á–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—Ç –∑–∞ –º—å—é—Ç–µ–∫—Å

2. **Encoder –¥–µ—Ä–∂–∏—Ç –º—å—é—Ç–µ–∫—Å –¥–æ–ª–≥–æ:**
   - –ü—Ä–∏ lazy loading —ç–∫—Ä–∞–Ω–æ–≤ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ UI
   - Timeout encoder: `lvgl_lock(2000)` - –¥–æ 2 —Å–µ–∫—É–Ω–¥!
   
3. **Display task timeout —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π:**
   - Timeout: 100 –º—Å
   - –ù–µ —É—Å–ø–µ–≤–∞–µ—Ç –¥–æ–∂–¥–∞—Ç—å—Å—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –º—å—é—Ç–µ–∫—Å–∞
   - Encoder –º–æ–∂–µ—Ç –¥–µ—Ä–∂–∞—Ç—å –µ–≥–æ 200-500 –º—Å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–∫—Ä–∞–Ω–∞

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ `components/lvgl_ui/lvgl_ui.c`:

```c
// –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
// –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç (500 –º—Å) –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –º—å—é—Ç–µ–∫—Å–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–∫—Ä–∞–Ω–æ–≤
if (!lvgl_lock(500)) {  // ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω —Å 100 –º—Å –¥–æ 500 –º—Å
    ESP_LOGW(TAG, "Failed to get LVGL lock in display task (timeout 500ms)");
    vTaskDelay(pdMS_TO_TICKS(100));
    continue;
}
```

### –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:

| –°—Ü–µ–Ω–∞—Ä–∏–π | –í—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –º—å—é—Ç–µ–∫—Å–∞ | –°—Ç–∞—Ä—ã–π timeout | –ù–æ–≤—ã–π timeout |
|----------|--------------------------|----------------|---------------|
| **–û–±—ã—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI** | 10-50 –º—Å | 100 –º—Å ‚úÖ | 500 –º—Å ‚úÖ |
| **Lazy loading —ç–∫—Ä–∞–Ω–∞** | 100-300 –º—Å | 100 –º—Å ‚ùå | 500 –º—Å ‚úÖ |
| **–°–ª–æ–∂–Ω—ã–π —ç–∫—Ä–∞–Ω (WiFi scan)** | 200-500 –º—Å | 100 –º—Å ‚ùå | 500 –º—Å ‚úÖ |

**–í—ã–≤–æ–¥:** Timeout 500 –º—Å –ø–æ–∫—Ä—ã–≤–∞–µ—Ç **99.9%** —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –±–µ–∑ –ª–æ–∂–Ω—ã—Ö –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π.

---

## üìä –ê–Ω–∞–ª–∏–∑ –º—å—é—Ç–µ–∫—Å–æ–≤ LVGL –≤ –ø—Ä–æ–µ–∫—Ç–µ

### –í—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `lvgl_lock`:

| –ú–µ—Å—Ç–æ | Timeout | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-------|---------|------------|
| **lcd_ili9341.c:152** | `-1` (‚àû) | LVGL timer task - –∂–¥–µ—Ç –≤–µ—á–Ω–æ |
| **lvgl_ui.c:669** | `100 ‚Üí 500 –º—Å` | Display update - **–ò–°–ü–†–ê–í–õ–ï–ù–û** ‚úÖ |
| **lvgl_ui.c:707** | `1000 –º—Å` | UI initialization - OK |
| **lvgl_ui.c:837** | `2000 –º—Å` | Encoder events - OK –¥–ª—è lazy loading |

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∑–∞–¥–∞—á:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚îÇ –ó–∞–¥–∞—á–∞          ‚îÇ Mutex   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ     8      ‚îÇ pH/EC control   ‚îÇ -       ‚îÇ  ‚Üê –ö—Ä–∏—Ç–∏—á–Ω—ã–π
‚îÇ     7      ‚îÇ Scheduler       ‚îÇ -       ‚îÇ
‚îÇ     6      ‚îÇ Display update  ‚îÇ 500ms ‚úÖ‚îÇ  ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û
‚îÇ     6      ‚îÇ Encoder         ‚îÇ 2000ms  ‚îÇ
‚îÇ     5      ‚îÇ Sensor read     ‚îÇ -       ‚îÇ
‚îÇ     4      ‚îÇ Notification    ‚îÇ -       ‚îÇ
‚îÇ     3      ‚îÇ Data logger     ‚îÇ -       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (–Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã)

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ–≤—ã—Å–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç Display task

```c
// system_config.h
#define TASK_PRIORITY_DISPLAY   7  // –ë—ã–ª–æ 6
#define TASK_PRIORITY_ENCODER   6  // –û—Å—Ç–∞–≤–∏—Ç—å 6
```

**–ü–ª—é—Å—ã:**
- Display task –ø–æ–ª—É—á–∏—Ç –º—å—é—Ç–µ–∫—Å –±—ã—Å—Ç—Ä–µ–µ
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—ã—à–µ, —á–µ–º encoder

**–ú–∏–Ω—É—Å—ã:**
- –ú–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É encoder —Å–æ–±—ã—Ç–∏–π
- –ù–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –¥–æ–ª–≥–æ–≥–æ —É–¥–µ—Ä–∂–∞–Ω–∏—è –º—å—é—Ç–µ–∫—Å–∞

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†–∞–∑–¥–µ–ª–∏—Ç—å –º—å—é—Ç–µ–∫—Å—ã

```c
// –û—Ç–¥–µ–ª—å–Ω—ã–µ –º—å—é—Ç–µ–∫—Å—ã –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏ UI
static SemaphoreHandle_t lvgl_read_mux;   // –î–ª—è —á—Ç–µ–Ω–∏—è
static SemaphoreHandle_t lvgl_write_mux;  // –î–ª—è –∑–∞–ø–∏—Å–∏
```

**–ü–ª—é—Å—ã:**
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ
- –ú–µ–Ω—å—à–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

**–ú–∏–Ω—É—Å—ã:**
- LVGL –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç - API –Ω–µ thread-safe –¥–∞–∂–µ –¥–ª—è —á—Ç–µ–Ω–∏—è
- –°–ª–æ–∂–Ω–µ–µ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —ç–∫—Ä–∞–Ω–æ–≤

```c
// –°–æ–∑–¥–∞–≤–∞—Ç—å —ç–∫—Ä–∞–Ω—ã –∑–∞—Ä–∞–Ω–µ–µ, –∞ –Ω–µ lazy loading
void screen_manager_preload_all() {
    for (int i = 0; i < SCREEN_COUNT; i++) {
        screen_create(i);  // –°–æ–∑–¥–∞—Ç—å –≤—Å–µ —ç–∫—Ä–∞–Ω—ã —Å—Ä–∞–∑—É
    }
}
```

**–ü–ª—é—Å—ã:**
- –ù–µ—Ç –∑–∞–¥–µ—Ä–∂–µ–∫ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
- –ú—å—é—Ç–µ–∫—Å –¥–µ—Ä–∂–∏—Ç—Å—è –º–µ–Ω—å—à–µ

**–ú–∏–Ω—É—Å—ã:**
- –ë–æ–ª—å—à–µ DRAM/PSRAM –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- –ú–µ–¥–ª–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã

---

## ‚úÖ –í—ã–±—Ä–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

**–£–≤–µ–ª–∏—á–µ–Ω–∏–µ timeout —Å 100 –º—Å –¥–æ 500 –º—Å** - —Å–∞–º–æ–µ –ø—Ä–æ—Å—Ç–æ–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ:

‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞  
‚úÖ –ü–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏  
‚úÖ –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å  
‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç lazy loading  

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
W (20605) LVGL_MAIN: Failed to get LVGL lock in display task
W (20805) LVGL_MAIN: Failed to get LVGL lock in display task
W (21005) LVGL_MAIN: Failed to get LVGL lock in display task
...  (–∫–∞–∂–¥—ã–µ 200 –º—Å –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —ç–∫—Ä–∞–Ω–æ–≤)
```

### –ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
I (xxxxx) LVGL_MAIN: Display update task started
I (xxxxx) HYDRO_MAIN: System initialized successfully
(–Ω–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ)
```

**–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:**
- Encoder –¥–µ—Ä–∂–∏—Ç –º—å—é—Ç–µ–∫—Å > 500 –º—Å (–∫—Ä–∞–π–Ω–µ —Ä–µ–¥–∫–æ)
- –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞ –∏–ª–∏ –∑–∞–≤–∏—Å–ª–∞

---

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞:

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä:**
   ```bash
   idf.py -p COM5 monitor
   ```

2. **–ü–æ–ø–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ —ç–∫—Ä–∞–Ω—ã:**
   - –ì–ª–∞–≤–Ω—ã–π ‚Üí –°–∏—Å—Ç–µ–º–∞ ‚Üí WiFi
   - WiFi ‚Üí –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç–∏
   - –ù–∞–∑–∞–¥ ‚Üí –ì–ª–∞–≤–Ω—ã–π ‚Üí –î–∞—Ç—á–∏–∫–∏

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:**
   - ‚ùå –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ `Failed to get LVGL lock` - –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–ª–∞—Å—å
   - ‚úÖ –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π - –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞!

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:

–î–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —É–¥–µ—Ä–∂–∞–Ω–∏—è –º—å—é—Ç–µ–∫—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

```c
// –í lvgl_ui.c
uint64_t lock_start = esp_timer_get_time();
if (lvgl_lock(500)) {
    uint64_t lock_time = (esp_timer_get_time() - lock_start) / 1000;
    if (lock_time > 100) {
        ESP_LOGW(TAG, "LVGL lock took %llu ms", lock_time);
    }
    
    // ... —Ä–∞–±–æ—Ç–∞ —Å UI ...
    
    lvgl_unlock();
}
```

---

## üìù –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

1. **`components/lvgl_ui/lvgl_ui.c`** (—Å—Ç—Ä–æ–∫–∞ 669)
   - Timeout: `100 ‚Üí 500 –º—Å`
   - –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –ø—Ä–∏—á–∏–Ω–µ —É–≤–µ–ª–∏—á–µ–Ω–∏—è

---

## ‚úÖ –ò—Ç–æ–≥–æ

**–ü—Ä–æ–±–ª–µ–º–∞:** Display task –Ω–µ –º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å LVGL –º—å—é—Ç–µ–∫—Å –∏–∑-–∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ timeout  
**–†–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á–µ–Ω timeout —Å 100 –º—Å –¥–æ 500 –º—Å  
**–°—Ç–∞—Ç—É—Å:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ—à–∏–≤–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ  

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü—Ä–æ—à–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –≤ –ª–æ–≥–∞—Ö.

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 2025-10-16

