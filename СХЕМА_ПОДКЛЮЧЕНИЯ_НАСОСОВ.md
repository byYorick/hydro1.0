# Схема подключения перистальтических насосов

## Назначение GPIO пинов ESP32-S3

| Насос | GPIO | Назначение |
|-------|------|------------|
| pH UP | GPIO 1 | Повышение pH |
| pH DOWN | GPIO 2 | Понижение pH |
| EC A | GPIO 3 | Раствор A (питательный) |
| EC B | GPIO 7 | Раствор B (питательный) |
| EC C | GPIO 8 | Раствор C (питательный) |
| Water | GPIO 16 | Чистая вода |

## Схема подключения одного насоса

```
                    ┌───────────────┐
ESP32-S3            │   Оптопара    │         Полевой                  Насос
                    │   PC817/4N35  │       транзистор                 12V DC
                    │               │
GPIO (3.3V) ────────┤1 LED+    C  4├──────┬─────────┐
                    │               │      │         │
          ┌─────────┤2 LED-    E  3├──┐   │   G     │
          │         │               │  │   └─────┐   │
         330Ω       └───────────────┘  │         │   │
          │                            │    ┌────┴───┴────┐
         GND                           │    │   IRLZ44N   │
                                       │    │ IRF540/540N │
                                      GND   │             │
                                            ├─ D (Drain)  │
                                            │             │
                                       12V+ ─┤             │
                                            │             │
                                            └─ S (Source) ┴─── Насос (-)
                                                          │
                                            Насос (+) ────┘
```

## Компоненты для ОДНОГО насоса

### Оптопара
- **PC817** или **4N35** (рекомендуется PC817)
- Изоляция 5000V между управлением и силовой частью
- Ток управления: 5-20 мА
- Резистор: **330 Ом** (ограничение тока LED)

### Полевой транзистор (MOSFET)
Выберите один из:
- **IRLZ44N** (логический уровень, 55V, 47A) - **РЕКОМЕНДУЕТСЯ**
- **IRF540N** (100V, 33A, требует выше напряжение на затворе)
- **IRF520** (100V, 9A, подходит для небольших насосов)

### Дополнительные компоненты
- **Резистор 10 кОм** (подтяжка затвора к земле)
- **Диод 1N4007** (обратная защита от индуктивности двигателя)
- **Конденсатор 100 нФ** (сглаживание помех)

## Полная схема для одного насоса с защитой

```
ESP32-S3 GPIO ──────┬─── 330Ω ───┤ LED+ PC817
                    │             │
                   3.3V           └ LED- ───── GND
                                  
                                  ┌─ Collector (C)
                                  │
                            10kΩ  │  IRLZ44N
                            ↓     │  ┌───────┐
                           GND ───┼──┤ Gate  │
                                  │  │       │
                                  └──┤ Emitter│
                                     └───┬───┘
                                         │
                              ┌──────────┴──────────┐
                              │                     │
                         12V+ ┴                     │ Drain
                              │                     │
                         ┌────┴────┐          ┌────┴────┐
                         │  Насос  │          │         │
                         │  12V DC │          │ IRLZ44N │
                         └────┬────┘          │         │
                              │               └────┬────┘
                         ┌────┴────┐              │ Source
                    ┌────┤ 1N4007  ├────┐         │
                    │    └─────────┘    │         │
                   GND                  GND       GND
                    
```

## Таблица всех подключений

| GPIO | Оптопара | Транзистор | Насос 12V | Назначение |
|------|----------|------------|-----------|------------|
| GPIO 1 | PC817 #1 | IRLZ44N #1 | Насос #1 | pH UP |
| GPIO 2 | PC817 #2 | IRLZ44N #2 | Насос #2 | pH DOWN |
| GPIO 3 | PC817 #3 | IRLZ44N #3 | Насос #3 | EC A |
| GPIO 7 | PC817 #4 | IRLZ44N #4 | Насос #4 | EC B |
| GPIO 8 | PC817 #5 | IRLZ44N #5 | Насос #5 | EC C |
| GPIO 16 | PC817 #6 | IRLZ44N #6 | Насос #6 | Water |

## Блок питания

- **Напряжение**: 12V DC
- **Ток**: минимум 3A (для 6 насосов по 0.5A каждый)
- **Рекомендуемый БП**: 12V 5A (с запасом)

## Логика работы

### Включение насоса
```c
gpio_set_level(GPIO_PIN, 1);  // HIGH (3.3V)
```
- LED оптопары включается
- Фототранзистор открывается
- Затвор MOSFET получает напряжение
- MOSFET открывается
- Насос получает питание 12V

### Выключение насоса
```c
gpio_set_level(GPIO_PIN, 0);  // LOW (0V)
```
- LED оптопары выключается
- Фототранзистор закрывается
- Резистор 10кОм подтягивает затвор к GND
- MOSFET закрывается
- Насос останавливается

## Рекомендации по монтажу

1. **Используйте общий GND** для ESP32-S3 и оптопар
2. **НЕ соединяйте** GND силовой части (12V) с GND логической части (3.3V) - только через оптопару
3. **Размещайте оптопары** как можно ближе к ESP32-S3
4. **Размещайте транзисторы** близко к насосам для минимизации потерь
5. **Используйте радиаторы** на транзисторах при больших токах (>2A)
6. **Добавьте конденсаторы** 100нФ на каждый GPIO пин для подавления помех
7. **Используйте экранированные провода** для длинных соединений

## Проверка работоспособности

### Тест 1: Проверка GPIO
```bash
idf.py monitor
# Посмотрите логи при включении насоса
```

### Тест 2: Проверка оптопары
- Измерьте напряжение на LED+ при включенном GPIO (должно быть ~3.0V)
- Проверьте напряжение на коллекторе (должно меняться)

### Тест 3: Проверка транзистора
- Измерьте напряжение на затворе (должно быть ~3-5V при включении)
- Проверьте напряжение между Drain и Source (должно быть ~0V при открытом транзисторе)

## Безопасность

⚠️ **ВАЖНО:**
- Всегда выключайте питание перед подключением/отключением компонентов
- Проверяйте полярность подключения насосов
- Не превышайте максимальный ток транзисторов
- Используйте предохранители на линии 12V (рекомендуется 5A)
- Изолируйте все силовые соединения

## Код в прошивке

Инициализация выполняется автоматически при старте системы:

```c
// Автоматическая инициализация всех насосов
pump_manager_init();

// Ручное управление (пример)
pump_manager_run_direct(PUMP_INDEX_PH_UP, 5000); // 5 секунд

// PID управление (автоматически)
pump_manager_compute_and_execute(PUMP_INDEX_PH_UP, current_ph, target_ph);
```

## Спецификация компонентов

### Для заказа (на 6 насосов)

| Компонент | Количество | Примечание |
|-----------|------------|------------|
| PC817 | 6 шт | Оптопара |
| IRLZ44N | 6 шт | Полевой транзистор (логический уровень) |
| Резистор 330 Ом (0.25W) | 6 шт | Для LED оптопары |
| Резистор 10 кОм (0.25W) | 6 шт | Подтяжка затвора |
| Диод 1N4007 | 6 шт | Защита от обратного тока |
| Конденсатор 100 нФ (керамика) | 6 шт | Подавление помех |
| Блок питания 12V 5A | 1 шт | Питание насосов |
| Перистальтический насос 12V | 6 шт | Основные насосы |

---

**Дата создания:** 2025-10-10  
**Версия:** 1.0  
**Проект:** Hydroponics Monitor v3.0

