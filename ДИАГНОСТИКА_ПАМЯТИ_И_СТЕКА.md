# üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–∞–º—è—Ç–∏ –∏ —Å—Ç–µ–∫–∞

**–î–∞—Ç–∞:** 2025-10-16  
**–í—Ä–µ–º—è:** –ü–æ—Å–ª–µ –≤—Å–µ—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π  

---

## üìä –¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

```
DIRAM: 266007 / 341760 bytes (77.83%) ‚ö†Ô∏è –£–•–£–î–®–ò–õ–û–°–¨!
‚îú‚îÄ .bss:   150096 bytes (43.92%)
‚îú‚îÄ .data:   21884 bytes (6.4%)  ‚Üê +6 KB –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ!
‚îî‚îÄ .text:   94027 bytes (27.51%) ‚Üê +28.5 KB –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ!

–°–≤–æ–±–æ–¥–Ω–æ: 75 KB (–±—ã–ª–æ 108 KB) ‚ö†Ô∏è
```

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞:

–ü–æ—Å–ª–µ `fullclean` –ø–∞–º—è—Ç—å **—É—Ö—É–¥—à–∏–ª–∞—Å—å**:
- `.data` –≤—ã—Ä–æ—Å–ª–∞ —Å 15768 ‚Üí 21884 bytes (+6116 bytes)
- `.text` –≤ DRAM –≤—ã—Ä–æ—Å–ª–∞ —Å 65487 ‚Üí 94027 bytes (+28540 bytes)

**–í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ —Å–±—Ä–æ—à–µ–Ω–∞

---

## üéØ –†–∞–∑–º–µ—Ä—ã —Å—Ç–µ–∫–æ–≤ –∑–∞–¥–∞—á

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`system_config.h`):

```c
SENSOR:       4096 bytes (4 KB)
DISPLAY:      2560 bytes (2.5 KB)
NOTIFICATION: 2048 bytes (2 KB)
DATALOGGER:   3072 bytes (3 KB)
SCHEDULER:    1536 bytes (1.5 KB)
PH_EC:        1536 bytes (1.5 KB)
ENCODER:      1536 bytes (1.5 KB)
LVGL:        20480 bytes (20 KB) ‚Üê –û–¢–î–ï–õ–¨–ù–û –≤ lcd_ili9341.c
```

### LVGL Task Stack:

```c
// components/lcd_ili9341/lcd_ili9341.c:78
#define LVGL_TASK_STACK_SIZE   (20 * 1024)  // 20 KB
#define LVGL_TASK_PRIORITY     2            // –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!
```

**‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç LVGL task = 2 (—Å–∞–º—ã–π –Ω–∏–∑–∫–∏–π!)

–î—Ä—É–≥–∏–µ –∑–∞–¥–∞—á–∏:
- pH/EC:     Priority 8 (–∫—Ä–∏—Ç–∏—á–Ω—ã–π)
- Scheduler: Priority 7
- Display:   Priority 6
- Encoder:   Priority 6
- Sensor:    Priority 5
- **LVGL:    Priority 2** ‚Üê –°–õ–ò–®–ö–û–ú –ù–ò–ó–ö–ò–ô!

---

## üî¥ Watchdog Backtrace Analysis

```
Backtrace: wait_for_flushing ‚Üí layer_reshape_draw_buf ‚Üí refr_area_part ‚Üí refr_area ‚Üí refr_invalid_areas ‚Üí lv_display_refr_timer ‚Üí lv_timer_exec ‚Üí lv_timer_handler ‚Üí lvgl_task_handler

–ó–∞–≤–∏—Å–∞–µ—Ç –Ω–∞: wait_for_flushing (lv_refr.c:1220)
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. LVGL –Ω–∞—á–∏–Ω–∞–µ—Ç –æ—Ç—Ä–∏—Å–æ–≤–∫—É
2. –í—ã–∑—ã–≤–∞–µ—Ç `lvgl_flush_cb()` ‚Üí `esp_lcd_panel_draw_bitmap()`
3. SPI –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–µ—Ä–µ–¥–∞—á—É (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
4. LVGL –∂–¥–µ—Ç –≤ `wait_for_flushing()` –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞—á–∏
5. **–ü–µ—Ä–µ–¥–∞—á–∞ –∏–¥–µ—Ç > 5 —Å–µ–∫—É–Ω–¥** ‚Üí Watchdog timeout!

**–ü–æ—á–µ–º—É —Ç–∞–∫ –¥–æ–ª–≥–æ:**
- PSRAM –º–µ–¥–ª–µ–Ω–Ω–µ–µ SRAM –≤ 3-8 —Ä–∞–∑
- SPI DMA —á–∏—Ç–∞–µ—Ç –∏–∑ PSRAM ‚Üí –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏
- –ë—É—Ñ–µ—Ä—ã 40 —Å—Ç—Ä–æ–∫ √ó 240 –ø–∏–∫—Å–µ–ª–µ–π √ó 2 –±–∞–π—Ç–∞ = 19.2 KB
- –ü—Ä–∏ 20 MHz SPI: 19.2 KB / (20 MHz / 16) ‚âà 15 –º—Å —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏
- –ù–æ —Å PSRAM –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é: –º–æ–∂–µ—Ç –±—ã—Ç—å 100-200 –º—Å
- –ü—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö flush –ø–æ–¥—Ä—è–¥: > 5 —Å–µ–∫—É–Ω–¥!

---

## üí° –†–ï–®–ï–ù–ò–ï

### –í–∞—Ä–∏–∞–Ω—Ç 1: –£–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç LVGL task ‚≠ê –†–ï–ö–û–ú–ï–ù–î–£–Æ

```c
// lcd_ili9341.c
#define LVGL_TASK_PRIORITY     7  // –ë—ã–ª–æ 2 ‚Üí —Ç–µ–ø–µ—Ä—å –≤—ã—à–µ Display/Encoder
```

**–õ–æ–≥–∏–∫–∞:**
- LVGL timer –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ Display update
- –ò–Ω–∞—á–µ Display task –¥–µ—Ä–∂–∏—Ç –º—å—é—Ç–µ–∫—Å –∏ LVGL –Ω–µ –º–æ–∂–µ—Ç —Ä–∏—Å–æ–≤–∞—Ç—å
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 7 = –≤—ã—à–µ Display(6) –∏ Encoder(6), –Ω–æ –Ω–∏–∂–µ pH/EC(8)

### –í–∞—Ä–∏–∞–Ω—Ç 2: –£–º–µ–Ω—å—à–∏—Ç—å –±—É—Ñ–µ—Ä—ã –µ—â–µ –±–æ–ª—å—à–µ

```c
// –ë—É—Ñ–µ—Ä—ã 40 ‚Üí 20 —Å—Ç—Ä–æ–∫
disp_buf1 = heap_caps_malloc(LCD_H_RES * 20 * sizeof(lv_color_t), ...);
```

**–ü–ª—é—Å—ã:** –ë—ã—Å—Ç—Ä–µ–µ flush (–≤ 2 —Ä–∞–∑–∞)  
**–ú–∏–Ω—É—Å—ã:** –ë–æ–ª—å—à–µ –≤—ã–∑–æ–≤–æ–≤ flush (–º–µ–¥–ª–µ–Ω–Ω–µ–µ –æ–±—â–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞)

### –í–∞—Ä–∏–∞–Ω—Ç 3: –í–µ—Ä–Ω—É—Ç—å –±—É—Ñ–µ—Ä—ã –≤ DRAM (–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–Æ)

```c
// –í–µ—Ä–Ω—É—Ç—å –≤ DRAM
disp_buf1 = heap_caps_malloc(LCD_H_RES * 40 * sizeof(lv_color_t), MALLOC_CAP_INTERNAL);
```

**–ü–ª—é—Å—ã:** SPI –±—ã—Å—Ç—Ä–µ–µ —á–∏—Ç–∞–µ—Ç –∏–∑ DRAM  
**–ú–∏–Ω—É—Å—ã:** –ú–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å DRAM overflow (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å!)

---

## üìä –ê–Ω–∞–ª–∏–∑ —Å—Ç–µ–∫–∞ LVGL task

### –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π stack usage:

```
LVGL task stack: 20 KB

–ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
‚îú‚îÄ lv_timer_handler()        ~2 KB
‚îú‚îÄ lv_display_refr_timer()   ~1 KB
‚îú‚îÄ refr_invalid_areas()      ~2 KB
‚îú‚îÄ refr_area()               ~1 KB
‚îú‚îÄ refr_area_part()          ~3 KB
‚îú‚îÄ layer_reshape_draw_buf()  ~2 KB
‚îú‚îÄ wait_for_flushing()       ~1 KB
‚îú‚îÄ –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ      ~2 KB
‚îî‚îÄ –†–µ–∑–µ—Ä–≤                    ~6 KB

–ò–¢–û–ì–û: ~14 KB (70% –∏–∑ 20 KB) ‚úÖ –î–û–°–¢–ê–¢–û–ß–ù–û
```

**–í—ã–≤–æ–¥:** –°—Ç–µ–∫ –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ —ç—Ç–æ–º.

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–û–ï –†–ï–®–ï–ù–ò–ï

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ü–æ–≤—ã—Å–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç LVGL task –¥–æ 7

```c
// components/lcd_ili9341/lcd_ili9341.c:80

// –î–û:
#define LVGL_TASK_PRIORITY     2  // ‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π!

// –ü–û–°–õ–ï:
#define LVGL_TASK_PRIORITY     7  // ‚úÖ –í—ã—à–µ Display/Encoder, –Ω–∏–∂–µ pH/EC
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
1. LVGL timer task - **CORE UI** - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º
2. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 - –ø–æ—á—Ç–∏ idle, –≤—ã—Ç–µ—Å–Ω—è–µ—Ç—Å—è –≤—Å–µ–º–∏ –¥—Ä—É–≥–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏
3. –ü—Ä–∏ –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏–∏ –≤–æ –≤—Ä–µ–º—è flush ‚Üí watchdog timeout
4. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 7 = —Ä–∞–±–æ—Ç–∞–µ—Ç —á–∞—â–µ, –º–µ–Ω—å—à–µ –∑–∞–¥–µ—Ä–∂–µ–∫

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–µ–∫–∞ –≤ runtime (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

–î–æ–±–∞–≤–∏—Ç—å –≤ `lvgl_task_handler()`:

```c
// –ü–æ—Å–ª–µ lv_timer_handler()
UBaseType_t stack_left = uxTaskGetStackHighWaterMark(NULL);
if (stack_left < 2048) {  // –ú–µ–Ω—å—à–µ 2 KB –æ—Å—Ç–∞–ª–æ—Å—å
    ESP_LOGW("LCD", "LVGL stack low: %d bytes left", stack_left * 4);
}
```

---

## üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë        –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π -O2)     ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë  DRAM: 230767 / 341760 (67.5%) ‚úÖ                 ‚ïë
‚ïë    .bss:   149512 bytes                            ‚ïë
‚ïë    .data:   15768 bytes                            ‚ïë
‚ïë    .text:   65487 bytes                            ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë        –°–ï–ô–ß–ê–° (–ø–æ—Å–ª–µ fullclean, -Og?)             ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë  DRAM: 266007 / 341760 (77.8%) ‚ö†Ô∏è                 ‚ïë
‚ïë    .bss:   150096 bytes (+584)                     ‚ïë
‚ïë    .data:   21884 bytes (+6116!) ‚Üê –ü–†–û–ë–õ–ï–ú–ê        ‚ïë
‚ïë    .text:   94027 bytes (+28540!) ‚Üê –ü–†–û–ë–õ–ï–ú–ê       ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

–†–ê–ó–ù–ò–¶–ê: +35 KB –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –≤ DRAM!
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å (`-Og` debug vs `-O2` release)
2. WiFi –¥—Ä–∞–π–≤–µ—Ä –¥–æ–±–∞–≤–∏–ª –±–æ–ª—å—à–µ –∫–æ–¥–∞ –≤ DRAM
3. Network manager –∫–æ–¥ –≤ DRAM

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ü–æ—Å–º–æ—Ç—Ä–∏–º –≤ sdkconfig –∫–∞–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è.

---

## ‚úÖ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ü–æ–≤—ã—Å–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç LVGL task** (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞** –≤ sdkconfig
3. **–ü—Ä–æ—à–∏—Ç—å –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å**
4. **–ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–∂–µ—Ç:** –£–º–µ–Ω—å—à–∏—Ç—å –±—É—Ñ–µ—Ä—ã –¥–æ 20 —Å—Ç—Ä–æ–∫

