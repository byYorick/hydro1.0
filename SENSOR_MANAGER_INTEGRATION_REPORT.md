# üìä –û–¢–ß–ï–¢ –û–ë –ò–ù–¢–ï–ì–†–ê–¶–ò–ò SENSOR_MANAGER

**–î–∞—Ç–∞:** 16 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–°–ü–ï–®–ù–û –í–ù–ï–î–†–ï–ù  
**–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã:** 3.0.0-advanced  

---

## ‚úÖ –ß–¢–û –°–î–ï–õ–ê–ù–û

### 1. –°–æ–∑–¥–∞–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `sensor_manager`

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `components/sensor_manager/`

**–§–∞–π–ª—ã:**
- `sensor_manager.h` - API –∏ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
- `sensor_manager.c` - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è
- `CMakeLists.txt` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–±–æ—Ä–∫–∏

**–†–∞–∑–º–µ—Ä:** ~450 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

---

### 2. API sensor_manager

#### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

```c
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
esp_err_t sensor_manager_init(void);

// –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞—Ç—á–∏–∫–æ–≤
esp_err_t sensor_manager_read_all(sensor_data_t *data);

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±—ã—Å—Ç—Ä–æ, –±–µ–∑ I2C)
esp_err_t sensor_manager_get_cached_data(sensor_data_t *data);

// –ß—Ç–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤
esp_err_t sensor_manager_read_ph(float *ph);
esp_err_t sensor_manager_read_ec(float *ec);
esp_err_t sensor_manager_read_temp_humidity(float *temperature, float *humidity);
esp_err_t sensor_manager_read_lux(float *lux);
esp_err_t sensor_manager_read_air_quality(float *co2, float *tvoc);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –¥–∞—Ç—á–∏–∫–∞
bool sensor_manager_is_sensor_healthy(sensor_type_t sensor);

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
esp_err_t sensor_manager_get_stats(sensor_type_t sensor, sensor_stats_t *stats);

// –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞
esp_err_t sensor_manager_calibrate_ph(float measured_value, float actual_value);
esp_err_t sensor_manager_calibrate_ec(float measured_value, float actual_value);
```

---

### 3. –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

#### ‚úÖ Retry –ª–æ–≥–∏–∫–∞
- 3 –ø–æ–ø—ã—Ç–∫–∏ —á—Ç–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
- –ó–∞–¥–µ—Ä–∂–∫–∞ 50–º—Å –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (NaN, –¥–∏–∞–ø–∞–∑–æ–Ω)

#### ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏
- Timestamp –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏
- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ I2C

#### ‚úÖ –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –ú—å—é—Ç–µ–∫—Å –¥–ª—è –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∑–∞–¥–∞—á

#### ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```c
typedef struct {
    uint32_t total_reads;       // –í—Å–µ–≥–æ —á—Ç–µ–Ω–∏–π
    uint32_t successful_reads;  // –£—Å–ø–µ—à–Ω—ã—Ö
    uint32_t failed_reads;      // –ù–µ—É–¥–∞—á–Ω—ã—Ö
    float success_rate;         // –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞
    bool is_healthy;            // –ó–¥–æ—Ä–æ–≤ –ª–∏ –¥–∞—Ç—á–∏–∫ (>80%)
} sensor_stats_t;
```

#### ‚úÖ –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞
- –ü—Ä–æ—Å—Ç–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ offset
- –û—Ç–¥–µ–ª—å–Ω–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –¥–ª—è pH –∏ EC
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏

---

### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ–µ–∫—Ç

#### –û–±–Ω–æ–≤–ª–µ–Ω `main/app_main.c`:
```c
// –î–æ–±–∞–≤–ª–µ–Ω include
#include "sensor_manager.h"

// –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
ret = sensor_manager_init();
ESP_LOGI(TAG, "  [OK] Sensor Manager initialized");
```

#### –û–±–Ω–æ–≤–ª–µ–Ω `main/CMakeLists.txt`:
```cmake
PRIV_REQUIRES
    ...
    sensor_manager
    ...
```

#### –û–±–Ω–æ–≤–ª–µ–Ω `components/system_tasks/system_tasks.c`:
```c
// –§—É–Ω–∫—Ü–∏—è read_all_sensors() —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç sensor_manager
static esp_err_t read_all_sensors(sensor_data_t *data)
{
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º sensor_manager –¥–ª—è —á—Ç–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞—Ç—á–∏–∫–æ–≤
    esp_err_t ret = sensor_manager_read_all(data);
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    // ...
}
```

#### –û–±–Ω–æ–≤–ª–µ–Ω `components/system_tasks/CMakeLists.txt`:
```cmake
REQUIRES
    ...
    sensor_manager
    ...
```

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞:

```
‚úÖ Project build complete
‚úÖ –†–∞–∑–º–µ—Ä –ø—Ä–æ—à–∏–≤–∫–∏: 0xc0970 bytes (788 KB)
‚úÖ –°–≤–æ–±–æ–¥–Ω–æ: 0x3f690 bytes (25%)
‚úÖ Warnings: —Ç–æ–ª—å–∫–æ unused variables (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ)
```

---

## üîÑ –°–•–ï–ú–ê –†–ê–ë–û–¢–´

### –î–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:

```
sensor_task ‚Üí system_interfaces ‚Üí –¥—Ä–∞–π–≤–µ—Ä—ã –¥–∞—Ç—á–∏–∫–æ–≤
```

### –ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:

```
sensor_task ‚Üí sensor_manager (retry, –∫—ç—à, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞) ‚Üí –¥—Ä–∞–π–≤–µ—Ä—ã –¥–∞—Ç—á–∏–∫–æ–≤
     ‚Üì               ‚Üì
–æ–±—Ä–∞–±–æ—Ç–∫–∞       –≤–∞–ª–∏–¥–∞—Ü–∏—è
–æ—à–∏–±–æ–∫          –¥–∞–Ω–Ω—ã—Ö
```

---

## üí° –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê

### 1. ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- –í—Å–µ –¥–∞—Ç—á–∏–∫–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- –ï–¥–∏–Ω—ã–π API –¥–ª—è —á—Ç–µ–Ω–∏—è

### 2. ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- Retry –ª–æ–≥–∏–∫–∞ (3 –ø–æ–ø—ã—Ç–∫–∏)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (NaN, –¥–∏–∞–ø–∞–∑–æ–Ω)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏

### 3. ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –±–µ–∑ I2C
- –£–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —à–∏–Ω—É

### 4. ‚úÖ –£–¥–æ–±—Å—Ç–≤–æ
- –ü—Ä–æ—Å—Ç–æ–π API
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ API

### 5. ‚úÖ –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –¥–∞—Ç—á–∏–∫
- –ï–¥–∏–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ future features

---

## üìù –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï

### –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞—Ç—á–∏–∫–æ–≤:

```c
sensor_data_t data;
esp_err_t ret = sensor_manager_read_all(&data);
if (ret == ESP_OK) {
    if (data.valid[SENSOR_INDEX_PH]) {
        ESP_LOGI(TAG, "pH: %.2f", data.ph);
    }
    if (data.valid[SENSOR_INDEX_EC]) {
        ESP_LOGI(TAG, "EC: %.2f", data.ec);
    }
}
```

### –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º:

```c
sensor_data_t data;
sensor_manager_get_cached_data(&data);  // –ë–µ–∑ I2C, –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
if (data.valid[SENSOR_INDEX_TEMPERATURE]) {
    update_ui_temperature(data.temperature);
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è:

```c
if (sensor_manager_is_sensor_healthy(SENSOR_TYPE_PH)) {
    ESP_LOGI(TAG, "pH sensor is healthy (>80% success rate)");
}
```

### –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞:

```c
// –ü–æ–º–µ—Å—Ç–∏–ª–∏ –¥–∞—Ç—á–∏–∫ –≤ —ç—Ç–∞–ª–æ–Ω–Ω—ã–π —Ä–∞—Å—Ç–≤–æ—Ä pH 7.00
float measured = 7.15;  // –ü–æ–∫–∞–∑–∞–Ω–∏—è –¥–∞—Ç—á–∏–∫–∞
float actual = 7.00;    // –≠—Ç–∞–ª–æ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
sensor_manager_calibrate_ph(measured, actual);
// –¢–µ–ø–µ—Ä—å –≤—Å–µ —á—Ç–µ–Ω–∏—è –±—É–¥—É—Ç —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã
```

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–∞—Ç—á–∏–∫–∏:

| –î–∞—Ç—á–∏–∫ | –î—Ä–∞–π–≤–µ—Ä | I2C –∞–¥—Ä–µ—Å | –§—É–Ω–∫—Ü–∏—è —á—Ç–µ–Ω–∏—è |
|--------|---------|-----------|----------------|
| SHT3x | sht3x.h | 0x44 | `sht3x_read()` |
| CCS811 | ccs811.h | 0x5A | `ccs811_read_data()` |
| Trema pH | trema_ph.h | 0x0A | `trema_ph_read()` |
| Trema EC | trema_ec.h | 0x08 | `trema_ec_read()` |
| Trema Lux | trema_lux.h | 0x12 | `trema_lux_read_float()` |

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (–∏–∑ system_config.h):

```c
typedef struct {
    uint64_t timestamp;
    float ph, ec, temperature, humidity, lux, co2;
    bool valid[SENSOR_COUNT];  // –§–ª–∞–≥–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
    float temp, hum;            // –ê–ª–∏–∞—Å—ã
    // ... –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è UI
} sensor_data_t;
```

---

## üìà –ú–ï–¢–†–ò–ö–ò

### –ü–∞–º—è—Ç—å:

- **RAM:** ~2 KB (–∫—ç—à + –º—å—é—Ç–µ–∫—Å + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
- **Flash:** ~5 KB (–∫–æ–¥ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞)

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

- **–ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞—Ç—á–∏–∫–æ–≤:** ~150-200 –º—Å
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø:** <1 –º—Å
- **Retry –ø—Ä–∏ –æ—à–∏–±–∫–µ:** +50–º—Å –Ω–∞ –ø–æ–ø—ã—Ç–∫—É (–º–∞–∫—Å 150–º—Å)

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –±—É–¥—É—â–µ–≥–æ:

1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –≤ NVS
2. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å callback –¥–ª—è —Å–æ–±—ã—Ç–∏–π –¥–∞—Ç—á–∏–∫–æ–≤
4. ‚úÖ –†–∞—Å—à–∏—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–≥—Ä–∞—Ñ–∏–∫–∏, —Ç—Ä–µ–Ω–¥—ã)
5. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å data_logger –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

---

## ‚úÖ –ò–¢–û–ì

**sensor_manager —É—Å–ø–µ—à–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –ø—Ä–æ–µ–∫—Ç!**

–¢–µ–ø–µ—Ä—å:
- ‚úÖ –í—Å–µ —á—Ç–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–æ–≤ –∏–¥–µ—Ç —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä
- ‚úÖ Retry –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
- ‚úÖ –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- ‚úÖ –ü—Ä–æ–µ–∫—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –ì–æ—Ç–æ–≤ –∫ –ø—Ä–æ—à–∏–≤–∫–µ

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å—Ç–∞–ª–∞ –µ—â–µ –ª—É—á—à–µ!** üöÄ‚ú®


