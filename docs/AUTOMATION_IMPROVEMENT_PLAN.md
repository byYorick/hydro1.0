# План оптимизации автоматизации гидропонной системы

## 1. Текущее состояние
- **Сбор данных**: система считывает pH, EC, температуру, влажность, освещенность и CO₂, обновляя UI каждые 2 секунды.
- **Исполнительные механизмы**: имеются драйверы перистальтических насосов и твердотельного реле, но автоматическая логика дозирования не связана с настройками.
- **Интерфейс**: главный экран отображает показания, но меню настроек ограничено и не сохраняет параметры.
- **Память**: подсистема NVS инициализируется, но не используется для конфигурации.

## 2. Ключевые проблемы
1. Отсутствие централизованного менеджера настроек, отвечающего за хранение целевых значений и параметров автоматизации.
2. Нет механизма связи пользовательских настроек с исполнительными компонентами (насосы, реле).
3. Логика автоматического дозирования не учитывает стабильность измерений и не имеет защит от частых срабатываний.
4. Нет единого подхода к обновлению интерфейса при изменении конфигурации.
5. Отсутствуют диагностические/журнальные данные по действиям автоматики.

## 3. Цели оптимизации
- Создать модуль управления настройками с хранением в NVS.
- Обеспечить полноценный экран настроек с возможностью корректировки целевых значений и параметров автоматики.
- Реализовать контроллер автоматизации, который использует актуальные настройки и управляет насосами/реле.
- Организовать синхронизацию между UI, логикой и памятью.
- Подготовить основу для расширения (журналы, удаленный доступ, дополнительные датчики).

## 4. Предлагаемые улучшения
### 4.1 Управление настройками
- Ввести структуру `hydro_settings_t` с версионированием и полями: целевой pH/EC, допуски, длительность и период дозирования, управление освещением.
- Создать компонент `hydro_settings`, который загружает значения из NVS, обеспечивает методы обновления и уведомляет слушателей об изменениях.

### 4.2 Пользовательский интерфейс
- Расширить настройки в UI: вкладки "Питание", "Автоматизация", "Освещение".
- Использовать слайдеры, переключатели и спинбоксы с отображением актуальных значений.
- Поддержать двустороннюю синхронизацию: UI → настройки (через события) и настройки → UI (через колбэк).

### 4.3 Контроллер автоматизации
- Создать компонент `automation_controller`, который:
  - Инициализирует насосы и следит за паузами между включениями.
  - На основе показаний датчиков корректирует pH/EC в соответствии с настройками.
  - Управляет реле освещения в автоматическом и ручном режимах.
  - Ведет журналы действий (log).

### 4.4 Интеграция
- В `app_main` инициализировать настройки, UI и контроллер, зарегистрировать слушателей.
- В задаче считывания датчиков передавать значения в контроллер.
- При изменении настроек автоматически обновлять контроллер и интерфейс.

### 4.5 Дальнейшее развитие
- Добавить хранение истории датчиков и действий автоматики во flash или внешнее хранилище.
- Реализовать удаленный доступ (MQTT/HTTP) для мониторинга и настройки.
- Ввести режим калибровки датчиков через UI и пошаговые мастеры.
- Добавить уведомления и защиту (ограничения по количеству дозировок, анализ трендов).

## 5. Ожидаемый эффект
- Настройки будут сохраняться между перезагрузками и синхронизироваться между всеми компонентами.
- Автоматическое регулирование pH/EC станет управляемым и безопасным благодаря паузам и допускам.
- Пользователь получит понятный интерфейс для управления ключевыми параметрами и исполнительными устройствами.
- Система станет готовой к дальнейшему расширению и подключению внешних сервисов.
