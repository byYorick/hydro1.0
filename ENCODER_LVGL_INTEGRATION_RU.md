# Интеграция энкодера с LVGL 8.3 для проекта гидропоники на ESP32-S3

Этот документ объясняет, как энкодер интегрирован с LVGL 8.3 в проекте гидропоники, обеспечивая надлежащую функциональность с FreeRTOS.

## Обзор

Интеграция реализует полноценное решение для использования вращательного энкодера с системой ввода LVGL, предоставляя:
- Плавную навигацию между элементами пользовательского интерфейса
- Правильную обработку кнопок для взаимодействия
- Потокобезопасную работу с FreeRTOS
- Быстрый отклик на события энкодера

## Детали реализации

### 1. Аппаратная конфигурация

Энкодер подключен к следующим GPIO-пинам:
- CLK (A): GPIO1
- DT (B): GPIO2
- SW (Кнопка): GPIO3

Эти пины настроены в [main/app_main.c](file:///c%3A/esp/hydro/hydro1.0/main/app_main.c):
```c
#define ENC_A_PIN           1   // CLK - Encoder pin (clock signal)
#define ENC_B_PIN           2   // DT - Encoder pin (data)
#define ENC_SW_PIN          3   // Encoder button
```

### 2. Драйвер энкодера ([components/encoder/](file:///c%3A/esp/hydro/hydro1.0/components/encoder/))

Драйвер энкодера использует периферийный модуль PCNT (Pulse Counter) ESP-IDF для точного декодирования квадратурных сигналов:
- PCNT отслеживает импульсы энкодера для определения вращения
- Точки наблюдения запускают события при достижении определенных значений счетчика
- Аппаратный фильтр дребезга (2000 нс) для стабильных показаний
- Обработка событий на основе очереди для эффективной работы

Ключевые улучшения:
- Увеличен размер очереди с 10 до 20 для предотвращения переполнения
- Удалена периодическая задержка опроса для снижения задержки
- Задача теперь бесконечно ждет события в очереди

### 3. Интеграция с LVGL ([components/lvgl_main/lvgl_encoder.c](file:///c%3A/esp/hydro/hydro1.0/components/lvgl_main/lvgl_encoder.c))

Выделенный модуль обрабатывает интеграцию с LVGL:
- Реализует [lv_indev_drv_t](file:///c%3A/esp/hydro/hydro1.0/build/esp-idf/lvgl__lvgl/lvgl/src/hal/lv_hal_indev.h#L47-L62) для ввода с энкодера
- Создает группу LVGL для навигации по объектам
- Предоставляет функцию обратного вызова для системы ввода LVGL
- Автоматически добавляет интерактивные объекты в группу

Функция обратного вызова:
```c
static void encoder_read_cb(lv_indev_drv_t *indev_drv, lv_indev_data_t *data)
{
    static int32_t last_count = 0;
    
    // Получить текущий счетчик энкодера
    int32_t current_count = encoder_get_count();
    
    // Вычислить разницу с последнего чтения
    enc_data.enc_diff = current_count - last_count;
    last_count = current_count;
    
    // Получить состояние кнопки
    enc_data.state = encoder_button_pressed() ? LV_INDEV_STATE_PRESSED : LV_INDEV_STATE_RELEASED;
    
    // Передать данные в LVGL
    data->enc_diff = enc_data.enc_diff;
    data->state = enc_data.state;
    
    // Очистить счетчик при движении, чтобы избежать накопления
    if (enc_data.enc_diff != 0) {
        encoder_clear_count();
    }
}
```

### 4. Навигация по интерфейсу

Интерактивные элементы автоматически добавляются в группу энкодера:
- Кнопка настроек на главном экране
- Кнопка "Назад" на экране настроек

В [lvgl_main.c](file:///c%3A/esp/hydro/hydro1.0/components/lvgl_main/lvgl_main.c):
```c
// Добавить в группу энкодера для навигации
lvgl_encoder_add_obj(btn_settings);
```

LVGL автоматически обрабатывает навигацию:
- Вращение перемещает фокус между объектами
- Нажатие кнопки активирует выбранный элемент
- Циклическая навигация позволяет перемещаться по кругу

### 5. Интеграция с FreeRTOS

Приоритеты задач настроены для оптимальной производительности:
- Задача энкодера: Приоритет 10 (наивысший)
- Задача обновления дисплея: Приоритет 5
- Задача датчиков: Приоритет 3
- Задача таймера LVGL: Приоритет 7

Задача энкодера эффективно ждет событий в очереди без потребления CPU в режиме ожидания.

## Использование

### Добавление новых интерактивных элементов

Чтобы сделать новые элементы интерфейса доступными для навигации с помощью энкодера:

1. Создайте объект:
```c
lv_obj_t *my_button = lv_btn_create(screen);
```

2. Добавьте его в группу энкодера:
```c
lvgl_encoder_add_obj(my_button);
```

### Навигация по экранам

Энкодер предоставляет два типа ввода:
- Вращение: Перемещает фокус между элементами интерфейса
- Нажатие кнопки: Активирует элемент с фокусом

## Тестирование

Для проверки функциональности энкодера:
1. Поверните энкодер, чтобы переместить фокус между кнопкой настроек и кнопкой "Назад"
2. Нажмите кнопку энкодера для активации элемента с фокусом
3. Убедитесь, что переходы между экранами работают корректно

## Устранение неполадок

Распространенные проблемы и решения:

1. **Энкодер не отвечает**: Проверьте назначения GPIO-пинов и подключение
2. **Нестабильное поведение**: Увеличьте значение фильтра дребезга в драйвере энкодера
3. **Пропущенные события**: Увеличьте размер очереди в драйвере энкодера
4. **Интерфейс не обновляется**: Убедитесь, что объекты добавлены в группу энкодера

## Оптимизация производительности

- Задача энкодера использует минимальный CPU в режиме ожидания благодаря обработке событий через очередь
- Система ввода LVGL эффективно обрабатывает события энкодера
- Правильные приоритеты задач обеспечивают отзывчивый интерфейс