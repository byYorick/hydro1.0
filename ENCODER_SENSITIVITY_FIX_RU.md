# Исправление проблемы чувствительности энкодера в проекте гидропоники на ESP32-S3

## Описание проблемы

Вращательный энкодер генерировал 4 события на один физический оборот, что делало его чрезмерно чувствительным и трудным для использования в навигации по интерфейсу.

## Первоначальная причина

Вращательные энкодеры естественным образом производят несколько электрических переходов на каждый механический детент из-за их квадратурного кодирования. Без надлежащей фильтрации каждый из этих переходов интерпретируется как отдельное событие.

## Реализованное решение

### 1. Добавлена фильтрация подсчета в задачу энкодера

Изменен [components/encoder/encoder.c](file:///c%3A/esp/hydro/hydro1.0/components/encoder/encoder.c) для реализации фильтрации на основе подсчета:

```c
// Для фильтрации - генерировать события только каждые N отсчетов
static int32_t last_filtered_count = 0;
const int32_t COUNT_FILTER = 4; // Настройте это значение для изменения чувствительности (выше = менее чувствительно)

// Применить фильтрацию для снижения чувствительности
int32_t current_count = encoder_get_count();
int32_t count_diff = current_count - last_filtered_count;

// Генерировать события только при достаточной разнице в подсчетах
if (abs(count_diff) >= COUNT_FILTER) {
    // Обработать событие энкодера
    last_filtered_count = current_count;
}
```

### 2. Настраиваемая чувствительность

Чувствительность можно легко настроить, изменив значение `COUNT_FILTER`:
- Более высокие значения = Менее чувствительно (требуется больше физических поворотов для события)
- Более низкие значения = Более чувствительно (требуется меньше физических поворотов для события)
- Значение по умолчанию 4 уменьшает соотношение 4:1 до 1:1

### 3. Удалено логирование отладки из контекста ISR

Закомментировано логирование отладки в обратном вызове энкодера LVGL для предотвращения проблем, связанных с ISR:

```c
//ESP_LOGD(TAG, "Encoder diff: %ld, Button: %d", (long)enc_data.enc_diff, enc_data.state);
```

## Как это работает

1. Периферийный модуль PCNT по-прежнему подсчитывает все переходы энкодера для точности
2. Задача энкодера теперь фильтрует события на основе разницы накопленных отсчетов
3. Событие генерируется только при превышении разницы порогового значения (COUNT_FILTER)
4. Это эффективно группирует несколько переходов в одно логическое событие

## Тестирование исправления

Для проверки исправления:

1. Поверните энкодер на один полный детент/щелчок
2. Убедитесь, что генерируется только одно событие (вместо 4)
3. При необходимости настройте значение COUNT_FILTER для вашего конкретного энкодера

## Тонкая настройка чувствительности

Если энкодер все еще кажется слишком чувствительным или недостаточно чувствительным:

1. Увеличьте значение `COUNT_FILTER`, чтобы сделать его менее чувствительным
2. Уменьшите значение `COUNT_FILTER`, чтобы сделать его более чувствительным
3. Допустимый диапазон: 1-10 (1 = наиболее чувствительно, 10 = наименее чувствительно)

## Альтернативные решения

Для энкодеров с другими характеристиками рассмотрите:

1. **Аппаратные решения**: Используйте энкодеры со встроенным подавлением дребезга
2. **Программные решения**: Реализуйте временную фильтрацию в дополнение к фильтрации подсчета
3. **Конфигурация PCNT**: Настройте параметры обнаружения переходов PCNT для разных типов энкодеров

## Заключение

Это исправление предоставляет простое, но эффективное решение проблемы чувствительности энкодера путем реализации фильтрации на основе подсчета в задаче энкодера. Решение настраиваемо и сохраняет совместимость с существующей интеграцией LVGL.