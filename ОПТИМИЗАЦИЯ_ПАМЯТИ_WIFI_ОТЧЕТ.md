# üéØ –û–¢–ß–ï–¢: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è WiFi

**–î–∞—Ç–∞**: 16 –æ–∫—Ç—è–±—Ä—è 2025  
**–¶–µ–ª—å**: –û—Å–≤–æ–±–æ–¥–∏—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ DRAM –¥–ª—è —Ä–∞–±–æ—Ç—ã WiFi –Ω–∞ ESP32-S3  
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ **–£–°–ü–ï–®–ù–û** - WiFi –≤–∫–ª—é—á–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!

---

## üìä –ò–¢–û–ì–û–í–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò

### –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
- **–†–∞–∑–º–µ—Ä –ø—Ä–æ—à–∏–≤–∫–∏**: 1,327 KB (1.32 MB)
- **–î–æ—Å—Ç—É–ø–Ω–æ –≤ —Ä–∞–∑–¥–µ–ª–µ**: 3.83 MB
- **–°–≤–æ–±–æ–¥–Ω–æ**: 2,584 KB (**66%**)
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞

### –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏
- **–û–±—â–∞—è —ç–∫–æ–Ω–æ–º–∏—è DRAM**: **~16 KB**
- **–ú–µ—Ç–æ–¥**: –ü–µ—Ä–µ–Ω–æ—Å –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —Å DRAM –Ω–∞ PSRAM
- **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ**: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç–µ–∫–æ–≤ –∑–∞–¥–∞—á –∏ LVGL –±—É—Ñ–µ—Ä–æ–≤

---

## üîß –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

### 1. –ü–µ—Ä–µ–Ω–æ—Å –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ PSRAM ‚úÖ

#### data_logger.c
```c
// –ë—ã–ª–æ: static pid_log_entry_t g_pid_log_buffer[PID_LOG_BUFFER_SIZE]; // 8.6 KB DRAM
// –°—Ç–∞–ª–æ:
static pid_log_entry_t *g_pid_log_buffer = NULL;

// –í data_logger_init():
g_pid_log_buffer = heap_caps_calloc(
    PID_LOG_BUFFER_SIZE,
    sizeof(pid_log_entry_t),
    MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT
);
```
**–≠–∫–æ–Ω–æ–º–∏—è**: 8.6 KB DRAM

#### adaptive_pid.c
```c
// –ë—ã–ª–æ: static adaptive_pid_state_t g_states[PUMP_INDEX_COUNT]; // 3.0 KB
// –°—Ç–∞–ª–æ:
static adaptive_pid_state_t *g_states = NULL;

g_states = heap_caps_calloc(
    PUMP_INDEX_COUNT,
    sizeof(adaptive_pid_state_t),
    MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT
);
```
**–≠–∫–æ–Ω–æ–º–∏—è**: 3.0 KB DRAM

#### pid_auto_tuner.c
```c
// –ë—ã–ª–æ: static tuning_result_t g_results[PUMP_INDEX_COUNT]; // 1.8 KB
// –°—Ç–∞–ª–æ:
static tuning_result_t *g_results = NULL;

g_results = heap_caps_calloc(
    PUMP_INDEX_COUNT,
    sizeof(tuning_result_t),
    MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT
);
```
**–≠–∫–æ–Ω–æ–º–∏—è**: 1.8 KB DRAM

#### lvgl_ui.c
```c
// –ë—ã–ª–æ: static lv_coord_t sensor_history[6][60]; // 1.4 KB
// –°—Ç–∞–ª–æ:
static lv_coord_t *sensor_history = NULL;

sensor_history = heap_caps_calloc(
    SENSOR_COUNT * HISTORY_POINTS,
    sizeof(lv_coord_t),
    MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT
);
```
**–≠–∫–æ–Ω–æ–º–∏—è**: 1.4 KB DRAM

#### config_manager.c
```c
// –ë—ã–ª–æ: static system_config_t s_cached_config = {0}; // 1.2 KB
// –°—Ç–∞–ª–æ:
static system_config_t *s_cached_config = NULL;

s_cached_config = heap_caps_calloc(
    1,
    sizeof(system_config_t),
    MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT
);
```
**–≠–∫–æ–Ω–æ–º–∏—è**: 1.2 KB DRAM

#### app_main.c
```c
// –ë—ã–ª–æ: static system_config_t g_system_config = {0}; // 400 B
// –°—Ç–∞–ª–æ:
static system_config_t *g_system_config = NULL;

g_system_config = heap_caps_calloc(
    1,
    sizeof(system_config_t),
    MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT
);
```
**–≠–∫–æ–Ω–æ–º–∏—è**: 400 B DRAM

---

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç–µ–∫–æ–≤ –∑–∞–¥–∞—á ‚úÖ

**–§–∞–π–ª**: `main/system_config.h`

```c
// –ë—ã–ª–æ ‚Üí –°—Ç–∞–ª–æ (–≤ —Å–ª–æ–≤–∞—Ö, 1 —Å–ª–æ–≤–æ = 4 –±–∞–π—Ç–∞)
#define TASK_STACK_SIZE_DISPLAY     3072 ‚Üí 2816  // -1 KB
#define TASK_STACK_SIZE_ENCODER     2048 ‚Üí 1792  // -1 KB
```

**–≠–∫–æ–Ω–æ–º–∏—è**: ~2 KB DRAM

---

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è LVGL ‚úÖ

#### –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Å—Ç–µ–∫–∞ LVGL –∑–∞–¥–∞—á–∏
**–§–∞–π–ª**: `components/lcd_ili9341/lcd_ili9341.c`

```c
// –ë—ã–ª–æ: #define LVGL_TASK_STACK_SIZE   (32 * 1024)  // 32 KB
// –°—Ç–∞–ª–æ:
#define LVGL_TASK_STACK_SIZE   (24 * 1024)  // 24 KB
```

**–≠–∫–æ–Ω–æ–º–∏—è**: 8 KB DRAM

#### –£–º–µ–Ω—å—à–µ–Ω–∏–µ LVGL draw –±—É—Ñ–µ—Ä–æ–≤
```c
// –ë—ã–ª–æ: size_t draw_buffer_sz = LCD_H_RES * 20 * sizeof(lv_color16_t);  // 9.6 KB –∫–∞–∂–¥—ã–π
// –°—Ç–∞–ª–æ:
size_t draw_buffer_sz = LCD_H_RES * 15 * sizeof(lv_color16_t);  // 7.2 KB –∫–∞–∂–¥—ã–π
```

**–≠–∫–æ–Ω–æ–º–∏—è**: 4.8 KB DRAM (2 –±—É—Ñ–µ—Ä–∞)

---

## üìà –°–£–ú–ú–ê–†–ù–ê–Ø –≠–ö–û–ù–û–ú–ò–Ø DRAM

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –≠–∫–æ–Ω–æ–º–∏—è |
|-----------|----------|
| g_pid_log_buffer (data_logger) | **8.6 KB** |
| g_states (adaptive_pid) | **3.0 KB** |
| g_results (pid_auto_tuner) | **1.8 KB** |
| sensor_history (lvgl_ui) | **1.4 KB** |
| s_cached_config (config_manager) | **1.2 KB** |
| g_system_config (app_main) | **0.4 KB** |
| **–ò—Ç–æ–≥–æ (PSRAM –ø–µ—Ä–µ–Ω–æ—Å)** | **16.4 KB** |
| –°—Ç–µ–∫–∏ –∑–∞–¥–∞—á (Display, Encoder) | **~2.0 KB** |
| LVGL —Å—Ç–µ–∫ –∑–∞–¥–∞—á–∏ | **8.0 KB** |
| LVGL draw –±—É—Ñ–µ—Ä—ã | **4.8 KB** |
| **–û–ë–©–ê–Ø –≠–ö–û–ù–û–ú–ò–Ø** | **~31 KB DRAM** |

---

## ‚úÖ –í–ö–õ–Æ–ß–ï–ù–ò–ï WiFi

**–§–∞–π–ª**: `main/app_main.c`

```c
// –ë—ã–ª–æ: WiFi –û–¢–ö–õ–Æ–ß–ï–ù –∏–∑-–∑–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∏ DRAM
/*
ret = network_manager_init();
...
*/

// –°—Ç–∞–ª–æ: WiFi –í–ö–õ–Æ–ß–ï–ù –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
ret = network_manager_init();
if (ret != ESP_OK) {
    ESP_LOGW(TAG, "  [WARN] Network Manager initialization failed: %s", esp_err_to_name(ret));
} else {
    ESP_LOGI(TAG, "  [OK] Network Manager initialized");
    network_manager_load_and_connect();
}
```

---

## üîç –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –û–®–ò–ë–ö–ò –ü–†–ò –°–ë–û–†–ö–ï

### 1. –û—à–∏–±–∫–∞ –≤ `data_logger.c`
**–ü—Ä–æ–±–ª–µ–º–∞**: `g_pid_log_buffer` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –¥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è  
**–†–µ—à–µ–Ω–∏–µ**: –ü–µ—Ä–µ–º–µ—â–µ–Ω—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è `pid_log_entry_t`, `PID_LOG_BUFFER_SIZE` –∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —É–∫–∞–∑–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ —Ñ—É–Ω–∫—Ü–∏–µ–π `data_logger_init()`

### 2. –û—à–∏–±–∫–∞ –≤ `config_manager.c`
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —É–∫–∞–∑–∞—Ç–µ–ª—é (`s_cached_config = *config`)  
**–†–µ—à–µ–Ω–∏–µ**: –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `memcpy(s_cached_config, config, sizeof(system_config_t))`

### 3. –û—à–∏–±–∫–∞ –≤ `adaptive_pid.c`, `pid_auto_tuner.c`
**–ü—Ä–æ–±–ª–µ–º–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —É–∫–∞–∑–∞—Ç–µ–ª–µ–π  
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –æ –ø–µ—Ä–µ–Ω–æ—Å–µ –Ω–∞ PSRAM

### 4. –û—à–∏–±–∫–∞ –≤ `lvgl_ui.c`
**–ü—Ä–æ–±–ª–µ–º–∞**: 2D –º–∞—Å—Å–∏–≤ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —É–∫–∞–∑–∞—Ç–µ–ª—å, –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞  
**–†–µ—à–µ–Ω–∏–µ**: –ò–∑–º–µ–Ω–µ–Ω–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Å `sensor_history[i][j]` –Ω–∞ `sensor_history[i * HISTORY_POINTS + j]`

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. **–ü—Ä–æ—à–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ**:
   ```bash
   c:\Users\admin\2\hydro1.0\free_com5.bat
   idf.py -p COM5 flash monitor
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö**:
   - ‚úÖ `Network Manager initialized`
   - ‚úÖ `WiFi initialized successfully`
   - ‚úÖ `Allocated in PSRAM: XXX bytes` (–¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞)
   - ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫ –ø–∞–º—è—Ç–∏ (`ESP_ERR_NO_MEM`)
   - ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ watchdog timeouts

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**:
   - WiFi —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–µ–π
   - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WiFi
   - –†–∞–±–æ—Ç–∞ UI –±–µ–∑ –∑–∞–º–µ–¥–ª–µ–Ω–∏–π
   - –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã (24+ —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã)

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏**:
   ```c
   ESP_LOGI("MEMORY", "Free DRAM: %d bytes", heap_caps_get_free_size(MALLOC_CAP_INTERNAL));
   ESP_LOGI("MEMORY", "Free PSRAM: %d bytes", heap_caps_get_free_size(MALLOC_CAP_SPIRAM));
   ```

---

## üìù –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

### 1. PSRAM vs DRAM
- **PSRAM**: –ú–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ ~8 MB –¥–æ—Å—Ç—É–ø–Ω–æ
- **DRAM**: –ë—ã—Å—Ç—Ä–µ–µ, –Ω–æ —Ç–æ–ª—å–∫–æ ~328 KB
- **–†–µ—à–µ–Ω–∏–µ**: –ù–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ/—Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Üí PSRAM

### 2. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- LVGL –±—É—Ñ–µ—Ä—ã –æ—Å—Ç–∞–ª–∏—Å—å –≤ DRAM (—á–µ—Ä–µ–∑ `spi_bus_dma_memory_alloc`)
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –Ω–∞ PSRAM (—Ä–µ–¥–∫–æ —á–∏—Ç–∞—é—Ç—Å—è)
- –ò—Å—Ç–æ—Ä–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –Ω–∞ PSRAM (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞ –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏)

### 3. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- –í—Å–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ NULL
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è PSRAM ‚Üí –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- Graceful degradation –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ (sensor_history)

---

## üöÄ –†–ï–ó–£–õ–¨–¢–ê–¢

### –î–û –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚ùå WiFi –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ DRAM)
- ‚ùå `ESP_ERR_NO_MEM` –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DRAM: ~95%

### –ü–û–°–õ–ï –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚úÖ WiFi –≤–∫–ª—é—á–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞ (66% —Å–≤–æ–±–æ–¥–Ω–æ –≤ flash)
- ‚úÖ DRAM –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ: ~31 KB
- ‚úÖ –ë–æ–ª—å—à–∏–µ –æ–±—ä–µ–∫—Ç—ã –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –Ω–∞ PSRAM
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å—Ç–µ–∫–∏ –∑–∞–¥–∞—á

---

## üìö –°–í–Ø–ó–ê–ù–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´

- `–§–ò–ù–ê–õ–¨–ù–´–ô_–ê–£–î–ò–¢_–ü–ê–ú–Ø–¢–ò.md` - –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–∞–º—è—Ç–∏
- `–ò–ù–°–¢–†–£–ö–¶–ò–Ø_–î–õ–Ø_–ò–ò.md` - –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- `NETWORK_MANAGER_IMPLEMENTATION_REPORT.md` - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è WiFi

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ì–û–¢–û–í–û –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ**  
**WiFi**: ‚úÖ **–í–ö–õ–Æ–ß–ï–ù**  
**–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: ‚è≥ **–¢–†–ï–ë–£–ï–¢–°–Ø –ü–†–û–í–ï–†–ö–ê**

–£—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω **–ü–ª–∞–Ω –ê** (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è) –∏–∑ –∞—É–¥–∏—Ç–∞ –ø–∞–º—è—Ç–∏! üéâ

