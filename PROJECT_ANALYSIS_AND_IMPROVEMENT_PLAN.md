# Анализ проекта и план доработки

## 1. Обзор текущей архитектуры

Система построена вокруг главной точки входа `app_main`, которая последовательно инициализирует память NVS, аппаратные драйверы, датчики, насосы, подсистемы и FreeRTOS-задачи, обеспечивая модульную структуру запуска.【F:main/app_main.c†L1-L200】

Управление многозадачностью выделено в компонент `system_tasks`: здесь создаются очереди, мьютексы и шесть основных задач (sensor, display, notification, data_logger, scheduler, ph_ec), а также фиксируется, что задача энкодера создаётся отдельно в UI-подсистеме.【F:components/system_tasks/system_tasks.c†L63-L176】

Централизованная конфигурация аппаратных пинов, параметров задач и целевых значений сенсоров сосредоточена в `system_config.h`, что облегчает поддержку оборудования и настроек по умолчанию.【F:main/system_config.h†L1-L205】

При чтении датчиков система формирует структуру `sensor_data`, защищая её мьютексом и публикуя значения в очередь для отображения, одновременно обновляя контроллер pH/EC. Для неудачных чтений применяются значения по умолчанию, что предотвращает пропуски данных в интерфейсе.【F:components/system_tasks/system_tasks.c†L192-L386】【F:main/system_config.h†L142-L203】

## 2. Сильные стороны

- **Ясная последовательность инициализации.** `app_main` разбит на этапы с явной проверкой ошибок и логированием, что упрощает диагностику и расширение системы.【F:main/app_main.c†L140-L200】
- **Выделенный менеджер задач.** `system_tasks` инкапсулирует создание задач, синхронизацию и остановку, предоставляя единый API для обслуживания многозадачности.【F:components/system_tasks/system_tasks.c†L63-L400】【F:components/system_tasks/system_tasks.h†L25-L118】
- **Централизация конфигурации.** `system_config.h` содержит сведения о пинах, приоритетах, интервалах и целевых значениях датчиков, что снижает риск конфликтов оборудования.【F:main/system_config.h†L21-L205】
- **Устойчивость к сбоям датчиков.** При неудачных чтениях система подставляет значения по умолчанию и продолжает работу контроллера и UI, что особенно важно для непрерывного мониторинга.【F:components/system_tasks/system_tasks.c†L331-L386】【F:main/system_config.h†L142-L203】

## 3. Ключевые зоны риска и точки роста

1. **Незавершённый менеджер конфигурации.** Заглушки `config_manager_init/load/save` пока не реализуют хранение пользовательских параметров, из-за чего любые изменения настроек исчезнут после перезагрузки.【F:components/config_manager/config_manager.h†L7-L10】
2. **Отключённая задача логирования.** `data_logger_task` немедленно завершает работу ради экономии памяти, что лишает систему возможности автономного сбора исторических данных и аналитики.【F:components/system_tasks/system_tasks.c†L261-L266】
3. **Локальный тест без инфраструктуры.** Дополнительный `CMakeLists_test.txt` подключает лишь тестовое приложение LCD, однако отсутствуют модульные или интеграционные тесты для бизнес-логики, что затрудняет регрессионный контроль.【F:main/CMakeLists_test.txt†L1-L11】
4. **Поведение при сбоях датчиков.** Подстановка фиксированных «здоровых» значений маскирует реальные аварии; нет накопления статистики или уведомлений о длительной деградации, что усложняет эксплуатационный контроль.【F:components/system_tasks/system_tasks.c†L331-L386】
5. **Сильная зависимость от глобальных структур.** Хотя доступ к `sensor_data` защищён, другие подсистемы (например, pH/EC контроллер) используют глобальные функции без явного контроля жизненного цикла, что усложняет тестирование и возможную симуляцию оборудования.【F:components/system_tasks/system_tasks.c†L192-L290】

## 4. План развития и улучшений

### 4.1. Краткосрочные задачи (1–2 итерации)
- Реализовать `config_manager` с сохранением конфигурации в NVS (целевые значения pH/EC, расписания, параметры уведомлений). Предусмотреть миграции настроек и защиту от повреждения памяти.【F:components/config_manager/config_manager.h†L7-L10】
- Оптимизировать потребление памяти и заново включить `data_logger_task`, сократив размер буферов и используя ленивую запись в NVS/SD, чтобы восстановить журналирование событий.【F:components/system_tasks/system_tasks.c†L261-L266】
- Добавить уведомления о длительной недоступности датчика: при использовании запасных значений счётчик ошибок должен попадать в очередь уведомлений и журнал, чтобы оператор понимал о проблеме оборудования.【F:components/system_tasks/system_tasks.c†L331-L386】

### 4.2. Среднесрочные задачи (3–5 итераций)
- Выделить интерфейсы для сенсоров и исполнительных устройств, позволяющие внедрять программные симуляторы и писать модульные тесты без железа. Подготовить набор аппаратно-независимых тестов (Unity/ceedling) и интеграционных тестов на эмуляторе ESP-IDF, подключив их к `main/CMakeLists_test.txt`.【F:main/CMakeLists_test.txt†L1-L11】【F:components/system_tasks/system_tasks.c†L192-L386】
- Расширить `system_tasks` статистикой загрузки (время выполнения, пропуски циклов) и watchdog-триггерами, чтобы заранее обнаруживать зависания задач с повышенными приоритетами.【F:components/system_tasks/system_tasks.c†L63-L290】
- Разработать UI-экраны диагностики: отображение состояния датчиков, числа сбоев, текущих настроек насосов, используя уже существующие очереди и обновление интерфейса в `display_task`.【F:components/system_tasks/system_tasks.c†L217-L245】

### 4.3. Долгосрочные задачи (6+ итераций)
- Ввести адаптивные алгоритмы дозирования pH/EC на основе логов и исторических данных, хранящихся логгером, для уменьшения перерегулирования и повышения стабильности раствора.【F:components/system_tasks/system_tasks.c†L219-L290】
- Интегрировать удалённый мониторинг (MQTT/HTTP API) с учётом централизованной конфигурации пинов и задач, чтобы предоставлять оператору телеметрию и удалённое управление без изменения существующей архитектуры.【F:main/system_config.h†L21-L205】【F:components/system_tasks/system_tasks.c†L63-L400】
- Подготовить автоматизированные процедуры калибровки сенсоров и насосов, используя сохранение параметров через реализованный `config_manager`, а также расширить хранение в логе калибровочных действий для прослеживаемости.【F:components/config_manager/config_manager.h†L7-L10】【F:components/system_tasks/system_tasks.c†L331-L386】

## 5. Следующие шаги

1. Согласовать с командой критичность восстановления логирования и постоянного хранилища конфигурации, определить требования по объёму данных.
2. Оценить текущий расход памяти и стеков задач, чтобы подобрать оптимизацию под включение логгера и будущих тестовых хуков.
3. Сформировать дорожную карту внедрения тестов: выбрать фреймворк, описать минимальный набор сценариев (например, проверка циклов контроля pH/EC при имитации отказов датчиков).

Реализация предложенного плана позволит довести проект до промышленной готовности: система станет надёжнее, появится прозрачная диагностика и автоматическая проверка регрессий, а также база для дальнейшего расширения (удалённый мониторинг, аналитика, адаптивный контроль).
