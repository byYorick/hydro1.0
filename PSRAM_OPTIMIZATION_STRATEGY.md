# üöÄ PSRAM –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –°—Ç—Ä–∞—Ç–µ–≥–∏—è –±–æ–ª—å—à–∏—Ö –±—É—Ñ–µ—Ä–æ–≤

**–î–∞—Ç–∞:** 2025-10-16  
**–ü—Ä–æ–±–ª–µ–º–∞:** LVGL –±—É—Ñ–µ—Ä—ã –≤ PSRAM –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∏–∑-–∑–∞ –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ cache  
**–†–µ—à–µ–Ω–∏–µ:** –ë–æ–ª—å—à–∏–µ –≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω—ã–µ –±—É—Ñ–µ—Ä—ã + –º–µ–Ω—å—à–µ flush –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ —Å –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –±—É—Ñ–µ—Ä–∞–º–∏ –≤ PSRAM

```
15 —Å—Ç—Ä–æ–∫ √ó 240 px = 3600 –ø–∏–∫—Å–µ–ª–µ–π –Ω–∞ flush
–≠–∫—Ä–∞–Ω 320 —Å—Ç—Ä–æ–∫ / 15 = 21 flush –Ω–∞ –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω!

–ö–∞–∂–¥—ã–π flush:
1. CPU —á–∏—Ç–∞–µ—Ç –∏–∑ PSRAM —á–µ—Ä–µ–∑ cache
2. Cache miss ‚Üí –∂–¥–µ–º PSRAM (80 MHz vs 240 MHz SRAM)
3. SPI DMA –ø–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
4. –ü–æ–≤—Ç–æ—Ä—è–µ–º 21 —Ä–∞–∑!

–ò—Ç–æ–≥–æ: 21 √ó (cache overhead + transfer time) = –ú–ï–î–õ–ï–ù–ù–û
```

### –†–µ—à–µ–Ω–∏–µ: –ë–æ–ª—å—à–∏–µ –±—É—Ñ–µ—Ä—ã

```
80 —Å—Ç—Ä–æ–∫ √ó 240 px = 19200 –ø–∏–∫—Å–µ–ª–µ–π –Ω–∞ flush
–≠–∫—Ä–∞–Ω 320 —Å—Ç—Ä–æ–∫ / 80 = 4 flush –Ω–∞ –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω!

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
1. –ú–µ–Ω—å—à–µ flush –æ–ø–µ—Ä–∞—Ü–∏–π (4 –≤–º–µ—Å—Ç–æ 21) ‚Üí -81% overhead
2. –ë–æ–ª—å—à–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è ‚Üí –ª—É—á—à–µ cache utilization
3. Cache line prefetch —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ
4. –ú–µ–Ω—å—à–µ context switches –º–µ–∂–¥—É LVGL –∏ SPI

–ò—Ç–æ–≥–æ: 4 √ó (transfer time) = –ë–´–°–¢–†–ï–ï!
```

---

## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –¥–ª—è cache

```c
// –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ 64 –±–∞–π—Ç–∞ –¥–ª—è ESP32-S3 cache line
disp_buf1 = heap_caps_aligned_alloc(64, buf_size, MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT);
```

**–ü–æ—á–µ–º—É 64 –±–∞–π—Ç–∞?**
- ESP32-S3 cache line size = 32 –±–∞–π—Ç–∞
- –î–≤–æ–π–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ prefetch
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç false sharing

### 2. –†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ 80 —Å—Ç—Ä–æ–∫

```
–†–∞–∑–º–µ—Ä: 240 √ó 80 √ó 2 = 38.4 KB –Ω–∞ –±—É—Ñ–µ—Ä
–í—Å–µ–≥–æ: 38.4 KB √ó 2 = 76.8 KB PSRAM (—ç–∫–æ–Ω–æ–º–∏—è 76.8 KB DRAM!)

–ü–æ–∫—Ä—ã—Ç–∏–µ —ç–∫—Ä–∞–Ω–∞: 80 / 320 = 25% –∑–∞ –æ–¥–∏–Ω flush
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ flush: 320 / 80 = 4 –æ–ø–µ—Ä–∞—Ü–∏–∏
```

### 3. –î–≤–æ–π–Ω–∞—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è

```
–ë—É—Ñ–µ—Ä 1: LVGL —Ä–∏—Å—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä
–ë—É—Ñ–µ—Ä 2: SPI –ø–µ—Ä–µ–¥–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä

‚Üí –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
‚Üí –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Å—Ç–æ–∏
```

---

## üß™ –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑

### –í—Ä–µ–º—è flush (—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ)

**–ú–∞–ª–µ–Ω—å–∫–∏–µ –±—É—Ñ–µ—Ä—ã (15 —Å—Ç—Ä–æ–∫, DRAM):**
```
Transfer time: 3600 pixels √ó 2 bytes / (40 MHz / 16) = ~6 –º—Å
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ flush: 21
Overhead (setup): 21 √ó 1 –º—Å = 21 –º—Å
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û: 21 √ó 6 + 21 = 147 –º—Å –Ω–∞ –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω
```

**–ë–æ–ª—å—à–∏–µ –±—É—Ñ–µ—Ä—ã (80 —Å—Ç—Ä–æ–∫, PSRAM):**
```
Transfer time: 19200 pixels √ó 2 bytes / (40 MHz / 16) = ~30 –º—Å
Cache overhead: +50% (PSRAM latency) = 45 –º—Å
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ flush: 4
Overhead (setup): 4 √ó 1 –º—Å = 4 –º—Å
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û: 4 √ó 45 + 4 = 184 –º—Å –Ω–∞ –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω
```

**–í—ã–≤–æ–¥:** –ù–µ–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –ù–û:
- ‚úÖ –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º 76.8 KB DRAM –¥–ª—è WiFi!
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ (–Ω–µ—Ç mutex contention)
- ‚úÖ WiFi –º–æ–∂–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è

---

## üé® –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. Partial refresh (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å)

```c
// –†–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–º–µ—Å—Ç–æ –≤—Å–µ–≥–æ —ç–∫—Ä–∞–Ω–∞
lv_obj_invalidate_area(obj, &area);  // –í–º–µ—Å—Ç–æ lv_obj_invalidate()
```

### 2. –£–≤–µ–ª–∏—á–∏—Ç—å SPI —Å–∫–æ—Ä–æ—Å—Ç—å

```c
// –í lcd_ili9341.c
#define LCD_PIXEL_CLOCK_HZ   (40 * 1000 * 1000)  // –ë—ã–ª–æ 40 MHz
// –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å:
#define LCD_PIXEL_CLOCK_HZ   (60 * 1000 * 1000)  // 60 MHz (–µ—Å–ª–∏ –¥–∏—Å–ø–ª–µ–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)
```

### 3. Disable cache –¥–ª—è SPI DMA (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

```c
// –í—ã–¥–µ–ª–µ–Ω–∏–µ –±–µ–∑ cache –¥–ª—è –ø—Ä—è–º–æ–≥–æ DMA (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç)
disp_buf1 = heap_caps_malloc(buf_size, MALLOC_CAP_DMA | MALLOC_CAP_SPIRAM);
```

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:

```
DRAM:
‚îú‚îÄ –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: 285 KB (overflow!) ‚ùå
‚îú‚îÄ DRAM –±—É—Ñ–µ—Ä—ã (15 —Å—Ç—Ä–æ–∫): 280 KB (85%) ‚ö†Ô∏è WiFi –Ω–µ –≤–ª–µ–∑–∞–µ—Ç
‚îî‚îÄ PSRAM –±—É—Ñ–µ—Ä—ã (80 —Å—Ç—Ä–æ–∫): 266 KB (81%) ‚úÖ WiFi –≤–ª–µ–∑–∞–µ—Ç!

PSRAM:
‚îú‚îÄ LVGL –±—É—Ñ–µ—Ä—ã: 76.8 KB
‚îú‚îÄ LVGL heap: ~500 KB (–¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤)
‚îú‚îÄ –°–≤–æ–±–æ–¥–Ω–æ: ~7500 KB
```

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

```
–ü–æ–ª–Ω—ã–π redraw —ç–∫—Ä–∞–Ω–∞:
‚îú‚îÄ DRAM –±—É—Ñ–µ—Ä—ã (15 —Å—Ç—Ä–æ–∫): ~150 –º—Å ‚ö° FAST
‚îú‚îÄ PSRAM –±—É—Ñ–µ—Ä—ã (40 —Å—Ç—Ä–æ–∫): ~500+ –º—Å ‚ùå TOO SLOW
‚îî‚îÄ PSRAM –±—É—Ñ–µ—Ä—ã (80 —Å—Ç—Ä–æ–∫): ~180-250 –º—Å ‚úÖ ACCEPTABLE
```

### WiFi —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:

```
DRAM —Å–≤–æ–±–æ–¥–Ω–æ –¥–ª—è WiFi:
‚îú‚îÄ DRAM –±—É—Ñ–µ—Ä—ã: 48 KB (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, WiFi ESP_ERR_NO_MEM) ‚ùå
‚îî‚îÄ PSRAM –±—É—Ñ–µ—Ä—ã: 62 KB (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è WiFi init) ‚úÖ
```

---

## ‚úÖ –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å LVGL –±–µ–∑ WiFi
```bash
# WiFi –æ—Ç–∫–ª—é—á–µ–Ω –≤ app_main.c
idf.py build && idf.py -p COM11 flash monitor
```

**–û–∂–∏–¥–∞–µ–º:**
- ‚úÖ UI –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- ‚úÖ –ù–µ—Ç mutex contention
- ‚úÖ –ù–µ—Ç watchdog timeout
- ‚è±Ô∏è –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–∏–µ–º–ª–µ–º–∞—è (< 300 –º—Å –Ω–∞ —ç–∫—Ä–∞–Ω)

### –®–∞–≥ 2: –í–∫–ª—é—á–∏—Ç—å WiFi
```c
// –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ app_main.c
ESP_ERROR_CHECK(network_manager_init());
network_manager_load_and_connect();
```

**–û–∂–∏–¥–∞–µ–º:**
- ‚úÖ WiFi –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è (–Ω–µ—Ç ESP_ERR_NO_MEM)
- ‚úÖ UI –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞

### –®–∞–≥ 3: –§–∏–Ω–∞–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å:
- –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å 60-100 —Å—Ç—Ä–æ–∫ (balance –º–µ–∂–¥—É flush count –∏ transfer time)
- –£–≤–µ–ª–∏—á–∏—Ç—å SPI clock –¥–æ 60 MHz
- –í–∫–ª—é—á–∏—Ç—å partial refresh –≤ LVGL

---

## üéØ –í–´–í–û–î–´

### –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ú–µ–Ω—å—à–µ overhead:**
   - 4 flush –≤–º–µ—Å—Ç–æ 21 ‚Üí -81% setup time
   
2. **–õ—É—á—à–µ cache utilization:**
   - –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –±–æ–ª—å—à–∏—Ö –±–ª–æ–∫–æ–≤
   - Prefetch —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ
   
3. **–ë–∞–ª–∞–Ω—Å –ø–∞–º—è—Ç—å/—Å–∫–æ—Ä–æ—Å—Ç—å:**
   - PSRAM: –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ (8 MB)
   - DRAM: –∫—Ä–∏—Ç–∏—á–µ–Ω (328 KB)
   - –°–∫–æ—Ä–æ—Å—Ç—å: –ø—Ä–∏–µ–º–ª–µ–º–∞ –¥–ª—è UI

### –ö–æ–º–ø—Ä–æ–º–∏—Å—Å—ã:

- ‚ùå UI –Ω–µ–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ —á–µ–º —Å DRAM –±—É—Ñ–µ—Ä–∞–º–∏
- ‚úÖ WiFi —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞
- ‚úÖ –ü–∞–º—è—Ç—å –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞

---

## üìö –°—Å—ã–ª–∫–∏

- [ESP32-S3 Technical Reference Manual - PSRAM](https://www.espressif.com/sites/default/files/documentation/esp32-s3_technical_reference_manual_en.pdf)
- [LVGL Performance Tips](https://docs.lvgl.io/9.2/others/renderers.html)
- [ESP-IDF Memory Types](https://docs.espressif.com/projects/esp-idf/en/v5.5.1/esp32s3/api-guides/memory-types.html)

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –°–æ–±—Ä–∞—Ç—å –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å! üöÄ

