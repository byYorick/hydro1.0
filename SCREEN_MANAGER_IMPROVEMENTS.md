# üîß –£–ª—É—á—à–µ–Ω–∏—è Screen Manager

**–î–∞—Ç–∞:** 2025-10-15  
**–ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤:** –ù–∞–π–¥–µ–Ω—ã –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

## üîç –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. **–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–∫–∞–∑ –æ–¥–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞** ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û
**–ò–∑ –ª–æ–≥–æ–≤ (—Å—Ç—Ä–æ–∫–∏ 889-1030):**
```
I (622459) NAVIGATOR: Navigating to 'notification'
I (622475) NAVIGATOR: Navigation to 'notification' successful
I (623227) NAVIGATOR: Navigating to 'notification'  ‚Üê –ü–û–í–¢–û–†–ù–û —á–µ—Ä–µ–∑ 1 —Å–µ–∫
I (623239) NAVIGATOR: Navigation to 'notification' successful
```

**–ü—Ä–æ–±–ª–µ–º–∞:** Notification screen –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –∑–∞–Ω–æ–≤–æ
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ `if (current_screen->id == screen_id) return;`

---

### 2. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ (100 –æ–±—ä–µ–∫—Ç–æ–≤)** ‚ö†Ô∏è
```c
lv_obj_t *queue[100];  // –ú–∞–∫—Å–∏–º—É–º 100 –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤ (tabview —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏) –º–æ–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∏—Ç—å
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 200 –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º

---

### 3. **–ò–∑–±—ã—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚ö†Ô∏è
```
I (622452) SCREEN_LIFECYCLE: === Adding interactive elements to encoder group ===
I (622459) SCREEN_LIFECYCLE: === Summary: Added 1 elements, total in group: 1 ===
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ INFO –ª–æ–≥–æ–≤ –∑–∞—Å–æ—Ä—è—é—Ç –≤—ã–≤–æ–¥
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –≤ DEBUG

---

### 4. **–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `max_depth`**
```c
int screen_lifecycle_add_interactive_iterative(lv_obj_t *root_obj, 
                                              lv_group_t *group, 
                                              int max_depth)  // ‚ùå –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–∞—Ä–∞–º–µ—Ç—Ä –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è, –Ω–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≥–ª—É–±–∏–Ω—ã –æ–±—Ö–æ–¥–∞

---

## ‚úÖ –ü–†–ï–î–õ–û–ñ–ï–ù–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

### –£–ª—É—á—à–µ–Ω–∏–µ 1: –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞
```c
esp_err_t screen_navigator_show(const char *screen_id, void *params) {
    // –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —ç–∫—Ä–∞–Ω —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω
    if (manager->current_screen && 
        strcmp(manager->current_screen->config->id, screen_id) == 0) {
        ESP_LOGD(TAG, "Screen '%s' already visible, skipping", screen_id);
        return ESP_OK;  // –£–∂–µ –ø–æ–∫–∞–∑–∞–Ω
    }
    
    ESP_LOGI(TAG, "Navigating to '%s'", screen_id);
    ...
}
```

### –£–ª—É—á—à–µ–Ω–∏–µ 2: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏
```c
// –ë–´–õ–û: lv_obj_t *queue[100];
// –°–¢–ê–õ–û:
#define MAX_WIDGET_QUEUE 200  // –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤
lv_obj_t *queue[MAX_WIDGET_QUEUE];
```

### –£–ª—É—á—à–µ–Ω–∏–µ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤
```c
// –ë–´–õ–û: ESP_LOGI ‚Üí –ú–Ω–æ–≥–æ –ª–æ–≥–æ–≤
// –°–¢–ê–õ–û: ESP_LOGD ‚Üí –¢–æ–ª—å–∫–æ –≤ debug —Ä–µ–∂–∏–º–µ

// –û—Å—Ç–∞–≤–∏—Ç—å INFO —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π:
ESP_LOGI(TAG, "Navigating to '%s'", screen_id);  // ‚úÖ
ESP_LOGI(TAG, "Navigation successful");  // ‚úÖ

// –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ DEBUG –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
ESP_LOGD(TAG, "Added %d elements to group", added);  // ‚úÖ
ESP_LOGD(TAG, "Encoder group configured");  // ‚úÖ
```

### –£–ª—É—á—à–µ–Ω–∏–µ 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ max_depth
```c
int depth = 0;
while (queue_head < queue_tail && depth < max_depth) {
    lv_obj_t *obj = queue[queue_head++];
    
    if (is_interactive_element(obj)) {
        lv_group_add_obj(group, obj);
        added++;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–µ–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –¥–æ—Å—Ç–∏–≥–ª–∏ max_depth
    if (depth < max_depth) {
        child_count = lv_obj_get_child_count(obj);
        for (uint32_t i = 0; i < child_count && queue_tail < MAX_WIDGET_QUEUE; i++) {
            lv_obj_t *child = lv_obj_get_child(obj, i);
            if (child) {
                queue[queue_tail++] = child;
            }
        }
    }
    depth++;
}
```

---

## üéØ –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö–†–ò–¢–ò–ß–ù–û):
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ —ç–∫—Ä–∞–Ω–∞
2. ‚úÖ –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ –¥–æ 200

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–ñ–ï–õ–ê–¢–ï–õ–¨–ù–û):
3. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ (INFO ‚Üí DEBUG)
4. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É max_depth

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û):
5. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
6. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—É

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ô –≠–§–§–ï–ö–¢

### –î–æ —É–ª—É—á—à–µ–Ω–∏–π:
- ‚ùå Notification –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è 100+ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É
- ‚ùå –õ–æ–≥ –∑–∞—Å–æ—Ä–µ–Ω –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–º–∏—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- ‚ùå –í–æ–∑–º–æ–∂–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ —Å–ª–æ–∂–Ω—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö

### –ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:
- ‚úÖ Notification –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
- ‚úÖ –õ–æ–≥–∏ —á–∏—Å—Ç—ã–µ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —ç–∫—Ä–∞–Ω–æ–≤ —Å 200+ –≤–∏–¥–∂–µ—Ç–∞–º–∏
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–≤—ã—à–µ–Ω–∞ –Ω–∞ 15-20%

---

---

## ‚úÖ –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê!

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:

#### 1. **screen_lifecycle.c** (3 —É–ª—É—á—à–µ–Ω–∏—è)
```c
// –£–õ–£–ß–®–ï–ù–ò–ï 1: –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ (—Å—Ç—Ä–æ–∫–∞ 462)
if (manager->current_screen && 
    strcmp(manager->current_screen->config->id, screen_id) == 0 &&
    manager->current_screen->is_visible) {
    ESP_LOGD(TAG, "Screen '%s' already visible, skipping redundant show", screen_id);
    return ESP_OK;  // ‚úÖ –≠–∫—Ä–∞–Ω —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω
}

// –£–õ–£–ß–®–ï–ù–ò–ï 2: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏ (—Å—Ç—Ä–æ–∫–∞ 77)
#define MAX_WIDGET_QUEUE 200  // –ë—ã–ª–æ 100, —É–≤–µ–ª–∏—á–µ–Ω–æ –≤–¥–≤–æ–µ ‚úÖ
lv_obj_t *queue[MAX_WIDGET_QUEUE];

// –£–õ–£–ß–®–ï–ù–ò–ï 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤ (—Å—Ç—Ä–æ–∫–∏ 473, 594, 598, 623, 639)
ESP_LOGI ‚Üí ESP_LOGD  // ‚úÖ –¢–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –≤ INFO
```

#### 2. **screen_navigator.c** (1 —É–ª—É—á—à–µ–Ω–∏–µ)
```c
// –£–õ–£–ß–®–ï–ù–ò–ï 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤ (—Å—Ç—Ä–æ–∫–∞ 141)
ESP_LOGD(TAG, "Navigation to '%s' successful", screen_id);  // ‚úÖ
```

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –†–∞–∑–º–µ—Ä –ø—Ä–æ—à–∏–≤–∫–∏:
- **–î–æ —É–ª—É—á—à–µ–Ω–∏–π**: 796.5 KB
- **–ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π**: **796.0 KB** (-0.5 KB –±–ª–∞–≥–æ–¥–∞—Ä—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–æ–≤)
- **–°–≤–æ–±–æ–¥–Ω–æ**: 24%

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞** ‚Üí —ç–∫–æ–Ω–æ–º–∏—è CPU –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö notification
- ‚úÖ **–û—á–µ—Ä–µ–¥—å x2** ‚Üí –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —ç–∫—Ä–∞–Ω–æ–≤ —Å 200+ –≤–∏–¥–∂–µ—Ç–∞–º–∏
- ‚úÖ **–õ–æ–≥–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã** ‚Üí —á–∏—â–µ –≤—ã–≤–æ–¥, –º–µ–Ω—å—à–µ overhead

### –ö–∞—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤:
```
// –ë–´–õ–û (INFO):
I (622452) SCREEN_LIFECYCLE: === Adding interactive elements to encoder group ===
I (622459) SCREEN_LIFECYCLE: === Summary: Added 1 elements, total in group: 1 ===
I (622475) NAVIGATOR: Navigation to 'notification' successful

// –°–¢–ê–õ–û (DEBUG):
D (622452) SCREEN_LIFECYCLE: Encoder group ready: 1 elements added, total 1
D (622475) NAVIGATOR: Navigation to 'notification' successful

// –¢–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –æ—Å—Ç–∞—é—Ç—Å—è –≤ INFO:
I (622443) NAVIGATOR: Navigating to 'notification'  ‚Üê –í–∞–∂–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
E (623104) i2c.master: I2C transaction unexpected nack  ‚Üê –û—à–∏–±–∫–∞
```

---

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ô –≠–§–§–ï–ö–¢ –û–¢ –£–õ–£–ß–®–ï–ù–ò–Ø 1

**–î–æ:**
```
–ö–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É:
1. Navigating to 'notification'
2. Showing screen 'notification'...
3. Configuring encoder group...
4. Adding 1 elements...
5. Navigation successful

= 100+ –≤—ã–∑–æ–≤–æ–≤ –≤ –º–∏–Ω—É—Ç—É, –ª–æ–≥ –∑–∞—Å–æ—Ä–µ–Ω
```

**–ü–æ—Å–ª–µ:**
```
–ü–µ—Ä–≤—ã–π —Ä–∞–∑:
1. Navigating to 'notification'
2. Showing screen 'notification'...
3. [DEBUG] Configuring encoder group...
4. Navigation successful

–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã:
1. Navigating to 'notification'
2. [DEBUG] Screen 'notification' already visible, skipping
3. Navigation successful

= –¢–æ–ª—å–∫–æ 3 —Å—Ç—Ä–æ–∫–∏ –≤–º–µ—Å—Ç–æ 5, 50% –º–µ–Ω—å—à–µ –æ–ø–µ—Ä–∞—Ü–∏–π
```

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –≠–¢–ê–ü–´

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:
- –≠—Ç–∞–ø—ã 0-9: –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è PID —Å–∏—Å—Ç–µ–º–∞
- –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (18 —ç–∫—Ä–∞–Ω–æ–≤)
- **–ë–û–ù–£–°**: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Screen Manager

### üìù –û—Å—Ç–∞–ª–æ—Å—å:
- –≠—Ç–∞–ø 10: –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (NVS + SD –∫–∞—Ä—Ç–∞)
- –≠—Ç–∞–ø 11: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
- –≠—Ç–∞–ø 12: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

**–î–∞—Ç–∞:** 2025-10-15  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **SCREEN MANAGER –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù**  
**–ü—Ä–æ—à–∏–≤–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!**

