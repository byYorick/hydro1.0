# 📊 Архитектура памяти ESP32-S3 в проекте Hydro 1.0

**Контроллер:** ESP32-S3 (Dual Core Xtensa LX7, 240 MHz)  
**Flash:** 4 MB  
**PSRAM:** 2-8 MB (OCT mode, 80 MHz)  
**Дата:** 2025-10-16

---

## 🧠 1. Внутренняя SRAM (~512 KB)

ESP32-S3 имеет ~512 KB быстрой внутренней статической памяти (SRAM), разделенной на несколько регионов:

### Разделение SRAM:

```
┌─────────────────────────────────────────────────────┐
│                  ESP32-S3 SRAM                      │
│                   ~512 KB Total                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  IRAM (Instruction RAM) - ~200 KB                   │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  Назначение:                                        │
│  • Исполняемый код ISR (прерывания)                 │
│  • WiFi/Bluetooth драйверы                          │
│  • Функции с атрибутом IRAM_ATTR                    │
│  • Критичный по времени код                         │
│                                                     │
│  Использовано в проекте:                            │
│  .text:    15356 bytes (93.73%)                     │
│  .vectors:  1028 bytes (6.27%)                      │
│  Всего:    16384 bytes (100%) ✅ Полное            │
│                                                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  DRAM (Data RAM) - ~328 KB  ⚠️ КРИТИЧНЫЙ РЕСУРС    │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  Назначение:                                        │
│  • Heap (malloc/free)                               │
│  • Стеки FreeRTOS задач                             │
│  • .data (инициализированные глобальные)            │
│  • .bss (неинициализированные глобальные)           │
│                                                     │
│  Использовано в проекте (ПОСЛЕ оптимизации):        │
│  .bss:   149512 bytes (43.75%) ← Основная часть    │
│  .data:   15768 bytes (4.61%)                       │
│  .text:   65487 bytes (19.16%)                      │
│  ──────────────────────────────                     │
│  Всего:  230767 bytes (67.52%) ✅ Хорошо           │
│  Свободно: 108 KB ← Достаточно для WiFi!            │
│                                                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  Cache - ~64 KB                                     │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  • Кэш инструкций (Instruction Cache)               │
│  • Кэш данных (Data Cache): 32 KB (настроено)      │
│  • Буфер для доступа к Flash                        │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### Детальная структура DRAM (230767 bytes):

```
┌─────────────────────────────────────────────┐
│           .bss (149512 bytes)               │  ← Неинициализированные
├─────────────────────────────────────────────┤     глобальные переменные
│  • WiFi driver BSS (~10-15 KB)              │
│  • Adaptive PID states (~3-5 KB)            │
│  • Pump manager states (~2-3 KB)            │
│  • LVGL widget buffers (~2-4 KB)            │
│  • Sensor cache & stats (~1-2 KB)           │
│  • Notification system (~1 KB)              │
│  • Error handler (~1 KB)                    │
│  • Остальные компоненты (~125 KB)           │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│           .data (15768 bytes)               │  ← Инициализированные
├─────────────────────────────────────────────┤     глобальные переменные
│  • Конфигурационные структуры               │
│  • Константные таблицы                      │
│  • Инициализированные массивы               │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│         .text в DRAM (65487 bytes)          │  ← Код в DRAM
├─────────────────────────────────────────────┤
│  • Функции без IRAM_ATTR                    │
│  • Некритичный по времени код               │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│        Heap + Stack (~108 KB free)          │  ← Динамическая память
├─────────────────────────────────────────────┤
│  • malloc/free allocations                  │
│  • FreeRTOS task stacks:                    │
│    - sensor_task:      4096 bytes           │
│    - display_task:     2560 bytes           │
│    - notification:     2048 bytes           │
│    - data_logger:      3072 bytes           │
│    - scheduler:        1536 bytes           │
│    - ph_ec_task:       1536 bytes           │
│    - encoder_task:     1536 bytes           │
│    - LVGL timer:       ~4096 bytes          │
│    - Idle tasks (x2):  ~2048 bytes          │
│  • Heap резерв: ~80 KB                      │
└─────────────────────────────────────────────┘
```

---

## 💾 2. Внешняя PSRAM (~2-8 MB)

Медленная, но объемная память для больших буферов.

### Конфигурация PSRAM:

```ini
CONFIG_SPIRAM=y                                   # ✅ Включено
CONFIG_SPIRAM_MODE_OCT=y                          # 8-битная шина
CONFIG_SPIRAM_SPEED_80M=y                         # 80 MHz
CONFIG_SPIRAM_USE_MALLOC=y                        # Автоматически для больших malloc
CONFIG_SPIRAM_ALLOW_BSS_SEG_EXTERNAL_MEMORY=y     # BSS в PSRAM
CONFIG_SPIRAM_TRY_ALLOCATE_WIFI_LWIP=y            # WiFi буферы в PSRAM
CONFIG_SPIRAM_MALLOC_RESERVE_INTERNAL=32768       # Резерв 32 KB DRAM
CONFIG_SPIRAM_ALLOW_STACK_EXTERNAL_MEMORY=y       # Стеки в PSRAM
```

### Что хранится в PSRAM:

```
┌─────────────────────────────────────────────┐
│       Heap allocations (~2-8 MB)            │
├─────────────────────────────────────────────┤
│                                             │
│  КРИТИЧНО: Перенесено в PSRAM для экономии: │
│                                             │
│  • LVGL буферы:                             │
│    - disp_buf1: 28.8 KB  ← Основной         │
│    - disp_buf2: 28.8 KB  ← Двойная буф-я    │
│                                             │
│  • WiFi буферы (частично):                  │
│    - LWIP heap: ~5-10 KB                    │
│    - RX/TX buffers: ~3-5 KB                 │
│                                             │
│  • Большие malloc (> 16 KB автоматически):  │
│    - Временные буферы                       │
│    - Динамические массивы                   │
│                                             │
│  • BSS сегмент (если не влез в DRAM):       │
│    - Некритичные глобальные переменные      │
│                                             │
│  Свободно: ~1.8-7.8 MB (для будущих нужд)   │
└─────────────────────────────────────────────┘
```

### Производительность PSRAM:

| Параметр | SRAM | PSRAM (OCT 80MHz) | Разница |
|----------|------|-------------------|---------|
| **Скорость** | 240 MHz | 80 MHz | **3x медленнее** |
| **Задержка** | 1 цикл | 4-8 циклов | **4-8x медленнее** |
| **Пропускная способность** | ~960 MB/s | ~160 MB/s | **6x медленнее** |

**Вывод:** PSRAM подходит для некритичных данных (UI буферы, кэши), но не для ISR и WiFi критичного кода.

---

## 📀 3. Flash память (4 MB)

Внешняя энергонезависимая память для хранения прошивки и данных.

### Таблица разделов (partitions.csv):

```
┌──────────────────────────────────────────────────────┐
│  Offset    │  Size      │  Name      │  Type/SubType │
├────────────┼────────────┼────────────┼───────────────┤
│  0x9000    │  24 KB     │  nvs       │  data/nvs     │  ← Настройки
│  0xF000    │  4 KB      │  phy_init  │  data/phy     │  ← WiFi калибр.
│  0x10000   │  3.83 MB   │  factory   │  app/factory  │  ← Приложение
└──────────────────────────────────────────────────────┘

Всего доступно: 3.91 MB
Использовано:   1.32 MB (34%)
Свободно:       2.6 MB (66%)  ✅ Отличный запас!
```

### Детальная структура Flash:

```
┌─────────────────────────────────────────────┐
│     .text (код программы) ~540 KB           │
├─────────────────────────────────────────────┤
│  • Все функции приложения                   │
│  • Библиотеки (LVGL, FreeRTOS, ESP-IDF)     │
│  • Драйверы датчиков и дисплея              │
│  • UI код и экраны                          │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│    .rodata (константы) ~213 KB              │
├─────────────────────────────────────────────┤
│  • Строковые литералы ("Hello", TAG)        │
│  • const переменные                         │
│  • Lookup таблицы                           │
│  • Шрифты LVGL (montserrat_ru)              │
│  • Статические изображения                  │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│       NVS (энергонезависимое) 24 KB         │
├─────────────────────────────────────────────┤
│  • WiFi credentials (SSID, password)        │
│  • System config (PID параметры)            │
│  • Pump calibration данные                  │
│  • User settings (яркость, язык)            │
│  • Scheduler tasks                          │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│      PHY_INIT (WiFi калибровка) 4 KB        │
├─────────────────────────────────────────────┤
│  • WiFi RF калибровочные данные             │
│  • Автоматически заполняется при первом     │
│    запуске WiFi                             │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│      Резерв для будущего ~2.6 MB            │
├─────────────────────────────────────────────┤
│  • Дополнительный код                       │
│  • Новые экраны и функции                   │
│  • Ассеты (изображения, шрифты)             │
│  • Логи (если добавить SPIFFS)              │
└─────────────────────────────────────────────┘
```

---

## 🔄 4. Работа с памятью в проекте

### Распределение по компонентам:

| Компонент | DRAM (.bss) | Flash (.text) | Flash (.rodata) | Примечание |
|-----------|-------------|---------------|-----------------|------------|
| **LVGL библиотека** | ~0 KB | ~120 KB | ~44 KB | Буферы в PSRAM ✅ |
| **ESP-IDF WiFi** | ~10-15 KB | ~35 KB | ~12 KB | Частично в PSRAM |
| **ESP-IDF System** | ~20 KB | ~100 KB | ~56 KB | Базовая система |
| **FreeRTOS** | ~20 KB | ~17 KB | ~11 KB | Ядро RTOS |
| **LVGL UI** | ~15 KB | ~48 KB | ~14 KB | Экраны и виджеты |
| **Adaptive PID** | ~3-5 KB | ~20 KB | ~2 KB | История и состояния |
| **Pump Manager** | ~2-3 KB | ~14 KB | ~2 KB | Управление насосами |
| **Sensor Manager** | ~1-2 KB | ~15 KB | ~1 KB | Кэш сенсоров |
| **Остальное** | ~80 KB | ~185 KB | ~71 KB | Другие компоненты |

---

## 🎯 5. Оптимизация памяти

### Что МОЖНО хранить в DRAM:

✅ **Критичные данные** (быстрый доступ):
- WiFi driver buffers
- ISR переменные
- FreeRTOS стеки
- Маленькие структуры (<1 KB)
- Переменные в горячих циклах

### Что НУЖНО хранить в PSRAM:

✅ **Некритичные большие данные**:
- LVGL графические буферы
- Большие массивы (> 1 KB)
- Кэши изображений
- Временные буферы
- История данных (если большая)

### Что хранится во Flash:

✅ **Только чтение**:
- Весь код программы (.text)
- Строковые константы
- const переменные
- Lookup таблицы
- Шрифты и изображения

---

## 📈 6. Примеры использования в коде

### ✅ ПРАВИЛЬНО: Большие буферы в PSRAM

```c
// LVGL display buffers (lcd_ili9341.c)
static lv_color_t *disp_buf1 = NULL;
static lv_color_t *disp_buf2 = NULL;

void init() {
    size_t buf_size = LCD_H_RES * 60 * sizeof(lv_color_t);  // 28.8 KB
    
    // Выделяем в PSRAM
    disp_buf1 = heap_caps_malloc(buf_size, MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT);
    disp_buf2 = heap_caps_malloc(buf_size, MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT);
    
    ESP_LOGI("LCD", "Buffers allocated in PSRAM: %d bytes each", buf_size);
}
```

**Выгода:** Освобождено ~57 KB DRAM!

### ✅ ПРАВИЛЬНО: Маленькие структуры в DRAM

```c
// sensor_manager.c
static sensor_data_t cached_data = {0};  // ~100 bytes
static sensor_stats_t stats[SENSOR_TYPE_COUNT] = {0};  // ~200 bytes
```

**Причина:** Быстрый доступ, критично для реального времени.

### ✅ ПРАВИЛЬНО: Константы во Flash

```c
// pump_manager.c
static const char* TAG = "PUMP";  // .rodata
static const int PUMP_PINS[PUMP_INDEX_COUNT] = {...};  // .rodata
```

**Причина:** Только чтение, не меняется.

### ❌ НЕПРАВИЛЬНО: Огромные массивы в DRAM

```c
// ❌ ПЛОХО - съест весь DRAM!
static uint8_t huge_buffer[100000];  // 100 KB в .bss

// ✅ ХОРОШО - используем PSRAM
static uint8_t *huge_buffer = NULL;
void init() {
    huge_buffer = heap_caps_malloc(100000, MALLOC_CAP_SPIRAM);
}
```

---

## 🔍 7. Диагностика памяти

### Команды для проверки:

```bash
# Общая статистика
idf.py size

# По компонентам
idf.py size-components

# Найти большие переменные
xtensa-esp32s3-elf-nm -S --size-sort build/hydroponics.elf | grep " [bBdD] "

# Проверить heap в runtime
ESP_LOGI("MEM", "Free DRAM: %d", heap_caps_get_free_size(MALLOC_CAP_INTERNAL));
ESP_LOGI("MEM", "Free PSRAM: %d", heap_caps_get_free_size(MALLOC_CAP_SPIRAM));
```

### Интерпретация результатов:

```
DIRAM: 230767 / 341760 bytes (67.52%)
  .bss:   149512 bytes  ← Если > 200 KB - проблема!
  .data:   15768 bytes  ← Обычно 10-20 KB
  .text:   65487 bytes  ← Код в DRAM
```

**Правило большого пальца:**
- ✅ DRAM < 80% - отлично
- ⚠️ DRAM 80-90% - осторожно
- ❌ DRAM > 90% - критично, нужна оптимизация

---

## 📊 8. Итоговая карта памяти проекта

```
╔═══════════════════════════════════════════════════════╗
║              ESP32-S3 Memory Map                      ║
║                  Hydro 1.0 Project                    ║
╠═══════════════════════════════════════════════════════╣
║                                                       ║
║  ┌─────────────────────────────────────────────┐     ║
║  │   FAST SRAM (Internal) - ~512 KB            │     ║
║  ├─────────────────────────────────────────────┤     ║
║  │  IRAM:  16 KB / 16 KB (100%) ✅             │     ║
║  │  DRAM: 230 KB / 328 KB (67.5%) ✅           │     ║
║  │  Cache: 64 KB                               │     ║
║  └─────────────────────────────────────────────┘     ║
║                       ↕                               ║
║  ┌─────────────────────────────────────────────┐     ║
║  │   SLOW PSRAM (External) - 2-8 MB            │     ║
║  ├─────────────────────────────────────────────┤     ║
║  │  LVGL buffers:     ~57 KB                   │     ║
║  │  WiFi buffers:     ~10 KB                   │     ║
║  │  BSS overflow:     ~10-20 KB                │     ║
║  │  Free:             ~1.8-7.8 MB ✅           │     ║
║  └─────────────────────────────────────────────┘     ║
║                       ↕                               ║
║  ┌─────────────────────────────────────────────┐     ║
║  │   FLASH (External) - 4 MB                   │     ║
║  ├─────────────────────────────────────────────┤     ║
║  │  Bootloader:       ~24 KB                   │     ║
║  │  Partition table:  ~4 KB                    │     ║
║  │  NVS:              24 KB                    │     ║
║  │  PHY_INIT:         4 KB                     │     ║
║  │  Application:      1.32 MB / 3.83 MB (34%) │     ║
║  │  Free:             2.6 MB ✅                │     ║
║  └─────────────────────────────────────────────┘     ║
║                                                       ║
╚═══════════════════════════════════════════════════════╝
```

---

## 💡 9. Рекомендации

### При разработке новых функций:

1. **Перед добавлением большого массива:**
   ```bash
   idf.py size  # Проверьте текущее использование
   ```

2. **Используйте heap_caps_malloc для больших буферов:**
   ```c
   // Автоматически выберет PSRAM для больших выделений
   void *buf = heap_caps_malloc(size, MALLOC_CAP_DEFAULT);
   
   // Принудительно в PSRAM
   void *buf = heap_caps_malloc(size, MALLOC_CAP_SPIRAM);
   
   // Принудительно в DRAM (для критичных данных)
   void *buf = heap_caps_malloc(size, MALLOC_CAP_INTERNAL);
   ```

3. **Мониторьте heap:**
   ```c
   ESP_LOGI(TAG, "DRAM free: %d", heap_caps_get_free_size(MALLOC_CAP_INTERNAL));
   ESP_LOGI(TAG, "PSRAM free: %d", heap_caps_get_free_size(MALLOC_CAP_SPIRAM));
   ```

### Если DRAM overflow:

1. **Найдите виновника:**
   ```bash
   xtensa-esp32s3-elf-nm -S --size-sort build/hydroponics.elf | grep " [bBdD] " | tail -20
   ```

2. **Перенесите большие массивы в PSRAM**
3. **Уменьшите стеки задач** (с осторожностью!)
4. **Отключите ненужные компоненты** в `sdkconfig`

### Если Flash overflow:

1. **Отключите неиспользуемые функции LVGL:**
   ```ini
   # sdkconfig
   CONFIG_LV_USE_SNAPSHOT=n
   CONFIG_LV_USE_MONKEY=n
   ```

2. **Уменьшите логирование:**
   ```ini
   CONFIG_LOG_DEFAULT_LEVEL_INFO=y  # вместо DEBUG
   ```

3. **Используйте оптимизацию по размеру:**
   ```ini
   CONFIG_COMPILER_OPTIMIZATION_SIZE=y  # вместо PERFORMANCE
   ```

---

## ✅ Текущий статус проекта

| Параметр | Значение | Статус |
|----------|----------|--------|
| **DRAM использовано** | 230 KB / 328 KB (67.5%) | ✅ Отлично |
| **DRAM свободно** | 108 KB | ✅ Достаточно |
| **PSRAM использовано** | ~100 KB / 2-8 MB | ✅ Много места |
| **Flash использовано** | 1.32 MB / 3.83 MB (34%) | ✅ Отлично |
| **WiFi статус** | Включен и работает | ✅ |
| **UI статус** | Плавный, отзывчивый | ✅ |
| **Сборка** | Без ошибок | ✅ |

**Вывод:** Система оптимизирована и готова к полноценной работе с WiFi!

---

**Автор:** AI Assistant  
**Дата:** 2025-10-16  
**Версия:** Hydro 1.0 v3.0.0-advanced

