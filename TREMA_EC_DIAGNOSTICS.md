# Диагностика и исправления Trema EC сенсора

## Проблема
EC сенсор не выводил реальные данные, показывал только stub-значения.

## Исправления

### 1. Добавлена температурная компенсация ✅
**КРИТИЧНО:** EC измерения сильно зависят от температуры!

```c
// В system_tasks.c перед чтением EC:
if (data->valid[SENSOR_INDEX_TEMPERATURE]) {
    trema_ec_set_temperature(data->temperature);
    ESP_LOGD(TAG, "Temperature compensation set for EC: %.1f°C", data->temperature);
}
```

**Почему это важно:**
- Электропроводность воды меняется примерно на 2% на каждый градус
- Без компенсации показания будут неточными на 10-20%
- Сенсор использует температуру для автоматической коррекции

### 2. Улучшена диагностика ✅

**Добавлено логирование:**
- Адрес I2C устройства при инициализации
- Model ID (ожидается 0x19 для iarduino TDS)
- Сырые байты данных при чтении
- Конвертированные значения EC
- Детальные сообщения об ошибках

**Пример логов при успешной работе:**
```
I trema_ec: Initializing EC sensor at address 0x08...
I trema_ec: EC sensor model ID read: 0x19 (expected 0x19)
I trema_ec: ✓ EC sensor initialized successfully (model 0x19)
I trema_ec: EC raw bytes: [0]=0xB8 [1]=0x04, raw_value=1208
I trema_ec: EC converted: 1.208 mS/cm
```

### 3. Увеличена задержка чтения ✅
- **Было:** 20мс
- **Стало:** 50мс
- **Причина:** Сенсору нужно больше времени для стабильного измерения

### 4. Исправлена обработка ошибок ✅
- Флаг `use_stub_values` корректно обновляется
- При успешном чтении флаг сбрасывается
- При ошибке флаг устанавливается

## Карта регистров iarduino TDS (I2C адрес 0x08)

| Регистр | Адрес | Описание | Размер |
|---------|-------|----------|--------|
| REG_MODEL | 0x04 | ID модели (0x19) | 1 байт |
| REG_TDS_KNOWN_TDS | 0x0A | Известное TDS для калибровки | 2 байта |
| REG_TDS_CALIBRATION | 0x10 | Управление калибровкой | 1 байт |
| REG_TDS_t | 0x19 | Температура для компенсации | 1 байт |
| REG_TDS_S | 0x20 | Измеренная проводимость | 2 байта |
| REG_TDS_EC | 0x22 | Конвертированная проводимость | 2 байта |
| REG_TDS_TDS | 0x24 | Значение TDS | 2 байта |

## Формат данных

### EC (электропроводность)
- Регистр: 0x22 (REG_TDS_EC)
- Размер: 2 байта (little-endian)
- Формат: uint16_t в тысячных долях
- Конвертация: `ec_mS_cm = raw_value * 0.001`
- Диапазон: 0.0 - 10.0 mS/cm

### Температура для компенсации
- Регистр: 0x19 (REG_TDS_t)
- Размер: 1 байт
- Формат: температура в шагах 0.25°C
- Конвертация: `reg_value = temperature * 4`
- Диапазон: 0.0 - 63.75°C

## Последовательность чтения

1. **Инициализация (один раз):**
   - Прочитать Model ID (регистр 0x04)
   - Проверить что ID = 0x19

2. **Чтение EC (каждый цикл):**
   - Установить температуру (регистр 0x19)
   - Записать адрес регистра EC (0x22)
   - Подождать 50мс
   - Прочитать 2 байта
   - Конвертировать: `(data[1] << 8 | data[0]) * 0.001`

## Проверка работы

После прошивки в логах должно быть:

### ✅ Сенсор работает:
```
I trema_ec: ✓ EC sensor initialized successfully (model 0x19)
D SYS_TASKS: Temperature compensation set for EC: 24.5°C
I trema_ec: EC raw bytes: [0]=0xB8 [1]=0x04, raw_value=1208
I trema_ec: EC converted: 1.208 mS/cm
I SYS_TASKS: EC read: 1.21 mS/cm
```

### ❌ Сенсор не подключен:
```
W trema_ec: Failed to write to EC sensor (addr=0x08, reg=0x04)
D trema_ec: EC sensor not connected, using stub values
```

### ❌ Неправильный адрес или модель:
```
I trema_ec: EC sensor model ID read: 0xXX (expected 0x19)
W trema_ec: Invalid EC sensor model ID: 0xXX (expected 0x19)
```

## Рекомендации

1. **Проверьте I2C подключение:**
   - SDA и SCL линии правильно подключены
   - Pullup резисторы 4.7кОм установлены
   - Напряжение питания 3.3V или 5V

2. **Проверьте адрес:**
   - Сенсор должен быть на адресе 0x08
   - Используйте I2C scanner для проверки

3. **Калибровка:**
   - Для точных измерений нужна двухточечная калибровка
   - Используйте растворы с известным TDS (например, 0 ppm и 1000 ppm)
   - Вызовите `trema_ec_calibrate(stage, known_tds)`

4. **Температура:**
   - Убедитесь что SHT3x датчик работает корректно
   - Температурная компенсация автоматически применяется

## Изменения в коде

- ✅ `components/trema_ec/trema_ec.c` - добавлена диагностика
- ✅ `components/system_tasks/system_tasks.c` - добавлена температурная компенсация
- ✅ `main/system_config.h` - увеличен стек data_logger до 16KB

## Размер прошивки
**696 KB** из 1 MB (использовано 67%, свободно 33%)

