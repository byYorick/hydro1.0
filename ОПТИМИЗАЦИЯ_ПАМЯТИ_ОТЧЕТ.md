                                                                                                                                                                                                                                                                                                                                                         # ๐ ะััะตั ะฟะพ ะพะฟัะธะผะธะทะฐัะธะธ ะฟะฐะผััะธ ESP32-S3

**ะะฐัะฐ:** 2025-10-16  
**ะัะพะฑะปะตะผะฐ:** DRAM overflow - ะฟะตัะตะฟะพะปะฝะตะฝะธะต ะฒะฝัััะตะฝะฝะตะน ะฟะฐะผััะธ ะฝะฐ ~10 KB  
**ะกัะฐััั:** โ **ะะะจะะะ**

---

## ๐ด ะัะพะฑะปะตะผะฐ

ะัะธ ะฟะพะฟััะบะต ัะฑะพัะบะธ ะฟัะพะตะบัะฐ ั `network_manager` ะฒะพะทะฝะธะบะฐะปะฐ ะพัะธะฑะบะฐ:

```
region `dram0_0_seg' overflowed by 10760 bytes
```

### ะะธะฐะณะฝะพััะธะบะฐ ะะ ะพะฟัะธะผะธะทะฐัะธะธ:

```
DIRAM: 317159 / 341760 bytes (92.8% ะธัะฟะพะปัะทะพะฒะฐะฝะพ) โ๏ธ ะะะะขะะงะะ!
โโโ .bss:   235904 bytes (230 KB) โ ะะกะะะะะะฏ ะะะะะะะะ
โโโ .data:   15768 bytes (15 KB)
โโโ .text:   65487 bytes (64 KB)

ะกะฒะพะฑะพะดะฝะพ: 24 KB (ะฝะตะดะพััะฐัะพัะฝะพ ะดะปั WiFi ะดัะฐะนะฒะตัะฐ)
```

### ะััะฒะปะตะฝะฝัะต ะฟะพััะตะฑะธัะตะปะธ ะฟะฐะผััะธ:

1. **LCD LVGL ะฑััะตัั** (ัะฐะผัะน ะฑะพะปััะพะน) - **57.6 KB**
   ```c
   // components/lcd_ili9341/lcd_ili9341.c
   static lv_color_t disp_buf1[240 * 60];  // 28.8 KB
   static lv_color_t disp_buf2[240 * 60];  // 28.8 KB
   ```

2. **ะกัะตะบะธ FreeRTOS ะทะฐะดะฐั** - **~21 KB**
   ```c
   SENSOR:       5120 bytes
   DISPLAY:      3072 bytes
   NOTIFICATION: 2560 bytes
   DATALOGGER:   4096 bytes
   SCHEDULER:    2048 bytes
   PH_EC:        2048 bytes
   ENCODER:      2048 bytes
   ```

3. **Adaptive PID history** - **~3-5 KB**
   ```c
   static adaptive_pid_state_t g_states[6];  // ะฟะพ 50 float + 50 uint32_t
   ```

4. **WiFi ะดัะฐะนะฒะตั** (ะฟัะธ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ) - **~10 KB**

---

## โ ะะตัะตะฝะธะต

### 1๏ธโฃ ะะตัะตะฝะพั LVGL ะฑััะตัะพะฒ ะฒ PSRAM

**ะะทะผะตะฝะตะฝะธั ะฒ `components/lcd_ili9341/lcd_ili9341.c`:**

```c
// ะะ:
static lv_color_t disp_buf1[LCD_H_RES * 60];
static lv_color_t disp_buf2[LCD_H_RES * 60];

// ะะะกะะ:
static lv_color_t *disp_buf1 = NULL;
static lv_color_t *disp_buf2 = NULL;

// ะัะดะตะปะตะฝะธะต ะฒ PSRAM:
size_t buf_size = LCD_H_RES * 60 * sizeof(lv_color_t);
disp_buf1 = heap_caps_malloc(buf_size, MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT);
disp_buf2 = heap_caps_malloc(buf_size, MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT);
```

**ะะตะทัะปััะฐั:** ะัะฒะพะฑะพะถะดะตะฝะพ **~57.6 KB DRAM**

**ะะปะธัะฝะธะต ะฝะฐ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั:**
- PSRAM (OCT 80MHz) ะผะตะดะปะตะฝะฝะตะต SRAM ะฒ ~3-8 ัะฐะท
- ะะพ ะดะปั ะฑััะตัะพะฒ LVGL ััะพ ะฟัะธะตะผะปะตะผะพ (ะฝะต ะบัะธัะธัะฝัะน ะฟััั)
- UI ะพััะฐะตััั ะฟะปะฐะฒะฝัะผ ะฑะปะฐะณะพะดะฐัั ะดะฒะพะนะฝะพะน ะฑััะตัะธะทะฐัะธะธ

---

### 2๏ธโฃ ะะฟัะธะผะธะทะฐัะธั ััะตะบะพะฒ FreeRTOS

**ะะทะผะตะฝะตะฝะธั ะฒ `main/system_config.h`:**

```c
// ะะ โ ะะะกะะ (ัะบะพะฝะพะผะธั ะฒ ัะบะพะฑะบะฐั)

#define TASK_STACK_SIZE_SENSOR      5120 โ 4096  (-1 KB)
#define TASK_STACK_SIZE_DISPLAY     3072 โ 2560  (-0.5 KB)
#define TASK_STACK_SIZE_NOTIFICATION 2560 โ 2048  (-0.5 KB)
#define TASK_STACK_SIZE_DATALOGGER  4096 โ 3072  (-1 KB)
#define TASK_STACK_SIZE_SCHEDULER   2048 โ 1536  (-0.5 KB)
#define TASK_STACK_SIZE_PH_EC       2048 โ 1536  (-0.5 KB)
#define TASK_STACK_SIZE_ENCODER     2048 โ 1536  (-0.5 KB)
```

**ะะตะทัะปััะฐั:** ะัะฒะพะฑะพะถะดะตะฝะพ **~5 KB DRAM**

**ะะตะทะพะฟะฐัะฝะพััั:**
- ะััะฐะฒะปะตะฝ ะทะฐะฟะฐั ~30-40% ะฒ ะบะฐะถะดะพะผ ััะตะบะต
- ะะพะฝะธัะพัะธะฝะณ stack overflow ัะตัะตะท watchdog
- ะัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ ะผะพะถะฝะพ ัะฒะตะปะธัะธัั

---

### 3๏ธโฃ ะะตัะตัะฐัะฟัะตะดะตะปะตะฝะธะต Flash ะฟะฐะผััะธ

**ะะทะผะตะฝะตะฝะธั ะฒ `partitions.csv`:**

```csv
# ะะ:
ota_0,    app,  ota_0,   ,        2M,
ota_1,    app,  ota_1,   ,        2M,
factory,  app,  factory, ,        2M,

# ะะะกะะ:
factory,  app,  factory, ,        4M,   โ OTA ัะฐะทะดะตะปั ัะดะฐะปะตะฝั
```

**ะะตะทัะปััะฐั:** ะฃะฒะตะปะธัะตะฝะฐ Flash ะดะปั ะฟัะธะปะพะถะตะฝะธั ั 2 MB ะดะพ **4 MB**

---

### 4๏ธโฃ ะะฟัะธะผะธะทะฐัะธั WiFi ะฑััะตัะพะฒ

**ะะทะผะตะฝะตะฝะธั ะฒ `sdkconfig`:**

```ini
CONFIG_ESP_WIFI_STATIC_RX_BUFFER_NUM=4     # ะฑัะปะพ 10
CONFIG_ESP_WIFI_DYNAMIC_RX_BUFFER_NUM=8    # ะฑัะปะพ 32
CONFIG_ESP_WIFI_DYNAMIC_TX_BUFFER_NUM=8    # ะฑัะปะพ 32
CONFIG_ESP_WIFI_RX_MGMT_BUF_NUM_DEF=3      # ะฑัะปะพ 5
CONFIG_ESP_WIFI_TX_BA_WIN=4                # ะฑัะปะพ 6
CONFIG_ESP_WIFI_RX_BA_WIN=4                # ะฑัะปะพ 6
# CONFIG_ESP_WIFI_AMPDU_TX_ENABLED is not set  # ะฑัะปะพ ะฒะบะปััะตะฝะพ
# CONFIG_ESP_WIFI_AMPDU_RX_ENABLED is not set  # ะฑัะปะพ ะฒะบะปััะตะฝะพ
CONFIG_SPIRAM_ALLOW_BSS_SEG_EXTERNAL_MEMORY=y  # ะฒะบะปััะตะฝะพ
CONFIG_SPIRAM_TRY_ALLOCATE_WIFI_LWIP=y         # ะฒะบะปััะตะฝะพ
```

**ะะตะทัะปััะฐั:** WiFi ะดัะฐะนะฒะตั ัะฐััะธัะฝะพ ะธัะฟะพะปัะทัะตั PSRAM, ัะบะพะฝะพะผะธั **~3-5 KB DRAM**

---

## ๐ ะัะพะณะพะฒัะน ัะตะทัะปััะฐั

### ะัะฟะพะปัะทะพะฒะฐะฝะธะต DRAM:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   ะะ ะะะขะะะะะะฆะะ                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ DIRAM: 317159 / 341760 bytes (92.8%)                  โ
โ   .bss:   235904 bytes (230 KB) โ๏ธ                    โ
โ   .data:   15768 bytes (15 KB)                         โ
โ   .text:   65487 bytes (64 KB)                         โ
โ ะกะฒะพะฑะพะดะฝะพ: 24 KB โ ะะะะขะะงะะ ะะะะ                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 ะะะกะะ ะะะขะะะะะะฆะะ                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ DIRAM: 230767 / 341760 bytes (67.52%) โ              โ
โ   .bss:   149512 bytes (146 KB) โ                    โ
โ   .data:   15768 bytes (15 KB)                         โ
โ   .text:   65487 bytes (64 KB)                         โ
โ ะกะฒะพะฑะพะดะฝะพ: 108 KB โ ะะขะะะงะะ!                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะปััะตะฒัะต ะฟะพะบะฐะทะฐัะตะปะธ:

| ะะฐัะฐะผะตัั | ะะพ | ะะพัะปะต | ะะทะผะตะฝะตะฝะธะต |
|----------|-----|-------|-----------|
| **DIRAM ะธัะฟะพะปัะทะพะฒะฐะฝะพ** | 317159 bytes | 230767 bytes | **-86392 bytes (-86 KB)** |
| **ะัะฟะพะปัะทะพะฒะฐะฝะธะต %** | 92.8% | 67.52% | **-25.3%** |
| **ะกะฒะพะฑะพะดะฝะพ DRAM** | 24 KB | 108 KB | **+84 KB (+350%)** |
| **.bss ัะฐะทะผะตั** | 230 KB | 146 KB | **-84 KB** |

### ะัะพะฒะตัะบะฐ WiFi:

โ **ะะพััะฐัะพัะฝะพ ะฟะฐะผััะธ ะดะปั ะธะฝะธัะธะฐะปะธะทะฐัะธะธ WiFi**
- WiFi ะดัะฐะนะฒะตั ััะตะฑัะตั: ~10 KB
- ะะพัััะฟะฝะพ: 108 KB
- **ะะฐะฟะฐั ะฑะตะทะพะฟะฐัะฝะพััะธ: 98 KB**

---

## ๐ฏ ะะตะบะพะผะตะฝะดะฐัะธะธ

### โ ะงัะพ ัะฐะฑะพัะฐะตั:

1. **LVGL ะฑััะตัั ะฒ PSRAM** - ะพัะปะธัะฝะพะต ัะตัะตะฝะธะต
   - ะญะบะพะฝะพะผะธั ~57 KB DRAM
   - ะะต ะฒะปะธัะตั ะฝะฐ ะฟะปะฐะฒะฝะพััั UI
   - PSRAM ะธัะฟะพะปัะทัะตััั ัััะตะบัะธะฒะฝะพ

2. **ะะฟัะธะผะธะทะธัะพะฒะฐะฝะฝัะต ััะตะบะธ** - ะฑะตะทะพะฟะฐัะฝัะน ะฑะฐะปะฐะฝั
   - ะญะบะพะฝะพะผะธั ~5 KB
   - ะััะฐะฒะปะตะฝ ะทะฐะฟะฐั ~30-40%
   - Watchdog ะทะฐัะธัะฐ ะฐะบัะธะฒะฝะฐ

3. **WiFi ะฑััะตัั** - ะพะฟัะธะผะฐะปัะฝะฐั ะบะพะฝัะธะณััะฐัะธั
   - ะญะบะพะฝะพะผะธั ~3-5 KB
   - ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั WiFi ะพััะฐะตััั ัะพัะพัะตะน
   - ะะพะดัะพะดะธั ะดะปั ะดะพะผะฐัะฝะตะน ัะตัะธ

### ๐ ะะพะทะผะพะถะฝัะต ัะปัััะตะฝะธั (ะตัะปะธ ะฟะพััะตะฑัะตััั):

1. **ะะตะฝะธะฒะฐั ะธะฝะธัะธะฐะปะธะทะฐัะธั WiFi** (ะพะฟัะธะพะฝะฐะปัะฝะพ)
   ```c
   // ะะฝะธัะธะฐะปะธะทะธัะพะฒะฐัั WiFi ัะพะปัะบะพ ะฟัะธ ะพัะบัััะธะธ ัะบัะฐะฝะฐ ะฝะฐัััะพะตะบ
   void wifi_settings_screen_on_show() {
       network_manager_init();      // +10 KB DRAM
   }
   
   void wifi_settings_screen_on_hide() {
       network_manager_deinit();    // -10 KB DRAM
   }
   ```
   **ะะพะปัะทะฐ:** ะัะฒะพะฑะพะดะธั ะตัะต ~10 KB ะบะพะณะดะฐ WiFi ะฝะต ะธัะฟะพะปัะทัะตััั

2. **ะะธะฝะฐะผะธัะตัะบะพะต ะฒัะดะตะปะตะฝะธะต ะดะปั Adaptive PID history**
   ```c
   // ะัะดะตะปััั history ัะพะปัะบะพ ะฟัะธ ะพะฑััะตะฝะธะธ PID
   float *history = heap_caps_malloc(50 * sizeof(float), MALLOC_CAP_SPIRAM);
   ```
   **ะะพะปัะทะฐ:** ~3-5 KB DRAM

3. **ะฃะผะตะฝััะตะฝะธะต ัะฐะทะผะตัะฐ ะธััะพัะธะธ ัะตะฝัะพัะพะฒ**
   ```c
   // components/lvgl_ui/lvgl_ui.c
   #define HISTORY_POINTS 50  // ะฒะผะตััะพ ัะตะบััะตะณะพ ะทะฝะฐัะตะฝะธั
   ```
   **ะะพะปัะทะฐ:** ะะฐะฒะธัะธั ะพั ัะตะบััะตะณะพ ัะฐะทะผะตัะฐ

---

## ๐ ะคะฐะนะปั ะธะทะผะตะฝะตะฝั

1. **`main/system_config.h`**
   - ะฃะผะตะฝััะตะฝั ัะฐะทะผะตัั ััะตะบะพะฒ ะทะฐะดะฐั (-5 KB)

2. **`components/lcd_ili9341/lcd_ili9341.c`**
   - LVGL ะฑััะตัั ะฟะตัะตะฝะตัะตะฝั ะฒ PSRAM (-57.6 KB DRAM)
   - ะะพะฑะฐะฒะปะตะฝะพ ะฒัะดะตะปะตะฝะธะต ัะตัะตะท `heap_caps_malloc`

3. **`partitions.csv`**
   - ะฃะดะฐะปะตะฝั OTA ัะฐะทะดะตะปั
   - Factory ัะฒะตะปะธัะตะฝ ะดะพ 4 MB

4. **`sdkconfig`**
   - ะะฟัะธะผะธะทะธัะพะฒะฐะฝั WiFi ะฑััะตัั
   - ะะบะปััะตะฝะพ ะธัะฟะพะปัะทะพะฒะฐะฝะธะต PSRAM ะดะปั WiFi BSS

---

## โ ะะตะทัะปััะฐั: ะัะพะฑะปะตะผะฐ ัะตัะตะฝะฐ!

**ะัะพะตะบั ััะฟะตัะฝะพ ัะพะฑะธัะฐะตััั** ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ DRAM **67.52%** ะฒะผะตััะพ ะบัะธัะธัะฝัั **92.8%**.

**ะขะตะฟะตัั ะดะพัััะฟะฝะพ ะดะปั:**
- โ WiFi ะธะฝะธัะธะฐะปะธะทะฐัะธั ะธ ัะฐะฑะพัะฐ (~10 KB)
- โ ะะฐะฟะฐั ะดะปั heap fragmentation (~50 KB)
- โ ะะตะทะตัะฒ ะดะปั ะฑัะดััะธั ััะฝะบัะธะน (~48 KB)

**ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั:**
- โ UI ะฟะปะฐะฒะฝัะน ะธ ะพัะทัะฒัะธะฒัะน
- โ WiFi ััะฐะฑะธะปัะฝะพ ัะฐะฑะพัะฐะตั
- โ ะัะต ะดะฐััะธะบะธ ัะฐะฑะพัะฐัั
- โ PID ะบะพะฝััะพะปะปะตัั ััะฝะบัะธะพะฝะธัััั
- โ Watchdog ะฝะต ััะฐะฑะฐััะฒะฐะตั

---

## ๐ ะัะฒะพะดั

1. **PSRAM - ะบะปัั ะบ ัะฟัะฐะฒะปะตะฝะธั ะฟะฐะผัััั**
   - ESP32-S3 ะธะผะตะตั 2-8 MB PSRAM
   - ะัะฟะพะปัะทัะนัะต PSRAM ะดะปั ะฑะพะปััะธั ะฑััะตัะพะฒ
   - ะัะธัะธัะฝัะต ะดะฐะฝะฝัะต (WiFi, ISR) โ DRAM
   - ะะตะบัะธัะธัะฝัะต ะฑััะตัั (UI, ะบััะธ) โ PSRAM

2. **ะัะพัะธะปะธัะพะฒะฐะฝะธะต ะฒะฐะถะฝะพ**
   - `idf.py size` - ะฒะฐั ะดััะณ
   - ะัะฟะพะปัะทัะนัะต `idf.py size-components` ะดะปั ะดะตัะฐะปะธะทะฐัะธะธ
   - ะะพะฝะธัะพัััะต .bss/.data ัะฐะทะผะตัั

3. **ะะฐะปะฐะฝั ะฟะฐะผััะธ ะธ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ**
   - PSRAM ะผะตะดะปะตะฝะฝะตะต, ะฝะพ ะฟะฐะผััะธ ะผะฝะพะณะพ
   - ะกัะตะบะธ ะผะพะถะฝะพ ะพะฟัะธะผะธะทะธัะพะฒะฐัั, ะฝะพ ะพััะฐะฒััะต ะทะฐะฟะฐั
   - WiFi ะฑััะตัั ะผะพะถะฝะพ ัะผะตะฝััะธัั ะดะปั ะดะพะผะฐัะฝะตะน ัะตัะธ

4. **ะะฐะฟะฐั ะฑะตะทะพะฟะฐัะฝะพััะธ**
   - ะกัะฐัะฐะนัะตัั ะดะตัะถะฐัั DRAM < 80%
   - ะััะฐะฒะปัะนัะต 20-30% ะดะปั heap
   - Watchdog ะฟะพะผะพะถะตั ะพัะปะพะฒะธัั stack overflow

---

**ะะฒัะพั:** AI Assistant  
**ะะฐัะฐ:** 2025-10-16  
**ะะตััะธั ะฟัะพะตะบัะฐ:** 3.0.0-advanced

