# Исправление проблемы создания очереди SPI в проекте гидропоники на ESP32-S3

## Описание проблемы

Устройство ESP32-S3 испытывало сбои во время инициализации ЖК-дисплея со следующей ошибкой:

```
assert failed: xQueueGenericCreate queue.c:573 (pxNewQueue)
```

Это происходило во время вызова `esp_lcd_new_panel_io_spi` при попытке создать очередь для связи с SPI-устройством.

## Первоначальная причина

Проблема была вызвана установкой `trans_queue_depth = 0` в конфигурации SPI, что предназначалось для исправления проблем логирования в ISR, но вызвало проблемы с созданием очереди в драйвере SPI.

Когда `trans_queue_depth` установлен в 0, драйвер SPI все равно пытается создать очередь, но с глубиной 0, что недопустимо и вызывает сбой утверждения в `xQueueGenericCreate`.

## Реализованное решение

### 1. Восстановлена правильная глубина очереди

Изменена конфигурация SPI в [components/lcd_ili9341/lcd_ili9341.c](file:///c%3A/esp/hydro/hydro1.0/components/lcd_ili9341/lcd_ili9341.c) для использования правильной глубины очереди:

```c
esp_lcd_panel_io_spi_config_t io_config = {
    .dc_gpio_num = PIN_NUM_LCD_DC,
    .cs_gpio_num = PIN_NUM_LCD_CS,
    .pclk_hz = LCD_PIXEL_CLOCK_HZ,
    .lcd_cmd_bits = 8,
    .lcd_param_bits = 8,
    .spi_mode = 0,
    .trans_queue_depth = 10,  // Изменено обратно на 10 для правильной работы
    .on_color_trans_done = notify_lvgl_flush_ready,
    .user_ctx = &disp_drv,
};
```

### 2. Снижена скорость тактирования SPI

Снижена скорость тактирования SPI с 40 МГц до 20 МГц для лучшей стабильности:

```c
#define LCD_PIXEL_CLOCK_HZ     (20 * 1000 * 1000)  // Снижено с 40 МГц до 20 МГц для стабильности
```

### 3. Удалено логирование отладки из обратных вызовов ISR

Закомментировано логирование отладки в функциях, которые могут вызываться из контекста ISR, чтобы предотвратить проблемы с захватом мьютекса:

```c
// В функции notify_lvgl_flush_ready:
//ESP_LOGD("LCD", "notify_lvgl_flush_ready called");

// В функции lvgl_flush_cb:
//ESP_LOGD("LCD", "lvgl_flush_cb called");
```

## Альтернативные решения для проблем логирования в ISR

Если проблемы логирования в ISR повторятся, рассмотрите следующие альтернативы:

1. **Использование Menuconfig**: Установите уровень детализации логов по умолчанию на INFO, чтобы предотвратить логи DEBUG из ISR
2. **Безопасное логирование в ISR**: Используйте `ESP_DRAM_LOGD` вместо `ESP_LOGD` для безопасного логирования в ISR
3. **Буферизация логов**: Включите `CONFIG_LOG_MASTER_LEVEL=y` в menuconfig для буферизованных логов, безопасных для ISR

## Тестирование исправления

Для проверки работоспособности исправления:

1. Прошейте обновленную прошивку на ESP32-S3
2. Отслеживайте вывод в последовательный порт на наличие сообщений паники
3. Убедитесь, что дисплей инициализируется правильно и отображает интерфейс
4. Подтвердите, что данные датчиков отображаются корректно

## Влияние на производительность

Изменения должны иметь минимальное влияние на производительность:
- Восстановление глубины очереди обеспечивает правильную работу SPI
- Снижение скорости тактирования SPI может немного повлиять на частоту обновления дисплея, но улучшает стабильность
- Удаление логов отладки из критических путей улучшает производительность

## Заключение

Эти изменения должны устранить сбой утверждения создания очереди, сохраняя стабильность системы. Решение балансирует производительность с надежностью, используя соответствующие глубины очередей и скорости тактирования SPI.