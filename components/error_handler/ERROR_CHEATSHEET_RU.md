# –®–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—à–∏–±–æ–∫

–ö—Ä–∞—Ç–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```c
#include "error_handler.h"

// –ü—Ä–æ—Å—Ç–æ–π –æ—Ç—á—ë—Ç –æ–± –æ—à–∏–±–∫–µ
ERROR_REPORT(ERROR_CATEGORY_SENSOR, err, "SHT3X", 
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É");

// –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
ERROR_CRITICAL(ERROR_CATEGORY_I2C, err, "i2c_bus",
              "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —à–∏–Ω—É");

// –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
ERROR_WARN(ERROR_CATEGORY_SENSOR, "CCS811",
          "–î–∞—Ç—á–∏–∫ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≥—Ä–µ–≤–∞");

// –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞
ERROR_CHECK_I2C(err, "SHT3X", "–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –Ω–∞ 0x%02X", addr);
```

## üìä –¢–∞–±–ª–∏—Ü–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è |
|-----------|------------------|
| `ERROR_CATEGORY_I2C` | –û—à–∏–±–∫–∏ —à–∏–Ω—ã I2C |
| `ERROR_CATEGORY_SENSOR` | –û—à–∏–±–∫–∏ –¥–∞—Ç—á–∏–∫–æ–≤ |
| `ERROR_CATEGORY_DISPLAY` | –û—à–∏–±–∫–∏ –¥–∏—Å–ø–ª–µ—è |
| `ERROR_CATEGORY_STORAGE` | –û—à–∏–±–∫–∏ NVS |
| `ERROR_CATEGORY_SYSTEM` | –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ—à–∏–±–∫–∏ |
| `ERROR_CATEGORY_PUMP` | –û—à–∏–±–∫–∏ –Ω–∞—Å–æ—Å–æ–≤ |
| `ERROR_CATEGORY_RELAY` | –û—à–∏–±–∫–∏ —Ä–µ–ª–µ |

## üéØ –ß–∞—Å—Ç—ã–µ –∫–æ–¥—ã –æ—à–∏–±–æ–∫

| –ö–æ–¥ | –ß—Ç–æ —ç—Ç–æ | –ß—Ç–æ –¥–µ–ª–∞—Ç—å |
|-----|---------|------------|
| 0 | ‚úÖ –£—Å–ø–µ—Ö | –í—Å—ë –û–ö |
| -1 | ‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞ | –ü—Ä–æ–≤–µ—Ä—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã |
| 257 | üíæ –ù–µ—Ç –ø–∞–º—è—Ç–∏ | `esp_get_free_heap_size()` |
| 258 | ‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç | –ü—Ä–æ–≤–µ—Ä—å NULL, –¥–∏–∞–ø–∞–∑–æ–Ω—ã |
| 263 | ‚è±Ô∏è –¢–∞–π–º–∞—É—Ç | –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç |
| 265 | üîß –û—à–∏–±–∫–∞ CRC | –ü–æ–º–µ—Ö–∏ –Ω–∞ –ª–∏–Ω–∏–∏ |

## üîç –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π

```c
esp_err_t err = sensor_init();
if (err != ESP_OK) {
    ERROR_REPORT(ERROR_CATEGORY_SENSOR, err, TAG,
                "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å");
    return err;
}
```

### 2. –ü–æ–ø—ã—Ç–∫–∏ —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏

```c
for (int i = 0; i < 3; i++) {
    err = sensor_read(&value);
    if (err == ESP_OK) break;
    
    ERROR_WARN(ERROR_CATEGORY_SENSOR, TAG,
              "–ü–æ–ø—ã—Ç–∫–∞ %d/3 –Ω–µ —É–¥–∞–ª–∞—Å—å", i + 1);
    vTaskDelay(pdMS_TO_TICKS(100));
}
```

### 3. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

```c
// –í—Å–µ I2C –æ–ø–µ—Ä–∞—Ü–∏–∏
ERROR_CHECK_I2C(i2c_master_write(...), TAG, "–ó–∞–ø–∏—Å—å –Ω–∞ 0x%02X", addr);
ERROR_CHECK_I2C(i2c_master_read(...), TAG, "–ß—Ç–µ–Ω–∏–µ —Å 0x%02X", addr);

// –í—Å–µ —Å–µ–Ω—Å–æ—Ä—ã
ERROR_CHECK_SENSOR(sht3x_read(...), "SHT3X", "–ß—Ç–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã");
ERROR_CHECK_SENSOR(ccs811_read(...), "CCS811", "–ß—Ç–µ–Ω–∏–µ CO2");
```

### 4. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏

```c
void *buffer = malloc(size);
if (!buffer) {
    ERROR_CRITICAL(ERROR_CATEGORY_SYSTEM, ESP_ERR_NO_MEM, TAG,
                  "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–µ—Ö–≤–∞—Ç–∫–∞ –ø–∞–º—è—Ç–∏ (%d –±–∞–π—Ç)", size);
    esp_restart(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
}
```

## üé® –£—Ä–æ–≤–Ω–∏ –∏ —Ü–≤–µ—Ç–∞

| –£—Ä–æ–≤–µ–Ω—å | –¶–≤–µ—Ç | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|---------|------|--------------------|
| DEBUG | üîµ –°–∏–Ω–∏–π | –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è |
| INFO | üü¢ –ó–µ–ª—ë–Ω—ã–π | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è |
| WARNING | üü† –û—Ä–∞–Ω–∂–µ–≤—ã–π | –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è, –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ |
| ERROR | üî¥ –ö—Ä–∞—Å–Ω—ã–π | –û—à–∏–±–∫–∏, —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è |
| CRITICAL | üî¥ –¢—ë–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, —Å–∏—Å—Ç–µ–º–∞ –≤ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ |

## üí° –°–æ–≤–µ—Ç—ã –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º

### ‚úÖ –•–æ—Ä–æ—à–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

```c
ERROR_REPORT(ERROR_CATEGORY_I2C, err, "SHT3X",
            "–¢–∞–π–º–∞—É—Ç —á—Ç–µ–Ω–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —Å –∞–¥—Ä–µ—Å–∞ 0x44 (–ø–æ–ø—ã—Ç–∫–∞ %d)", retry);

ERROR_CRITICAL(ERROR_CATEGORY_SYSTEM, ESP_ERR_NO_MEM, "MAIN",
              "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–¥–µ–ª–∏—Ç—å %d –±–∞–π—Ç. –°–≤–æ–±–æ–¥–Ω–æ: %d",
              needed, esp_get_free_heap_size());
```

### ‚ùå –ü–ª–æ—Ö–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

```c
ERROR_REPORT(ERROR_CATEGORY_SENSOR, err, "S", "err");  // –ù–µ–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ
ERROR_REPORT(ERROR_CATEGORY_I2C, err, "", "Error");    // –ù–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
```

## üîß –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ heap

```c
uint32_t free_heap = esp_get_free_heap_size();
uint32_t min_heap = esp_get_minimum_free_heap_size();

ERROR_INFO("SYSTEM", "Heap: %d –±–∞–π—Ç, –º–∏–Ω: %d –±–∞–π—Ç", free_heap, min_heap);
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–µ–∫–∞ –∑–∞–¥–∞—á–∏

```c
UBaseType_t stack_left = uxTaskGetStackHighWaterMark(NULL);
if (stack_left < 512) {
    ERROR_WARN(ERROR_CATEGORY_SYSTEM, TAG,
              "–ú–∞–ª–æ –º–µ—Å—Ç–∞ –≤ —Å—Ç–µ–∫–µ: %d –±–∞–π—Ç", stack_left);
}
```

### –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```c
uint32_t start = esp_timer_get_time();
// ... –æ–ø–µ—Ä–∞—Ü–∏—è ...
uint32_t elapsed = (esp_timer_get_time() - start) / 1000; // –º—Å

if (elapsed > 1000) {
    ERROR_WARN(ERROR_CATEGORY_SYSTEM, TAG,
              "–û–ø–µ—Ä–∞—Ü–∏—è –∑–∞–Ω—è–ª–∞ %d –º—Å (–æ–∂–∏–¥–∞–ª–æ—Å—å < 1000)", elapsed);
}
```

## üì± –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–∞—Ç—á–∏–∫–∞–º–∏

### SHT3X (–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞/–í–ª–∞–∂–Ω–æ—Å—Ç—å)

```c
esp_err_t err = sht3x_read_temperature(&temp);
if (err == ESP_ERR_TIMEOUT) {
    ERROR_CHECK_SENSOR(err, "SHT3X",
                      "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ: –ø–∏—Ç–∞–Ω–∏–µ 2.4-5.5V, –∞–¥—Ä–µ—Å 0x44/0x45, SDA/SCL");
} else if (err == ESP_ERR_INVALID_CRC) {
    ERROR_CHECK_SENSOR(err, "SHT3X",
                      "–ü–æ–º–µ—Ö–∏ –Ω–∞ –ª–∏–Ω–∏–∏. –î–æ–±–∞–≤—å—Ç–µ pull-up —Ä–µ–∑–∏—Å—Ç–æ—Ä—ã");
}
```

### CCS811 (CO2)

```c
if (ccs811_is_data_ready()) {
    err = ccs811_read_co2(&co2);
    ERROR_CHECK_SENSOR(err, "CCS811", "–ß—Ç–µ–Ω–∏–µ CO2");
} else {
    ERROR_WARN(ERROR_CATEGORY_SENSOR, "CCS811",
              "–î–∞—Ç—á–∏–∫ –Ω–µ –≥–æ—Ç–æ–≤. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–µ–≤ 20 –º–∏–Ω—É—Ç");
}
```

### Trema pH/EC

```c
err = trema_ph_read(&ph_value);
if (err != ESP_OK) {
    if (ph_value < 0 || ph_value > 14) {
        ERROR_REPORT(ERROR_CATEGORY_SENSOR, err, "TREMA_PH",
                    "–ó–Ω–∞—á–µ–Ω–∏–µ –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞: %.2f (–æ–∂–∏–¥–∞–µ—Ç—Å—è 0-14)", ph_value);
    } else {
        ERROR_CHECK_SENSOR(err, "TREMA_PH", "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è pH");
    }
}
```

## üõ†Ô∏è –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫

```c
uint32_t total, critical, errors, warnings;
error_handler_get_stats(&total, &critical, &errors, &warnings);

ESP_LOGI(TAG, "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –≤—Å–µ–≥–æ=%lu, –∫—Ä–∏—Ç=%lu, –æ—à–∏–±–æ–∫=%lu, –ø—Ä–µ–¥—É–ø—Ä=%lu",
         total, critical, errors, warnings);

// –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
error_handler_clear_stats();
```

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π callback

```c
void my_error_callback(const error_info_t *error) {
    if (error->category == ERROR_CATEGORY_SENSOR) {
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–∞—Ç—á–∏–∫–æ–≤
        notify_user_via_buzzer();
    }
}

error_handler_register_callback(my_error_callback);
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–º–∏ –æ–∫–Ω–∞–º–∏

```c
// –û—Ç–∫–ª—é—á–∏—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ (—Ç–æ–ª—å–∫–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –ª–æ–≥)
error_handler_set_popup(false);

// –í–∫–ª—é—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
error_handler_set_popup(true);

// –°–º–µ–Ω–∏—Ç—å —à—Ä–∏—Ñ—Ç
extern const lv_font_t my_custom_font;
error_handler_set_font(&my_custom_font);
```

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏

### Guru Meditation Error

–ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ —É–ø–∞–ª–∞:
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ backtrace –∏–∑ –º–æ–Ω–∏—Ç–æ—Ä–∞
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: `xtensa-esp32s3-elf-addr2line -pfiaC -e build/hydroponics.elf –ê–î–†–ï–°`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä—ã —Å—Ç–µ–∫–æ–≤ –∑–∞–¥–∞—á
4. –í–∫–ª—é—á–∏—Ç–µ `CONFIG_ESP32_ENABLE_COREDUMP_TO_FLASH`

### Watchdog Timeout

```c
// –í –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
for (int i = 0; i < BIG_NUMBER; i++) {
    // –†–∞–±–æ—Ç–∞...
    
    if (i % 1000 == 0) {
        vTaskDelay(1); // –û—Ç–¥–∞—ë–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    }
}
```

### Stack Overflow

–£–≤–µ–ª–∏—á—å—Ç–µ —Ä–∞–∑–º–µ—Ä —Å—Ç–µ–∫–∞:
```c
xTaskCreate(my_task, "my_task", 
            4096,  // –ë—ã–ª–æ 2048, —É–≤–µ–ª–∏—á–∏–ª–∏
            NULL, 5, NULL);
```

## üìã –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º

- [ ] –í—Å–µ ERROR_REPORT –∏–º–µ—é—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- [ ] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –≥–¥–µ –Ω—É–∂–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã —Ä–∞–∑–º–µ—Ä—ã —Å—Ç–µ–∫–æ–≤ (>1KB —Å–≤–æ–±–æ–¥–Ω–æ)
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ heap –ø–∞–º—è—Ç—å (>20KB —Å–≤–æ–±–æ–¥–Ω–æ –≤ —Ä–∞–±–æ—Ç–µ)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –æ—à–∏–±–æ–∫
- [ ] –û—Ç–∫–ª—é—á–µ–Ω—ã DEBUG –ª–æ–≥–∏ –≤ production
- [ ] Watchdog –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- üìñ [ERROR_CODES_RU.md](ERROR_CODES_RU.md) - –ü–æ–ª–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–æ–¥–æ–≤
- üìò [README.md](README.md) - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è error_handler
- üåê [ESP-IDF Error Codes](https://docs.espressif.com/projects/esp-idf/en/latest/esp32s3/api-reference/error-codes.html)

---
**–ü–æ–¥—Å–∫–∞–∑–∫–∞**: –î–µ—Ä–∂–∏—Ç–µ —ç—Ç—É —à–ø–∞—Ä–≥–∞–ª–∫—É –æ—Ç–∫—Ä—ã—Ç–æ–π –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ! üöÄ

