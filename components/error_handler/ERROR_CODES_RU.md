# Справочник кодов ошибок ESP-IDF

Полная таблица кодов ошибок ESP-IDF с подробными описаниями на русском языке для системы обработки ошибок гидропонного монитора.

## Общие коды ошибок (ESP_ERR_*)

| Код | Значение | Название | Описание | Рекомендации |
|-----|----------|----------|----------|--------------|
| 0 | 0x0 | **ESP_OK** | Успешное выполнение | Ошибки нет |
| -1 | 0xFFFFFFFF | **ESP_FAIL** | Общая ошибка | Проверьте параметры функции и состояние системы |
| 257 | 0x101 | **ESP_ERR_NO_MEM** | Недостаточно памяти | Освободите память, уменьшите размеры буферов или увеличьте heap |
| 258 | 0x102 | **ESP_ERR_INVALID_ARG** | Недопустимый аргумент | Проверьте корректность переданных параметров |
| 259 | 0x103 | **ESP_ERR_INVALID_STATE** | Недопустимое состояние | Операция невозможна в текущем состоянии компонента |
| 260 | 0x104 | **ESP_ERR_INVALID_SIZE** | Недопустимый размер | Размер буфера или данных не соответствует требуемому |
| 261 | 0x105 | **ESP_ERR_NOT_FOUND** | Элемент не найден | Запрошенный ресурс, файл или устройство не существует |
| 262 | 0x106 | **ESP_ERR_NOT_SUPPORTED** | Операция не поддерживается | Функция недоступна для данного устройства или конфигурации |
| 263 | 0x107 | **ESP_ERR_TIMEOUT** | Превышено время ожидания | Операция заняла слишком много времени, проверьте устройство |
| 264 | 0x108 | **ESP_ERR_INVALID_RESPONSE** | Получен недопустимый ответ | Устройство вернуло некорректные данные |
| 265 | 0x109 | **ESP_ERR_INVALID_CRC** | Ошибка контрольной суммы | Данные повреждены при передаче |
| 266 | 0x10A | **ESP_ERR_INVALID_VERSION** | Несовместимая версия | Версия прошивки или протокола не поддерживается |
| 267 | 0x10B | **ESP_ERR_INVALID_MAC** | Недопустимый MAC-адрес | MAC-адрес имеет неверный формат |
| 268 | 0x10C | **ESP_ERR_NOT_FINISHED** | Операция не завершена | Асинхронная операция всё ещё выполняется |

## I2C специфичные ошибки

| Код | Значение | Название | Описание | Возможные причины | Решение |
|-----|----------|----------|----------|-------------------|---------|
| 263 | 0x107 | **ESP_ERR_TIMEOUT** | Таймаут I2C | • Устройство не отвечает<br>• Неправильный адрес<br>• Проблемы с линиями SDA/SCL | • Проверьте подключение проводов<br>• Убедитесь в правильности адреса<br>• Проверьте питание устройства |
| 4609 | 0x1201 | **ESP_ERR_I2C_BASE** | Базовая ошибка I2C | Общая ошибка шины I2C | Проверьте всю конфигурацию I2C |
| - | - | **NACK** | Устройство не подтвердило | • Устройство не готово<br>• Неверный адрес<br>• Устройство в режиме сна | • Подождите готовности<br>• Проверьте адрес (7-бит/8-бит)<br>• Выведите из сна |
| - | - | **BUS_BUSY** | Шина занята | Другая операция в процессе выполнения | Дождитесь завершения или используйте мьютекс |
| - | - | **ARBITRATION_LOST** | Потеря арбитража | Конфликт с другим мастером на шине | Редкая ошибка, обычно автоматически обрабатывается |

## NVS (Non-Volatile Storage) ошибки

| Код | Значение | Название | Описание | Причины | Действия |
|-----|----------|----------|----------|---------|----------|
| 4354 | 0x1102 | **ESP_ERR_NVS_NOT_INITIALIZED** | NVS не инициализирована | Не вызвана nvs_flash_init() | Вызовите nvs_flash_init() при старте |
| 4355 | 0x1103 | **ESP_ERR_NVS_NOT_FOUND** | Ключ не найден | Попытка прочитать несуществующий ключ | Проверьте имя ключа или создайте значение по умолчанию |
| 4356 | 0x1104 | **ESP_ERR_NVS_TYPE_MISMATCH** | Несоответствие типа | Тип данных не совпадает с ожидаемым | Используйте правильный тип (string, int, blob и т.д.) |
| 4357 | 0x1105 | **ESP_ERR_NVS_READ_ONLY** | Только для чтения | Попытка записи в режиме чтения | Откройте с правильным режимом доступа |
| 4358 | 0x1106 | **ESP_ERR_NVS_NOT_ENOUGH_SPACE** | Недостаточно места | NVS раздел переполнен | Очистите ненужные данные или увеличьте размер раздела |
| 4359 | 0x1107 | **ESP_ERR_NVS_INVALID_NAME** | Недопустимое имя | Имя ключа слишком длинное или содержит недопустимые символы | Используйте имена до 15 символов, только ASCII |
| 4360 | 0x1108 | **ESP_ERR_NVS_INVALID_HANDLE** | Недопустимый дескриптор | Используется закрытый или несуществующий дескриптор | Откройте NVS перед использованием |
| 4361 | 0x1109 | **ESP_ERR_NVS_REMOVE_FAILED** | Ошибка удаления | Не удалось удалить элемент | Проверьте права доступа и существование ключа |
| 4362 | 0x110A | **ESP_ERR_NVS_KEY_TOO_LONG** | Ключ слишком длинный | Имя ключа превышает 15 символов | Сократите имя ключа |
| 4363 | 0x110B | **ESP_ERR_NVS_PAGE_FULL** | Страница заполнена | Страница NVS не может принять больше данных | Используйте nvs_commit() или очистите данные |
| 4364 | 0x110C | **ESP_ERR_NVS_INVALID_STATE** | Недопустимое состояние | NVS в некорректном состоянии | Переинициализируйте NVS |
| 4365 | 0x110D | **ESP_ERR_NVS_INVALID_LENGTH** | Недопустимая длина | Длина данных некорректна | Проверьте размер данных |

## WiFi ошибки

| Код | Значение | Название | Описание | Причины |
|-----|----------|----------|----------|---------|
| 12289 | 0x3001 | **ESP_ERR_WIFI_NOT_INIT** | WiFi не инициализирован | Вызовите esp_wifi_init() |
| 12290 | 0x3002 | **ESP_ERR_WIFI_NOT_STARTED** | WiFi не запущен | Вызовите esp_wifi_start() |
| 12291 | 0x3003 | **ESP_ERR_WIFI_NOT_STOPPED** | WiFi не остановлен | WiFi всё ещё работает |
| 12292 | 0x3004 | **ESP_ERR_WIFI_IF** | Недопустимый интерфейс | Неверный номер интерфейса |
| 12293 | 0x3005 | **ESP_ERR_WIFI_MODE** | Недопустимый режим | Неверный режим WiFi (STA/AP) |
| 12294 | 0x3006 | **ESP_ERR_WIFI_STATE** | Недопустимое состояние | Операция невозможна в текущем состоянии |
| 12295 | 0x3007 | **ESP_ERR_WIFI_CONN** | Ошибка подключения | Не удалось подключиться к точке доступа |
| 12296 | 0x3008 | **ESP_ERR_WIFI_NVS** | Ошибка WiFi NVS | Проблема с сохранением конфигурации |
| 12297 | 0x3009 | **ESP_ERR_WIFI_MAC** | Недопустимый MAC | MAC-адрес имеет неверный формат |
| 12298 | 0x300A | **ESP_ERR_WIFI_SSID** | Недопустимый SSID | SSID слишком длинный или пустой |
| 12299 | 0x300B | **ESP_ERR_WIFI_PASSWORD** | Недопустимый пароль | Пароль некорректной длины (8-64 символа для WPA) |
| 12300 | 0x300C | **ESP_ERR_WIFI_TIMEOUT** | Таймаут WiFi | Превышено время ожидания подключения |

## HTTP ошибки

| Код | Значение | Название | Описание |
|-----|----------|----------|----------|
| 36865 | 0x9001 | **ESP_ERR_HTTP_BASE** | Базовая ошибка HTTP |
| 36866 | 0x9002 | **ESP_ERR_HTTP_MAX_REDIRECT** | Слишком много перенаправлений |
| 36867 | 0x9003 | **ESP_ERR_HTTP_CONNECT** | Ошибка подключения |
| 36868 | 0x9004 | **ESP_ERR_HTTP_WRITE_DATA** | Ошибка записи данных |
| 36869 | 0x9005 | **ESP_ERR_HTTP_FETCH_HEADER** | Ошибка получения заголовка |
| 36870 | 0x9006 | **ESP_ERR_HTTP_INVALID_TRANSPORT** | Недопустимый транспорт |
| 36871 | 0x9007 | **ESP_ERR_HTTP_CONNECTING** | Подключение в процессе |
| 36872 | 0x9008 | **ESP_ERR_HTTP_EAGAIN** | Повторите попытку позже |

## Специфичные ошибки датчиков

### SHT3X (Температура и влажность)

| Ситуация | Код | Описание | Действия |
|----------|-----|----------|----------|
| Устройство не отвечает | ESP_ERR_TIMEOUT (263) | Датчик не отвечает на команды | • Проверьте питание (2.4-5.5V)<br>• Проверьте I2C подключение<br>• Адрес: 0x44 или 0x45 |
| Неверная контрольная сумма | ESP_ERR_INVALID_CRC (265) | CRC данных не совпадает | • Помехи на линии<br>• Используйте pull-up резисторы<br>• Уменьшите длину проводов |
| Инициализация не удалась | ESP_ERR_INVALID_STATE (259) | Датчик в неправильном состоянии | • Перезагрузите датчик<br>• Проверьте последовательность команд |

### CCS811 (CO2 и качество воздуха)

| Ситуация | Код | Описание | Действия |
|----------|-----|----------|----------|
| Датчик не готов | ESP_ERR_INVALID_STATE (259) | CCS811 требует прогрева | • Подождите 20 минут после включения<br>• Проверьте регистр статуса |
| Ошибка чтения | ESP_ERR_TIMEOUT (263) | Нет ответа от датчика | • Адрес: 0x5A или 0x5B<br>• Проверьте WAK пин (LOW) |
| Неверный режим | ESP_ERR_NOT_SUPPORTED (262) | Режим измерения не поддерживается | Используйте режимы 1-4 (см. документацию) |

### Trema pH/EC

| Ситуация | Код | Описание | Действия |
|----------|-----|----------|----------|
| Нет ответа | ESP_ERR_TIMEOUT (263) | Модуль не отвечает | • Проверьте питание 5V<br>• Адрес pH: 0x4D, EC: 0x48 |
| Калибровка не завершена | ESP_ERR_INVALID_STATE (259) | Требуется калибровка | • Выполните калибровку<br>• Сохраните калибровку в NVS |
| Некорректные данные | ESP_ERR_INVALID_RESPONSE (264) | Данные вне допустимого диапазона | • pH: 0-14<br>• EC: 0-20000 μS/cm<br>• Проверьте датчик |

### Trema LUX (Освещённость)

| Ситуация | Код | Описание | Действия |
|----------|-----|----------|----------|
| Переполнение | ESP_ERR_INVALID_SIZE (260) | Слишком яркий свет | Используйте режим с меньшей чувствительностью |
| Недостаточно света | ESP_OK (0) с нулевым значением | Слишком темно | Нормальное значение в темноте |

## OTA (Over-The-Air Update) ошибки

| Код | Название | Описание | Решение |
|-----|----------|----------|---------|
| ESP_ERR_OTA_VALIDATE_FAILED | Проверка не пройдена | Образ прошивки повреждён | Скачайте заново, проверьте контрольную сумму |
| ESP_ERR_OTA_SELECT_INFO_INVALID | Недопустимая информация | Таблица разделов повреждена | Перепрошейте таблицу разделов |
| ESP_ERR_IMAGE_INVALID | Недопустимый образ | Формат образа некорректен | Используйте правильный формат .bin |

## FreeRTOS ошибки

| Ошибка | Причина | Решение |
|--------|---------|---------|
| Stack overflow | Переполнение стека задачи | Увеличьте размер стека в xTaskCreate |
| Watchdog timeout | Задача не отдаёт управление | • Добавьте vTaskDelay()<br>• Используйте taskYIELD()<br>• Проверьте бесконечные циклы |
| Memory allocation failed | Нет свободной heap памяти | • Освободите неиспользуемую память<br>• Увеличьте CONFIG_ESP32_HEAP_SIZE |

## Коды состояния HTTP

| Код | Название | Описание |
|-----|----------|----------|
| 200 | OK | Успешно |
| 400 | Bad Request | Неверный запрос |
| 401 | Unauthorized | Требуется авторизация |
| 404 | Not Found | Ресурс не найден |
| 500 | Internal Server Error | Внутренняя ошибка сервера |
| 503 | Service Unavailable | Сервис недоступен |

## Критические системные ошибки

| Ошибка | Описание | Немедленные действия |
|--------|----------|----------------------|
| **Guru Meditation Error** | Критический сбой системы | • Проверьте backtrace в логах<br>• Увеличьте размер стека<br>• Проверьте работу с памятью |
| **Core Panic** | Паника ядра процессора | • Проверьте на division by zero<br>• Проверьте доступ к памяти<br>• Проверьте выравнивание данных |
| **LoadProhibited** | Чтение из недопустимого адреса | Проверьте указатели на NULL |
| **StoreProhibited** | Запись в недопустимый адрес | Проверьте права доступа к памяти |
| **Illegal Instruction** | Недопустимая инструкция | Проверьте целостность прошивки |

## Рекомендации по обработке ошибок

### Приоритет действий при ошибках:

1. **CRITICAL** - Немедленная остановка и оповещение
   - ESP_ERR_NO_MEM - критическая нехватка памяти
   - Core Panic - сбой процессора
   - Watchdog timeout - зависание системы

2. **ERROR** - Требует внимания и исправления
   - ESP_ERR_TIMEOUT - превышено время ожидания
   - ESP_ERR_INVALID_CRC - повреждение данных
   - Ошибки датчиков

3. **WARNING** - Информирование о проблеме
   - ESP_ERR_NOT_FOUND - элемент не найден
   - Повторные попытки операции
   - Временные проблемы связи

4. **INFO** - Информационные сообщения
   - Успешное выполнение (ESP_OK)
   - Статус операций

### Типичные паттерны обработки:

```c
// Критическая операция с повторами
int retry_count = 3;
esp_err_t err;
do {
    err = sensor_read(&value);
    if (err == ESP_OK) break;
    
    ERROR_WARN(ERROR_CATEGORY_SENSOR, "SHT3X", 
              "Попытка %d из %d не удалась", 
              4 - retry_count, 3);
    vTaskDelay(pdMS_TO_TICKS(100));
} while (--retry_count > 0);

if (err != ESP_OK) {
    ERROR_REPORT(ERROR_CATEGORY_SENSOR, err, "SHT3X",
                "Не удалось прочитать датчик после 3 попыток");
}
```

## Отладка ошибок

### Включение расширенного логирования:

```c
// В menuconfig или sdkconfig
CONFIG_LOG_DEFAULT_LEVEL_DEBUG=y
CONFIG_LOG_DEFAULT_LEVEL=4
```

### Полезные команды:

```bash
# Расшифровка backtrace
xtensa-esp32s3-elf-addr2line -pfiaC -e build/hydroponics.elf 0x40081234

# Просмотр памяти
idf.py monitor

# Полный дамп при крахе
CONFIG_ESP32_ENABLE_COREDUMP_TO_FLASH=y
```

## Справка по форматированию

При использовании error_handler используйте осмысленные сообщения:

✅ **Хорошо:**
```c
ERROR_REPORT(ERROR_CATEGORY_I2C, err, "SHT3X",
            "Таймаут чтения температуры (адрес 0x44, попытка %d)", retry);
```

❌ **Плохо:**
```c
ERROR_REPORT(ERROR_CATEGORY_SENSOR, err, "SHT3X", "Error");
```

## Дополнительные ресурсы

- [ESP-IDF Error Codes](https://docs.espressif.com/projects/esp-idf/en/latest/esp32s3/api-reference/error-codes.html)
- [FreeRTOS Documentation](https://www.freertos.org/Documentation/)
- [I2C Specification](https://www.nxp.com/docs/en/user-guide/UM10204.pdf)

