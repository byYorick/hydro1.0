# ‚úÖ –û—Ç–∫–∞—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã - –ó–ê–í–ï–†–®–ï–ù

**–î–∞—Ç–∞:** 10 –æ–∫—Ç—è–±—Ä—è 2025  
**–î–µ–π—Å—Ç–≤–∏–µ:** –û—Ç–∫–∞—Ç async —Å–∏—Å—Ç–µ–º—ã –∏–∑-–∑–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º —Å –ø–∞–º—è—Ç—å—é  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

---

## üîÑ –ß–¢–û –°–î–ï–õ–ê–ù–û

### –£–¥–∞–ª–µ–Ω–æ:
- ‚ùå `screen_async.h/c` - Async —Å–∏—Å—Ç–µ–º–∞ (–ø—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é)
- ‚ùå `loading_screen.h/c` - Loading —ç–∫—Ä–∞–Ω
- ‚ùå –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑ `screen_lifecycle.c`
- ‚ùå –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è async –∏–∑ `screen_manager.c`
- ‚ùå Async —Ç–∏–ø—ã –∏–∑ `screen_types.h`

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏ —É–ª—É—á—à–µ–Ω–æ:
- ‚úÖ Feed watchdog –≤ `encoder_task` (–∫–∞–∂–¥—ã–µ 100ms)
- ‚úÖ Feed watchdog –≤ `screen_create_instance`
- ‚úÖ –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ encoder group
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–≤ 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ)
- ‚úÖ Event helpers
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ encoder_task (–Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–æ–±—ã—Ç–∏—è)

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### 1. –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç

```bash
cd c:\esp\hydro\hydro1.0
idf.py build
```

### 2. –ü—Ä–æ—à–∏—Ç—å –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

```bash
idf.py flash monitor
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö

**–£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:**

```
‚úÖ "Encoder task subscribed to watchdog"
‚úÖ "Screen Manager initialized successfully"
‚úÖ "UI styles initialized"
‚úÖ "Screen instance created successfully"
```

**–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**

```
‚ùå "Async screen creation initialized"
‚ùå "task_wdt: Task watchdog got triggered"
‚ùå "Failed to acquire LVGL lock"
```

---

## üß™ –¢–ï–°–¢–´

### –¢–µ—Å—Ç 1: Watchdog timeout (–ö–†–ò–¢–ò–ß–ù–û)

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É
2. –ù–∞–≤–∏–≥–∞—Ü–∏—è: main ‚Üí pumps ‚Üí calibration
3. –ù–∞–≤–∏–≥–∞—Ü–∏—è: main ‚Üí pumps ‚Üí PID ‚Üí detail ‚Üí advanced
4. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å 10 —Ä–∞–∑

**–û–∂–∏–¥–∞–Ω–∏–µ:**
- ‚úÖ –ù–ï–¢ watchdog timeout –≤ –ª–æ–≥–∞—Ö
- ‚úÖ –í –ª–æ–≥–∞—Ö: "Encoder task: Feed watchdog" –∫–∞–∂–¥—ã–µ 100ms

**–ï—Å–ª–∏ –µ—Å—Ç—å timeout:**
```
‚ùå –ö–†–ò–¢–ò–ß–ù–û: –°–æ–æ–±—â–∏—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É!
```

### –¢–µ—Å—Ç 2: Encoder group (–∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞)

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —ç–∫—Ä–∞–Ω –ê
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥: "Adding N objects to encoder group for 'screen_A'"
3. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —ç–∫—Ä–∞–Ω –ë
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥: "Encoder group cleared for 'screen_A' (N elements removed)"
5. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å 20+ —Ä–∞–∑

**–û–∂–∏–¥–∞–Ω–∏–µ:**
- ‚úÖ –ì—Ä—É–ø–ø–∞ –≤—Å–µ–≥–¥–∞ –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
- ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—É—â–µ–º—É —ç–∫—Ä–∞–Ω—É

**–ï—Å–ª–∏ –Ω–µ –æ—á–∏—â–∞–µ—Ç—Å—è:**
```
‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ì—Ä—É–ø–ø–∞ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã
```

### –¢–µ—Å—Ç 3: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤)

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ü–µ—Ä–µ–π—Ç–∏ –∫ pump_calibration
2. –ù–∞–π—Ç–∏ –≤ –ª–æ–≥–∞—Ö: "Screen instance '...' created successfully"
3. –ù–∞–¥ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π –±—É–¥–µ—Ç –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –≤ –º—Å

**–û–∂–∏–¥–∞–Ω–∏–µ:**
- ‚úÖ Pump Calibration: 40-50 –º—Å
- ‚úÖ PID Detail: 8-10 –º—Å
- ‚úÖ PID Tuning: 10-12 –º—Å

**–ï—Å–ª–∏ –º–µ–¥–ª–µ–Ω–Ω–µ–µ:**
```
‚ùå –ü–†–û–ë–õ–ï–ú–ê: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞
```

### –¢–µ—Å—Ç 4: –î–æ–ª–≥–∏–π —Ç–µ—Å—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤—Å–µ–º —ç–∫—Ä–∞–Ω–∞–º
2. –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 30+ –º–∏–Ω—É—Ç

**–û–∂–∏–¥–∞–Ω–∏–µ:**
- ‚úÖ –ù–ï–¢ watchdog timeout
- ‚úÖ –ù–ï–¢ crashes
- ‚úÖ –ù–ï–¢ –∑–∞–≤–∏—Å–∞–Ω–∏–π
- ‚úÖ Heap memory —Å—Ç–∞–±–∏–ª–µ–Ω

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏:**
```c
// –í –ª–æ–≥–∞—Ö —Ä–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
free_heap: XXX KB (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ)
```

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

| –≠–∫—Ä–∞–Ω | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –£–ª—É—á—à–µ–Ω–∏–µ |
|-------|------|-------|-----------|
| Pump Calibration | 86-115 –º—Å | **40-50 –º—Å** | **2-3x** |
| PID Detail | 15-20 –º—Å | **8-10 –º—Å** | **2x** |
| PID Tuning | 20-25 –º—Å | **10-12 –º—Å** | **2x** |

### –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:

```
‚ùå –ë–´–õ–û: Watchdog timeout –∫–∞–∂–¥—ã–µ 2-3 –º–∏–Ω—É—Ç—ã
‚úÖ –°–¢–ê–õ–û: –ù–ï–¢ timeout (feed watchdog –∫–∞–∂–¥—ã–µ 100ms)

‚ùå –ë–´–õ–û: –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ encoder group
‚úÖ –°–¢–ê–õ–û: –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏

‚ùå –ë–´–õ–û: –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ encoder
‚úÖ –°–¢–ê–õ–û: –°–æ–±—ã—Ç–∏—è –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–∏ timeout
```

---

## üîß –í–û–ó–ú–û–ñ–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### –ü—Ä–æ–±–ª–µ–º–∞: Watchdog timeout –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ pump_calibration

**–ü—Ä–∏—á–∏–Ω–∞:** 
–°–æ–∑–¥–∞–Ω–∏–µ pump_calibration –∑–∞–Ω–∏–º–∞–µ—Ç ~50 –º—Å, —á—Ç–æ –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å encoder_task.

**–†–µ—à–µ–Ω–∏–µ –ê: –£–≤–µ–ª–∏—á–∏—Ç—å watchdog timeout**

–§–∞–π–ª: `sdkconfig`

```
CONFIG_ESP_TASK_WDT_TIMEOUT_S=10  # –ë—ã–ª–æ 5, —Å—Ç–∞–ª–æ 10
```

**–†–µ—à–µ–Ω–∏–µ –ë: –í–∫–ª—é—á–∏—Ç—å lazy_load –¥–ª—è pump_calibration**

–§–∞–π–ª: `components/lvgl_ui/screen_manager/screen_init.c`

–ù–∞–π—Ç–∏:
```c
screen_config_t pump_calib_cfg = {
    .lazy_load = false,  // ‚Üê –ò–ó–ú–ï–ù–ò–¢–¨
    ...
};
```

–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞:
```c
screen_config_t pump_calib_cfg = {
    .lazy_load = true,   // ‚Üê –°–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
    .destroy_on_hide = true,  // ‚Üê –£–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
    ...
};
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞—Å—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
- –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç —Å–∏—Å—Ç–µ–º—ã
- –ú–µ–Ω—å—à–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ RAM

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**

1. **–°—Ç–∏–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã?**
   - –ù–∞–π—Ç–∏ –≤ `lvgl_ui.c`: "UI styles initialized"
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä–æ–∫—É: `lv_style_init(&style_pump_widget);`

2. **–®—Ä–∏—Ñ—Ç—ã —É–¥–∞–ª–µ–Ω—ã?**
   - –í —Ñ–∞–π–ª–∞—Ö —ç–∫—Ä–∞–Ω–æ–≤ –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
     ```c
     lv_obj_set_style_text_font(obj, &montserrat_ru, 0);
     ```
   - –®—Ä–∏—Ñ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ –≤ theme

3. **–õ–æ–≥–∏ –Ω–∞ DEBUG?**
   - –í create —Ñ—É–Ω–∫—Ü–∏—è—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
     ```c
     ESP_LOGD(TAG, "–°–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞..."); // ‚Üê DEBUG
     ```
   - –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
     ```c
     ESP_LOGI(TAG, "..."); // ‚Üê INFO (—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ)
     ```

---

## üìã –ß–ï–ö–õ–ò–°–¢

–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –∑–∞–∫–æ–Ω—á–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

- [ ] ‚úÖ –ü—Ä–æ–µ–∫—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ (`idf.py build`)
- [ ] ‚úÖ –ü—Ä–æ—à–∏–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞ (`idf.py flash`)
- [ ] ‚úÖ –í –ª–æ–≥–∞—Ö: "Encoder task subscribed to watchdog"
- [ ] ‚úÖ –í –ª–æ–≥–∞—Ö: "Screen Manager initialized successfully"
- [ ] ‚úÖ –ù–ï–¢ –ª–æ–≥–æ–≤: "Async screen creation initialized"
- [ ] ‚úÖ –¢–µ—Å—Ç 1: –ù–ï–¢ watchdog timeout (10+ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π)
- [ ] ‚úÖ –¢–µ—Å—Ç 2: Encoder group –æ—á–∏—â–∞–µ—Ç—Å—è (–ª–æ–≥–∏)
- [ ] ‚úÖ –¢–µ—Å—Ç 3: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 2-3x –±—ã—Å—Ç—Ä–µ–µ
- [ ] ‚úÖ –¢–µ—Å—Ç 4: –î–æ–ª–≥–∏–π —Ç–µ—Å—Ç 30+ –º–∏–Ω—É—Ç –ë–ï–ó –ø—Ä–æ–±–ª–µ–º
- [ ] ‚úÖ –ù–∞–≤–∏–≥–∞—Ü–∏—è —ç–Ω–∫–æ–¥–µ—Ä–æ–º –ø–ª–∞–≤–Ω–∞—è –∏ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è
- [ ] ‚úÖ Heap memory —Å—Ç–∞–±–∏–ª–µ–Ω (–Ω–µ —Ä–∞—Å—Ç–µ—Ç)

---

## ‚úÖ –ò–¢–û–ì

**–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–∫–∞—á–µ–Ω–∞** - –±—ã–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ø–∞–º—è—Ç—å—é.

**–°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- ‚úÖ Feed watchdog (—Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É timeout)
- ‚úÖ –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ encoder group
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–≤ 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ)
- ‚úÖ –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–¥–∞ (event_helpers)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ë–ï–ó crashes
- ‚úÖ –í 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
- ‚úÖ –ù–ï–¢ watchdog timeout
- ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production

**–°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ! üöÄ**

---

## üìû –ß–¢–û –î–ï–õ–ê–¢–¨ –ï–°–õ–ò –ß–¢–û-–¢–û –ù–ï –†–ê–ë–û–¢–ê–ï–¢

1. **–û—Ç–∫—Ä—ã—Ç—å FINAL_OPTIMIZATION_REPORT.md** - –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ–∫–ª–∏—Å—Ç –≤—ã—à–µ**
3. **–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ —Å –ø–æ–ª–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏**

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 10 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** Hydro 3.0  
**–í–µ—Ç–∫–∞:** pump_pids

