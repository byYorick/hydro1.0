# Исправление проблемы логирования в ISR в проекте гидропоники на ESP32-S3

## Описание проблемы

Устройство ESP32-S3 испытывало сбои во время начальной операции флаша дисплея LVGL. Сбой происходил из-за прерывания в функции `lock_acquire_generic`, когда попытка логирования отладки выполнялась из контекста службы прерываний (ISR).

### Первоначальная причина

1. LVGL инициирует операцию флаша дисплея
2. Это запускает SPI-транзакцию для панели LCD
3. SPI-транзакция завершается и вызывает обратный вызов из контекста ISR
4. Логирование отладки из ISR пытается захватить мьютекс, что запрещено
5. Это вызывает прерывание и панику системы

## Реализованные решения

### 1. Снижение уровня детализации логов

В [main/app_main.c](file:///c%3A/esp/hydro/hydro1.0/main/app_main.c) мы добавили код для снижения уровня логирования для проблемных компонентов:

```c
// Снижение уровня логирования для компонентов, которые могут логировать из контекста ISR
// Это предотвращает сбои из-за попытки захвата мьютекса в контексте прерывания
esp_log_level_set("spi_master", ESP_LOG_INFO);  // Снижение с DEBUG до INFO
esp_log_level_set("LCD", ESP_LOG_INFO);         // Снижение уровня логирования LCD
```

Это предотвращает генерацию логов отладки в контекстах ISR, устраняя проблему с захватом мьютекса.

### 2. Изменение SPI на режим опроса

В [components/lcd_ili9341/lcd_ili9341.c](file:///c%3A/esp/hydro/hydro1.0/components/lcd_ili9341/lcd_ili9341.c) мы изменили конфигурацию SPI для использования режима опроса вместо режима прерываний:

```c
esp_lcd_panel_io_spi_config_t io_config = {
    .dc_gpio_num = PIN_NUM_LCD_DC,
    .cs_gpio_num = PIN_NUM_LCD_CS,
    .pclk_hz = LCD_PIXEL_CLOCK_HZ,
    .lcd_cmd_bits = 8,
    .lcd_param_bits = 8,
    .spi_mode = 0,
    .trans_queue_depth = 0,  // Установка в 0 для режима опроса, чтобы избежать проблем с ISR
    .on_color_trans_done = notify_lvgl_flush_ready,
    .user_ctx = &disp_drv,
};
```

Установка `trans_queue_depth` в 0 включает режим опроса, который устраняет обратные вызовы ISR и связанные с ними проблемы логирования.

### 3. Отключение логирования отладки в критических секциях

В [components/lcd_ili9341/lcd_ili9341.c](file:///c%3A/esp/hydro/hydro1.0/components/lcd_ili9341/lcd_ili9341.c) мы закомментировали логирование отладки в критических секциях, которые могут вызываться из ISR:

```c
//ESP_LOGD("LCD", "notify_lvgl_flush_ready called");
```

Это предотвращает генерацию любых логов отладки в контекстах ISR.

## Тестирование исправления

Для проверки работоспособности исправления:

1. Прошейте обновленную прошивку на ESP32-S3
2. Отслеживайте вывод в последовательный порт на наличие сообщений паники
3. Убедитесь, что дисплей инициализируется правильно и отображает интерфейс
4. Подтвердите, что данные датчиков отображаются корректно

## Альтернативные решения

Если эти изменения не решат проблему, рассмотрите следующие альтернативы:

### Подход через menuconfig

Используйте `idf.py menuconfig` для изменения уровня детализации логов по умолчанию:
- Путь: Component config → Log output → Default log verbosity → Info

### Безопасное логирование в ISR

Для случаев, когда требуется логирование отладки в ISR:
- Замените `ESP_LOGD` на `ESP_DRAM_LOGD` (безопасно для ISR, но ограничено)
- Включите `CONFIG_LOG_MASTER_LEVEL=y` в menuconfig для буферизованных логов, безопасных для ISR
- Используйте `ESP_EARLY_LOGD` для критических логов в ISR

## Влияние на производительность

Подход с режимом опроса может иметь незначительное влияние на производительность по сравнению с режимом прерываний, но он обеспечивает лучшую стабильность. Влияние должно быть минимальным для большинства приложений с интерфейсом.

## Заключение

Эти изменения должны устранить проблему прерывания, вызванную захватом мьютекса в контексте ISR во время операций отображения LVGL. Решение отдает приоритет стабильности системы над максимальной производительностью, что уместно для этого приложения.