# Проект Гидропоники

Этот проект представляет собой систему управления гидропоникой на базе ESP32-S3 с поддержкой различных датчиков и управления насосами.

## Основные возможности

- Отображение данных с датчиков на LCD экране (ILI9341)
- Поддержка датчиков:
  - pH (Trema pH)
  - EC (Trema EC)
  - Температура и влажность (SHT3x)
  - Освещенность (Trema Lux)
  - CO2 (CCS811)
- Управление перистальтическими насосами для регулирования pH и EC
- Поддержка энкодера для навигации

## Поддерживаемые платы

| Поддерживаемые платы | ESP32 | ESP32-C2 | ESP32-C3 | ESP32-C6 | ESP32-H2 | ESP32-P4 | ESP32-S2 | ESP32-S3 |
| ------------------- | ----- | -------- | -------- | -------- | -------- | -------- | -------- | -------- |
|                     | ❌    | ❌       | ❌       | ❌       | ❌       | ❌       | ❌       | ✅       |

## Как использовать пример

### Необходимое оборудование

* Плата разработки ESP32-S3
* LCD панель ILI9341 с интерфейсом SPI
* Датчики pH, EC, температуры/влажности, освещенности и CO2
* Перистальтические насосы
* Энкодер
* USB кабель для питания и программирования

### Подключение оборудования

#### Подключение LCD ILI9341:

```
       ESP32-S3 Board                ILI9341 LCD Panel
┌──────────────────────┐         ┌────────────────────┐
│             GND      ├────────►│ GND                │
│             3V3      ├────────►│ VCC                │
│             GPIO12   ├────────►│ SCL (SCK)          │
│             GPIO11   ├────────►│ MOSI               │
│             GPIO9    ├────────►│ DC                 │
│             GPIO14   ├────────►│ RST                │
│             GPIO10   ├────────►│ CS                 │
│             GPIO15   ├────────►│ BLK (Backlight)    │
└──────────────────────┘         └────────────────────┘
```

#### Подключение датчиков I2C:

- SCL: GPIO17
- SDA: GPIO18

#### Подключение датчика освещенности Trema LUX:

Датчик Trema LUX подключается к I2C шине и использует адрес 0x12.
- VCC: 3.3V
- GND: GND
- SCL: GPIO17 (общая шина I2C)
- SDA: GPIO18 (общая шина I2C)

#### Подключение энкодера:

- CLK: GPIO1
- DT: GPIO2
- SW: GPIO3

#### Подключение насосов:

- pH кислотный насос: GPIO19 (IA), GPIO20 (IB)
- pH базовый насос: GPIO21 (IA), GPIO47 (IB)
- EC насос A: GPIO38 (IA), GPIO39 (IB)
- EC насос B: GPIO40 (IA), GPIO41 (IB)
- EC насос C: GPIO26 (IA), GPIO27 (IB)

### Сборка и прошивка

Для сборки и прошивки проекта выполните команду:

```
idf.py build flash monitor
```

Первый запуск сборки может занять больше времени, так как система сборки загрузит необходимые компоненты.

Для выхода из монитора последовательного порта нажмите `Ctrl-]`.

## Структура проекта

- `main/` - Основной код приложения
- `components/` - Компоненты проекта:
  - `ccs811/` - Драйвер датчика CO2
  - `encoder/` - Драйвер энкодера
  - `i2c_bus/` - Драйвер I2C шины
  - `lcd_ili9341/` - Драйвер LCD экрана
  - `lvgl_main/` - Главный интерфейс LVGL
  - `peristaltic_pump/` - Драйвер перистальтических насосов
  - `sht3x/` - Драйвер датчика температуры и влажности
  - `trema_ec/` - Драйвер датчика EC
  - `trema_lux/` - Драйвер датчика освещенности
  - `trema_ph/` - Драйвер датчика pH

## Использование датчика освещенности Trema LUX

Датчик Trema LUX предоставляет следующие функции:

```c
// Инициализация датчика
bool trema_lux_init(void);

// Чтение значения освещенности как целое число
bool trema_lux_read(uint16_t *lux);

// Чтение значения освещенности как число с плавающей точкой
bool trema_lux_read_float(float *lux);

// Установка значения по умолчанию (когда датчик не подключен)
void trema_lux_set_stub_value(uint16_t lux_value);

// Проверка, используется ли значение по умолчанию
bool trema_lux_is_using_stub_values(void);
```

Пример использования:

```c
#include "trema_lux.h"
#include "i2c_bus.h"

// Инициализация I2C шины и датчика
i2c_bus_init();
trema_lux_init();

// Чтение значения освещенности
uint16_t lux_value;
if (trema_lux_read(&lux_value)) {
    printf("Освещенность: %u lux\n", lux_value);
}
```

## Устранение неполадок

* Если экран не включается:
  * Проверьте уровень сигнала для включения подсветки экрана
  
* Если датчики не отвечают:
  * Проверьте подключение I2C (SCL и SDA)
  * Убедитесь, что адреса датчиков соответствуют указанным в коде
  * Проверьте питание датчиков (3.3V)
  
* Если датчик освещенности не работает:
  * Убедитесь, что датчик подключен к правильным контактам I2C
  * Проверьте адрес датчика (0x12)
  * Система автоматически переключится на значение по умолчанию, если датчик не отвечает

  все команды запускай в этом терминале C:\Windows\system32\cmd.exe /k ""C:\Espressif\idf_cmd_init.bat" esp-idf-ab7213b7273352b64422b1f400ff27a0"