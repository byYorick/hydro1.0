# –û—Ç—á–µ—Ç –æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ –∑–∞–¥–∞—á FreeRTOS

**–î–∞—Ç–∞:** 2025-10-05  
**–í–µ—Ä—Å–∏—è:** 3.0.1-modular

## üìã –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

–í—Å–µ –∑–∞–¥–∞—á–∏ FreeRTOS –≤—ã–Ω–µ—Å–µ–Ω—ã –∏–∑ `app_main.c` –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å `system_tasks` –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏ –∏ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –∫–æ–¥–∞.

---

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `system_tasks`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
components/system_tasks/
‚îú‚îÄ‚îÄ system_tasks.h       - –ó–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–π —Ñ–∞–π–ª —Å API
‚îú‚îÄ‚îÄ system_tasks.c       - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
‚îî‚îÄ‚îÄ CMakeLists.txt       - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–±–æ—Ä–∫–∏
```

### 2. –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑ `app_main.c`:

#### –ó–∞–¥–∞—á–∏ (7 —à—Ç—É–∫):
- ‚úÖ `sensor_task` - –ß—Ç–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–æ–≤
- ‚úÖ `display_task` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
- ‚úÖ `notification_task` - –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- ‚úÖ `data_logger_task` - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ `scheduler_task` - –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
- ‚úÖ `ph_ec_task` - –ö–æ–Ω—Ç—Ä–æ–ª—å pH/EC
- ‚úÖ `encoder_task` - –û–±—Ä–∞–±–æ—Ç–∫–∞ —ç–Ω–∫–æ–¥–µ—Ä–∞

#### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
- ‚úÖ –û—á–µ—Ä–µ–¥–∏ FreeRTOS (sensor_data_queue, encoder_queue)
- ‚úÖ –ú—å—é—Ç–µ–∫—Å—ã (sensor_data_mutex)
- ‚úÖ –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã –∑–∞–¥–∞—á
- ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤
- ‚úÖ –§—É–Ω–∫—Ü–∏—è —á—Ç–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞—Ç—á–∏–∫–æ–≤

### 3. –ù–æ–≤—ã–π API –º–æ–¥—É–ª—è `system_tasks`

```c
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
esp_err_t system_tasks_init_context(void);

// –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–¥–∞—á
esp_err_t system_tasks_create_all(system_task_handles_t *handles);

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
system_tasks_context_t* system_tasks_get_context(void);

// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤
system_task_handles_t* system_tasks_get_handles(void);

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–∞–¥–∞—á
esp_err_t system_tasks_stop_all(void);

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
esp_err_t system_tasks_get_stats(char *buffer, size_t size);
```

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### –î–æ:
```
app_main.c: 1374 —Å—Ç—Ä–æ–∫–∏
‚îú‚îÄ‚îÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (300 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ 7 –∑–∞–¥–∞—á FreeRTOS (600 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö (200 —Å—Ç—Ä–æ–∫)
‚îî‚îÄ‚îÄ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (274 —Å—Ç—Ä–æ–∫–∏)
```

### –ü–æ—Å–ª–µ:
```
app_main.c: ~800 —Å—Ç—Ä–æ–∫ (—É–ø—Ä–æ—â–µ–Ω –Ω–∞ 42%)
‚îú‚îÄ‚îÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (300 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ Callback —Ñ—É–Ω–∫—Ü–∏–∏ (200 —Å—Ç—Ä–æ–∫)
‚îî‚îÄ‚îÄ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (300 —Å—Ç—Ä–æ–∫)

system_tasks.c: ~600 —Å—Ç—Ä–æ–∫ (–Ω–æ–≤—ã–π –º–æ–¥—É–ª—å)
‚îú‚îÄ‚îÄ 7 –∑–∞–¥–∞—á FreeRTOS (400 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (100 —Å—Ç—Ä–æ–∫)
‚îî‚îÄ‚îÄ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (100 —Å—Ç—Ä–æ–∫)
```

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### 1. –ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ó–∞–¥–∞—á–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –º–æ–¥—É–ª–µ
- ‚úÖ –ß–µ—Ç–∫–æ–µ API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏
- ‚úÖ –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏

### 2. –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å
- ‚úÖ `app_main.c` —Å—Ç–∞–ª –Ω–∞ 42% –∫–æ—Ä–æ—á–µ
- ‚úÖ –§–æ–∫—É—Å –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏
- ‚úÖ –õ–æ–≥–∏–∫–∞ –∑–∞–¥–∞—á –æ—Ç–¥–µ–ª–µ–Ω–∞ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞

### 3. –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å
- ‚úÖ –ú–æ–¥—É–ª—å `system_tasks` –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ
- ‚úÖ –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —É–ø—Ä–æ—â–µ–Ω–æ
- ‚úÖ –õ–µ–≥–∫–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 4. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞–¥–∞—á–∞—Ö –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç `app_main.c`
- ‚úÖ –ü–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞

---

## üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `app_main.c`

### –£–¥–∞–ª–µ–Ω–æ:
```c
// ‚ùå –í—Å–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á
static QueueHandle_t sensor_data_queue = NULL;
static SemaphoreHandle_t sensor_data_mutex = NULL;
static TaskHandle_t sensor_task_handle = NULL;
// ... –∏ —Ç.–¥.

// ‚ùå –í—Å–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–∞—á
static void sensor_task(void *pvParameters) { ... }
static void display_task(void *pvParameters) { ... }
// ... –∏ —Ç.–¥.

// ‚ùå –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á
static esp_err_t create_system_tasks(void) { ... }

// ‚ùå –§—É–Ω–∫—Ü–∏—è —á—Ç–µ–Ω–∏—è –¥–∞—Ç—á–∏–∫–æ–≤
static esp_err_t read_all_sensors(sensor_data_t *data) { ... }
```

### –î–æ–±–∞–≤–ª–µ–Ω–æ:
```c
// ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è
#include "system_tasks.h"

// ‚úÖ –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã –∑–∞–¥–∞—á (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
static system_task_handles_t task_handles = {0};

// ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ app_main()
system_tasks_init_context();
system_tasks_create_all(&task_handles);
```

---

## üìù –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### `system_task_handles_t`
–°–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã –≤—Å–µ—Ö –∑–∞–¥–∞—á:
```c
typedef struct {
    TaskHandle_t sensor_task;
    TaskHandle_t display_task;
    TaskHandle_t notification_task;
    TaskHandle_t data_logger_task;
    TaskHandle_t scheduler_task;
    TaskHandle_t ph_ec_task;
    TaskHandle_t encoder_task;
} system_task_handles_t;
```

### `system_tasks_context_t`
–ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á:
```c
typedef struct {
    QueueHandle_t sensor_data_queue;
    QueueHandle_t encoder_queue;
    SemaphoreHandle_t sensor_data_mutex;
    sensor_data_t last_sensor_data;
    bool sensor_data_valid;
} system_tasks_context_t;
```

---

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–≤ app_main):
```c
// 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
if (system_tasks_init_context() != ESP_OK) {
    // –û—à–∏–±–∫–∞
}

// 2. –°–æ–∑–¥–∞—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏
system_task_handles_t handles;
if (system_tasks_create_all(&handles) != ESP_OK) {
    // –û—à–∏–±–∫–∞
}

// 3. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç!
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤:
```c
system_tasks_context_t *ctx = system_tasks_get_context();
if (ctx->sensor_data_valid) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º ctx->last_sensor_data
}
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
```c
char stats[256];
system_tasks_get_stats(stats, sizeof(stats));
ESP_LOGI(TAG, "%s", stats);
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ü–æ—Ä—è–¥–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:**
   - –°–Ω–∞—á–∞–ª–∞ `system_tasks_init_context()`
   - –ü–æ—Ç–æ–º `system_tasks_create_all()`

2. **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
   - –í—Å–µ –æ—á–µ—Ä–µ–¥–∏ –∏ –º—å—é—Ç–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –≤ `init_context()`
   - –î–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤ –∑–∞—â–∏—â–µ–Ω—ã `sensor_data_mutex`

3. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
   - –ú–æ–¥—É–ª—å —Ç—Ä–µ–±—É–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–∏
   - LVGL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –°—Ç—Ä–æ–∫ –≤ app_main.c | 800 (-42%) |
| –°—Ç—Ä–æ–∫ –≤ system_tasks.c | 600 (–Ω–æ–≤—ã–π) |
| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á | 7 |
| –†–∞–∑–º–µ—Ä API | 6 —Ñ—É–Ω–∫—Ü–∏–π |
| –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ | 15 –º–æ–¥—É–ª–µ–π |

---

## üéì –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã** –¥–ª—è `system_tasks`
2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å graceful shutdown** –∑–∞–¥–∞—á
3. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞—á
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** —Å–æ–±—ã—Ç–∏–π –∑–∞–¥–∞—á –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª
5. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ menuconfig

---

## ‚úÖ –°—Ç–∞—Ç—É—Å

**–ì–û–¢–û–í–û –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ**

–ú–æ–¥—É–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω. –í—Å–µ –∑–∞–¥–∞—á–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ, –Ω–æ –∫–æ–¥ —Å—Ç–∞–ª —á–∏—â–µ –∏ –ø–æ–Ω—è—Ç–Ω–µ–µ.

---

*–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 2025-10-05*
*–ê–≤—Ç–æ—Ä: Hydroponics Monitor Team*

