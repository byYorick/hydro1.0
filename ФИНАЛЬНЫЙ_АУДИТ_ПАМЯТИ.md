# 📊 ФИНАЛЬНЫЙ АУДИТ ПАМЯТИ ESP32-S3

**Дата:** 16 октября 2025  
**Проект:** Hydro System 1.0  
**Чип:** ESP32-S3 (328 KB DRAM, 8 MB PSRAM)

---

## 🎯 ТЕКУЩЕЕ СОСТОЯНИЕ ПАМЯТИ

### ESP32-S3 Архитектура памяти:

```
┌──────────────────────────────────────────────────────────┐
│  ВНУТРЕННЯЯ DRAM (Internal SRAM): 328 KB                 │
├──────────────────────────────────────────────────────────┤
│  .dram0.data (инициализированные):     15.4 KB           │
│  .dram0.bss (неинициализированные):   146.0 KB           │
│  ──────────────────────────────────────────────           │
│  ИТОГО СТАТИКА:                       161.4 KB           │
│                                                           │
│  Доступно для heap:                   182 KB             │
│  (3 региона: 129 KB + 21 KB + 32 KB)                    │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  ВНЕШНЯЯ PSRAM (External SPIRAM): 8 MB                   │
├──────────────────────────────────────────────────────────┤
│  .ext_ram.bss:                          7.4 KB           │
│  Доступно для heap:                  8179 KB             │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│  DMA ПАМЯТЬ (из DRAM heap)                               │
├──────────────────────────────────────────────────────────┤
│  LVGL буферы (spi_bus_dma_memory_alloc):                 │
│  - Buffer 1: 240 × 20 × 2 = 9.6 KB                       │
│  - Buffer 2: 240 × 20 × 2 = 9.6 KB                       │
│  ──────────────────────────────────────────────           │
│  ИТОГО DMA:                            19.2 KB            │
└──────────────────────────────────────────────────────────┘
```

---

## 🔍 САМЫЕ БОЛЬШИЕ ОБЪЕКТЫ В ПАМЯТИ

### ❌ КРИТИЧНО: Объекты в DRAM (BSS сегмент)

| Символ | Размер | Файл/Компонент | Можно на PSRAM? |
|--------|--------|----------------|-----------------|
| **work_mem_int$5** | **131072 B (128 KB)** | LVGL internal | ⚠️ НЕТ (внутренняя память LVGL) |
| **g_pid_log_buffer** | **8832 B (~8.6 KB)** | data_logger | ✅ **ДА** |
| **g_cnxMgr** | **3880 B (~3.8 KB)** | WiFi (cnx manager) | ❌ НЕТ (WiFi отключен) |
| **g_states** | **3120 B (~3 KB)** | adaptive_pid.c | ✅ **ДА** |
| **port_IntStack** | **3072 B (3 KB)** | FreeRTOS | ❌ НЕТ (критично для RTOS) |
| **g_ScanStruct** | **284 B** | WiFi scan | ❌ НЕТ (WiFi отключен) |
| **g_system_config** | **800 B** | main (config) | ✅ **ДА** |
| **s_cached_config** | **800 B** | main (cache) | ✅ **ДА** |
| **tasks** | **800 B** | task_scheduler | ⚠️ Зависит от частоты доступа |
| **sensor_history** | **1440 B** | lvgl_ui.c (графики) | ✅ **ДА** |
| **g_results** | **1848 B** | pid_auto_tuner.c | ✅ **ДА** |

### 📁 БОЛЬШИЕ ДАННЫЕ (DATA/RODATA сегмент - Flash)

| Символ | Размер | Компонент | Примечание |
|--------|--------|-----------|------------|
| **glyph_bitmap** (4 шт) | 6-15 KB каждый | Шрифты | ✅ Уже в Flash (RODATA) |
| **kern_class_values** (4 шт) | ~2-5 KB каждый | Шрифты (кернинг) | ✅ Уже в Flash (RODATA) |
| **glyph_dsc** (5 шт) | ~1-4 KB каждый | Шрифты | ✅ Уже в Flash (RODATA) |

---

## 💡 РЕКОМЕНДАЦИИ ПО ОПТИМИЗАЦИИ

### ✅ ПРИОРИТЕТ 1: Перенести на PSRAM (экономия ~18 KB DRAM)

#### 1. **g_pid_log_buffer** (~8.6 KB)
```c
// components/data_logger/data_logger.c:540
// БЫЛО:
static pid_log_entry_t g_pid_log_buffer[PID_LOG_BUFFER_SIZE];

// СТАНЕТ:
static pid_log_entry_t *g_pid_log_buffer = NULL;

// В init:
g_pid_log_buffer = heap_caps_malloc(
    sizeof(pid_log_entry_t) * PID_LOG_BUFFER_SIZE,
    MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT
);
```

**Выгода:** 8.6 KB DRAM → PSRAM  
**Риск:** Минимальный (редко используется)  
**Скорость:** PSRAM достаточно для логов

#### 2. **g_system_config + s_cached_config** (~1.6 KB)
```c
// main/app_main.c
// БЫЛО:
static system_config_t g_system_config;
static system_config_t s_cached_config;

// СТАНЕТ:
static system_config_t *g_system_config = NULL;
static system_config_t *s_cached_config = NULL;

// В app_main():
g_system_config = heap_caps_malloc(sizeof(system_config_t), MALLOC_CAP_SPIRAM);
s_cached_config = heap_caps_malloc(sizeof(system_config_t), MALLOC_CAP_SPIRAM);
```

**Выгода:** 1.6 KB DRAM → PSRAM  
**Риск:** Низкий (читается при старте, редко изменяется)  
**Скорость:** PSRAM достаточно

#### 3. **g_states** (~3 KB) - adaptive_pid
```c
// components/adaptive_pid/adaptive_pid.c:21
// БЫЛО:
static adaptive_pid_state_t g_states[PUMP_INDEX_COUNT];

// СТАНЕТ:
static adaptive_pid_state_t *g_states = NULL;

// В adaptive_pid_init():
if (g_states == NULL) {
    g_states = heap_caps_calloc(
        PUMP_INDEX_COUNT,
        sizeof(adaptive_pid_state_t),
        MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT
    );
    if (!g_states) {
        ESP_LOGE(TAG, "Failed to allocate adaptive PID states in PSRAM");
        return ESP_ERR_NO_MEM;
    }
    ESP_LOGI(TAG, "Adaptive PID states in PSRAM: %d bytes", 
             PUMP_INDEX_COUNT * sizeof(adaptive_pid_state_t));
}
```

**Выгода:** 3 KB DRAM → PSRAM  
**Риск:** Низкий (вычисления не критичны по скорости)  
**Скорость:** PSRAM достаточно для PID

#### 4. **g_results** (~1.8 KB) - pid_auto_tuner
```c
// components/pid_auto_tuner/pid_auto_tuner.c:21
// БЫЛО:
static tuning_result_t g_results[PUMP_INDEX_COUNT];

// СТАНЕТ:
static tuning_result_t *g_results = NULL;

// В pid_auto_tuner_init() или при первом использовании:
if (g_results == NULL) {
    g_results = heap_caps_calloc(
        PUMP_INDEX_COUNT,
        sizeof(tuning_result_t),
        MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT
    );
    if (!g_results) {
        ESP_LOGE(TAG, "Failed to allocate PID tuning results in PSRAM");
        return ESP_ERR_NO_MEM;
    }
    ESP_LOGI(TAG, "PID tuning results in PSRAM: %d bytes",
             PUMP_INDEX_COUNT * sizeof(tuning_result_t));
}
```

**Выгода:** 1.8 KB DRAM → PSRAM  
**Риск:** Минимальный (используется только при автонастройке)  
**Скорость:** PSRAM достаточно

#### 5. **sensor_history** (~1.4 KB) - lvgl_ui
```c
// components/lvgl_ui/lvgl_ui.c:247
// БЫЛО:
static lv_coord_t sensor_history[SENSOR_COUNT][HISTORY_POINTS];  // 6×60×4 = 1440 байт

// СТАНЕТ:
static lv_coord_t *sensor_history = NULL;

// В init_styles() или lvgl_main_init():
if (sensor_history == NULL) {
    sensor_history = heap_caps_calloc(
        SENSOR_COUNT * HISTORY_POINTS,
        sizeof(lv_coord_t),
        MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT
    );
    if (!sensor_history) {
        ESP_LOGE(TAG, "Failed to allocate sensor history in PSRAM");
        return ESP_ERR_NO_MEM;
    }
    ESP_LOGI(TAG, "Sensor history in PSRAM: %d bytes",
             SENSOR_COUNT * HISTORY_POINTS * sizeof(lv_coord_t));
}

// ВАЖНО: Обновить доступ к данным:
// БЫЛО: sensor_history[index][pos]
// СТАНЕТ: sensor_history[index * HISTORY_POINTS + pos]
```

**Выгода:** 1.4 KB DRAM → PSRAM  
**Риск:** Средний (требует изменение индексации)  
**Скорость:** PSRAM достаточно для графиков

---

### ⚠️ ПРИОРИТЕТ 2: Анализ и возможная оптимизация

#### 1. **work_mem_int$5** (128 KB) - LVGL внутренняя память
- Это LVGL working memory для операций рисования
- **НЕ переносим** - критично для производительности
- Уже настроено правильно через `lv_init()`
- Часть LVGL library, не наш код

#### 2. **g_states** (~3 KB)
- Требует анализа - найти где определено
- Возможно state machine для экранов или протокола

#### 3. **FreeRTOS Стеки задач**
```
Текущие размеры (в системе):
- LVGL task:      32768 байт (32 KB) ← БОЛЬШОЙ!
- Display task:   16384 байт (16 KB)
- Encoder task:   16384 байт (16 KB)
- Sensor task:    16384 байт (16 KB)
- Notification:   10240 байт (10 KB)
- Scheduler:       8192 байт (8 KB)
- Data logger:    14336 байт (14 KB)
- pH/EC ctrl:      8192 байт (8 KB)
```

**ПОТЕНЦИАЛЬНАЯ ОПТИМИЗАЦИЯ:**
Стеки нельзя перенести на PSRAM, но можно уменьшить:
- LVGL task: 32 KB → 24 KB (экономия 8 KB)
- Display task: 16 KB → 12 KB (экономия 4 KB)
- Encoder task: 16 KB → 12 KB (экономия 4 KB)

**ИТОГО:** ~16 KB DRAM

---

## 🚀 ПЛАН ОПТИМИЗАЦИИ ДЛЯ ВКЛЮЧЕНИЯ WiFi

### Этап 1: Перенос данных на PSRAM (~12 KB)

1. g_pid_log_buffer → PSRAM (8.6 KB)
2. g_system_config → PSRAM (0.8 KB)
3. s_cached_config → PSRAM (0.8 KB)
4. sensor_history → PSRAM (1.4 KB)
5. g_results → PSRAM (1.8 KB)

**ВЫГОДА:** ~13 KB DRAM освобождено

### Этап 2: Уменьшение стеков (~16 KB)

1. LVGL task: 32 → 24 KB (8 KB)
2. Display task: 16 → 12 KB (4 KB)
3. Encoder task: 16 → 12 KB (4 KB)

**ВЫГОДА:** ~16 KB DRAM освобождено

### Этап 3: Дополнительная оптимизация

1. Уменьшить LVGL буферы: 20 → 15 строк (экономия ~4.8 KB)
2. Оптимизировать WiFi буферы (уже сделано)

**ВЫГОДА:** ~5 KB DRAM освобождено

---

## 📈 ИТОГОВЫЙ РАСЧЁТ

```
╔════════════════════════════════════════════════════════════╗
║  ТЕКУЩЕЕ СОСТОЯНИЕ (без WiFi):                             ║
║  ──────────────────────────────────────────────────────     ║
║  Использовано DRAM BSS: ~146 KB                            ║
║  Свободно DRAM heap: ~163 KB (182 - 19 DMA)                ║
║  ════════════════════════════════════════════════════════   ║
║  ПОСЛЕ ОПТИМИЗАЦИЙ (План А):                               ║
║  ──────────────────────────────────────────────────────     ║
║  Этап 1 (PSRAM перенос):     +16.4 KB                      ║
║    • g_pid_log_buffer:         8.6 KB                      ║
║    • g_states:                 3.0 KB                      ║
║    • g_results:                1.8 KB                      ║
║    • configs:                  1.6 KB                      ║
║    • sensor_history:           1.4 KB                      ║
║                                                            ║
║  Этап 2 (Уменьшение стеков): +16.0 KB                      ║
║    • LVGL task: 32→24 KB       8.0 KB                      ║
║    • Display: 16→12 KB         4.0 KB                      ║
║    • Encoder: 16→12 KB         4.0 KB                      ║
║                                                            ║
║  Этап 3 (Оптимизация LVGL):   + 4.8 KB                     ║
║    • Буферы: 20→15 строк       4.8 KB                      ║
║  ──────────────────────────────────────────────────────     ║
║  ИТОГО освобождено:           +37.2 KB                     ║
║  Свободно DRAM heap:         ~200 KB                       ║
║  ════════════════════════════════════════════════════════   ║
║  WiFi требует минимум:        ~40 KB                       ║
║  ────────────────────────────────────────────────────────   ║
║  РЕЗУЛЬТАТ: 200 - 40 = 160 KB свободно                     ║
║  ✅ WIFI БУДЕТ РАБОТАТЬ С ЗАПАСОМ!                         ║
╚════════════════════════════════════════════════════════════╝
```

---

## ⚡ БЫСТРЫЙ СТАРТ ОПТИМИЗАЦИИ

### Шаг 1: Перенос g_pid_log_buffer на PSRAM

```c
// components/data_logger/data_logger.c

// ИЗМЕНИТЬ строку 540:
// static pid_log_entry_t g_pid_log_buffer[PID_LOG_BUFFER_SIZE];
static pid_log_entry_t *g_pid_log_buffer = NULL;

// Добавить в data_logger_init():
if (g_pid_log_buffer == NULL) {
    g_pid_log_buffer = heap_caps_calloc(
        PID_LOG_BUFFER_SIZE,
        sizeof(pid_log_entry_t),
        MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT
    );
    if (!g_pid_log_buffer) {
        ESP_LOGE(TAG, "Failed to allocate PID log buffer in PSRAM");
        return ESP_ERR_NO_MEM;
    }
    ESP_LOGI(TAG, "PID log buffer allocated in PSRAM: %d bytes", 
             PID_LOG_BUFFER_SIZE * sizeof(pid_log_entry_t));
}
```

### Шаг 2: Перенос конфигов на PSRAM

```c
// main/app_main.c

// ИЗМЕНИТЬ глобальные переменные:
// static system_config_t g_system_config;
// static system_config_t s_cached_config;
static system_config_t *g_system_config = NULL;
static system_config_t *s_cached_config = NULL;

// В app_main() ПЕРЕД использованием:
g_system_config = heap_caps_calloc(1, sizeof(system_config_t), MALLOC_CAP_SPIRAM);
s_cached_config = heap_caps_calloc(1, sizeof(system_config_t), MALLOC_CAP_SPIRAM);

// ВАЖНО: Все обращения к g_system_config заменить на *g_system_config или g_system_config->
```

### Шаг 3: Уменьшение стеков

```c
// components/lcd_ili9341/lcd_ili9341.c:94
#define LVGL_TASK_STACK_SIZE  (24 * 1024)  // Было 32 KB, стало 24 KB

// main/system_config.h
#define TASK_STACK_SIZE_DISPLAY       3072  // Было 4096
#define TASK_STACK_SIZE_ENCODER       3072  // Было 4096
```

---

## ❌ ПОЧЕМУ WiFi НЕ РАБОТАЕТ СЕЙЧАС

### Ошибка при инициализации:

```
W (3939) wifi:malloc buffer fail
E (3950) wifi:Expected to init 16 rx buffer, actual is 0
ESP_ERROR_CHECK failed: esp_err_t 0x101 (ESP_ERR_NO_MEM)
```

### Причина:

WiFi драйвер пытается выделить статические RX буферы из DRAM:
```
CONFIG_ESP_WIFI_STATIC_RX_BUFFER_NUM=16  (пользователь восстановил)
16 буферов × 1.6 KB = 25.6 KB
```

Но свободно DRAM heap только ~163 KB, из которых:
- FreeRTOS стеки: ~120 KB
- Мьютексы, очереди: ~10 KB
- LVGL DMA буферы: 19.2 KB
- Прочее: ~10 KB

**ОСТАЁТСЯ:** ~3-4 KB 😢

---

## 🎯 РЕАЛИЗАЦИЯ: ПОШАГОВЫЙ ПЛАН

### План А: Мин имальная оптимизация (для WiFi STA mode)

1. ✅ Перенос g_pid_log_buffer на PSRAM (+8.6 KB)
2. ✅ Перенос g_states на PSRAM (+3.0 KB)
3. ✅ Перенос g_results на PSRAM (+1.8 KB)
4. ✅ Перенос конфигов на PSRAM (+1.6 KB)
5. ✅ Перенос sensor_history на PSRAM (+1.4 KB)

**ИТОГО Этап 1 (PSRAM):** +16.4 KB DRAM

6. ✅ Уменьшение стеков (+16 KB)
7. ✅ Уменьшение LVGL буферов: 20→15 строк (+4.8 KB)

**ИТОГО:** +37.2 KB DRAM  
**РЕЗУЛЬТАТ:** WiFi **БУДЕТ РАБОТАТЬ**

### План Б: Агрессивная оптимизация (резерв)

1. Всё из Плана А (+37.2 KB)
2. Дополнительно уменьшить LVGL: 15→10 строк (+4.8 KB)
3. Уменьшить notification queue: 20 → 10 (+~1 KB)
4. Уменьшить sensor task stack: 16 → 12 KB (+4 KB)

**ИТОГО:** +47 KB DRAM  
**РЕЗУЛЬТАТ:** WiFi с большим запасом + место для роста

---

## 📝 ФАЙЛЫ ДЛЯ ИЗМЕНЕНИЯ

### 1. components/data_logger/data_logger.c
- Перенести `g_pid_log_buffer` на PSRAM
- Линия: 540
- Функция: `data_logger_init()` или создать новую функцию

### 2. components/adaptive_pid/adaptive_pid.c
- Перенести `g_states` на PSRAM
- Линия: 21
- Функция: `adaptive_pid_init()`

### 3. components/pid_auto_tuner/pid_auto_tuner.c
- Перенести `g_results` на PSRAM
- Линия: 21
- Функция: При первом использовании

### 4. components/lvgl_ui/lvgl_ui.c
- Перенести `sensor_history` на PSRAM
- Линии: 247-249
- Функция: `lvgl_main_init()` или `init_styles()`
- **ВАЖНО:** Изменить индексацию с [i][j] на [i*HISTORY_POINTS + j]

### 5. main/app_main.c
- Перенести `g_system_config` и `s_cached_config` на PSRAM
- Все обращения заменить на указатели (много мест!)
- **КРИТИЧНО:** Все `g_system_config.field` → `g_system_config->field`

### 6. components/lcd_ili9341/lcd_ili9341.c
- Уменьшить `LVGL_TASK_STACK_SIZE`: 32→24 KB (линия ~94)
- Уменьшить буферы: 20→15 строк (линия ~400)

### 7. main/system_config.h
- Уменьшить `TASK_STACK_SIZE_DISPLAY`: 16384→12288
- Уменьшить `TASK_STACK_SIZE_ENCODER`: 16384→12288
- Уменьшить `TASK_STACK_SIZE_SENSOR`: 16384→12288 (опционально)

---

## ⚠️ КРИТИЧЕСКИЙ ВЫВОД

**ESP32-S3 с 328 KB DRAM на грани возможностей для:**
- LVGL UI (требует быстрый DRAM для отрисовки)
- WiFi (требует ~40 KB DRAM для буферов)
- FreeRTOS (требует стеки для задач)

**Текущее решение:**
- LVGL работает отлично ✅
- WiFi отключен ❌

**Для включения WiFi:**
Нужно провести оптимизацию (План А или Б)

**Альтернатива:**
Использовать ESP32-S3 с большим DRAM (некоторые варианты имеют 512 KB)

---

## 📊 ИНСТРУМЕНТЫ ДЛЯ МОНИТОРИНГА

### Проверка DRAM во время выполнения:

```c
#include "esp_heap_caps.h"

// В критических точках:
size_t free_dram = heap_caps_get_free_size(MALLOC_CAP_INTERNAL);
size_t free_psram = heap_caps_get_free_size(MALLOC_CAP_SPIRAM);
ESP_LOGI("MEM", "Free DRAM: %d bytes, Free PSRAM: %d bytes", free_dram, free_psram);
```

### Проверка размера объектов:

```bash
# Самые большие символы в BSS:
xtensa-esp32s3-elf-nm --size-sort --print-size hydroponics.elf | grep " B "

# Размер секций:
xtensa-esp32s3-elf-size -A hydroponics.elf
```

---

## ✅ ЗАКЛЮЧЕНИЕ

**Текущее состояние:**
- ✅ LVGL работает стабильно (19.2 KB DMA буферы)
- ✅ Все датчики, насосы, UI работают
- ✅ Система стабильна
- ❌ WiFi отключен (недостаточно DRAM)

**Для включения WiFi:**
Реализовать План А (экономия 31 KB DRAM) - **РЕКОМЕНДУЕТСЯ**

**Прогноз:**
После оптимизации WiFi **ДОЛЖЕН работать** с запасом ~20 KB DRAM.

---

**Отчёт составлен:** 16 октября 2025, 15:45  
**Статус:** Готов к оптимизации 🚀

