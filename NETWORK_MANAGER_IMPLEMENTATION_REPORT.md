# üì° –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Network Manager

**–î–∞—Ç–∞:** 16 –æ–∫—Ç—è–±—Ä—è 2025  
**–ü—Ä–æ–µ–∫—Ç:** Hydro System 1.0 (ESP32-S3)  
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù - —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π Network Manager —Å –Ω—É–ª—è

**–§–∞–π–ª—ã:**
- `components/network_manager/network_manager.h` - –Ω–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
- `components/network_manager/network_manager.c` - —á–∏—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- `components/network_manager/CMakeLists.txt` - —Å–±–æ—Ä–∫–∞

**API:**
```c
esp_err_t network_manager_init(void);
esp_err_t network_manager_deinit(void);
esp_err_t network_manager_connect(const char *ssid, const char *password);
esp_err_t network_manager_disconnect(void);
esp_err_t network_manager_scan(wifi_scan_result_t *results, uint16_t max_results, uint16_t *actual_count);
esp_err_t network_manager_get_info(wifi_info_t *info);
bool network_manager_is_connected(void);
esp_err_t network_manager_save_credentials(void);
esp_err_t network_manager_load_and_connect(void);
esp_err_t network_manager_get_mac(char *mac_str, size_t len);
```

### 2. –°–æ–∑–¥–∞–Ω –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π WiFi —ç–∫—Ä–∞–Ω

**–§–∞–π–ª—ã:**
- `components/lvgl_ui/screens/system/wifi_settings_screen.h`
- `components/lvgl_ui/screens/system/wifi_settings_screen.c`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- ‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ WiFi —Å–µ—Ç–µ–π
- ‚úÖ –í—ã–±–æ—Ä —Å–µ—Ç–∏ –∏–∑ —Å–ø–∏—Å–∫–∞
- ‚úÖ –í–≤–æ–¥ –ø–∞—Ä–æ–ª—è (lv_textarea —Å password mode)
- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏
- ‚úÖ –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç —Å–µ—Ç–∏
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (RSSI, IP –∞–¥—Ä–µ—Å)
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ credentials –≤ NVS
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å–µ—Ç–µ–π
- ‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ–µ–∫—Ç

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `main/app_main.c` - –¥–æ–±–∞–≤–ª–µ–Ω include –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
- `main/CMakeLists.txt` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `network_manager`
- `components/lvgl_ui/CMakeLists.txt` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `network_manager`
- `components/lvgl_ui/screens/system/system_screens.c` - –ø–æ–¥–∫–ª—é—á–µ–Ω WiFi —ç–∫—Ä–∞–Ω

### 4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Ä–∞–∑–¥–µ–ª–æ–≤

**partitions.csv:**
```csv
nvs,        data, nvs,     0x9000,   0x6000,
phy_init,   data, phy,     0xf000,   0x1000,
factory,    app,  factory, 0x10000,  0x3F0000,  # 4MB –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```

–£–±—Ä–∞–Ω—ã OTA —Ä–∞–∑–¥–µ–ª—ã (ota_0, ota_1) - –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ 4MB Flash –ø–∞–º—è—Ç–∏.

---

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ DRAM

### –°–∏–º–ø—Ç–æ–º—ã:
```
region `dram0_0_seg' overflowed by 10760 bytes
```

### –ü—Ä–∏—á–∏–Ω–∞:
WiFi –¥—Ä–∞–π–≤–µ—Ä ESP-IDF —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ DRAM –¥–ª—è:
- –ë—É—Ñ–µ—Ä–æ–≤ –ø—Ä–∏–µ–º–∞/–ø–µ—Ä–µ–¥–∞—á–∏
- –û—á–µ—Ä–µ–¥–µ–π —Å–æ–±—ã—Ç–∏–π
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö

### –ü–æ–ø—ã—Ç–∫–∏ —Ä–µ—à–µ–Ω–∏—è:

1. ‚úÖ **–í–∫–ª—é—á–µ–Ω SPIRAM –¥–ª—è WiFi/LWIP:**
   - `CONFIG_SPIRAM_TRY_ALLOCATE_WIFI_LWIP=y`
   - `CONFIG_SPIRAM_ALLOW_BSS_SEG_EXTERNAL_MEMORY=y`

2. ‚úÖ **–£–º–µ–Ω—å—à–µ–Ω—ã –±—É—Ñ–µ—Ä—ã WiFi:**
   - `CONFIG_ESP_WIFI_STATIC_RX_BUFFER_NUM=4` (–±—ã–ª–æ 10)
   - `CONFIG_ESP_WIFI_DYNAMIC_RX_BUFFER_NUM=8` (–±—ã–ª–æ 32)
   - `CONFIG_ESP_WIFI_DYNAMIC_TX_BUFFER_NUM=8` (–±—ã–ª–æ 32)
   - `CONFIG_ESP_WIFI_MGMT_SBUF_NUM=8` (–±—ã–ª–æ 32)
   - `CONFIG_ESP_WIFI_RX_MGMT_BUF_NUM_DEF=3` (–±—ã–ª–æ 5)

3. ‚úÖ **–û—Ç–∫–ª—é—á–µ–Ω AMPDU:**
   - `# CONFIG_ESP_WIFI_AMPDU_TX_ENABLED is not set`
   - `# CONFIG_ESP_WIFI_AMPDU_RX_ENABLED is not set`

4. ‚úÖ **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤ WiFi —ç–∫—Ä–∞–Ω–µ:**
   - –ú–∞—Å—Å–∏–≤ —Å–µ—Ç–µ–π `g_scanned_networks` —Ç–µ–ø–µ—Ä—å –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
   - –£–º–µ–Ω—å—à–µ–Ω–æ MAX_NETWORKS —Å 16 –¥–æ 10

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
–ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ —É–º–µ–Ω—å—à–∏–ª–æ—Å—å —Å **23392 –±–∞–π—Ç** –¥–æ **10760 –±–∞–π—Ç**, –Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è.

---

## üîß –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —à–∞–≥–∏ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è WiFi

### –í–∞—Ä–∏–∞–Ω—Ç 1: –î–∞–ª—å–Ω–µ–π—à–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è DRAM

1. **–£–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã —Å—Ç–µ–∫–æ–≤ –∑–∞–¥–∞—á:**
   - `CONFIG_MAIN_TASK_STACK_SIZE` (—Å–µ–π—á–∞—Å 8192)
   - `CONFIG_FREERTOS_IDLE_TASK_STACKSIZE` (—Å–µ–π—á–∞—Å 1536)
   - –°—Ç–µ–∫–∏ –∑–∞–¥–∞—á –≤ `app_main.c` (sensor_task, display_task –∏ —Ç.–¥.)

2. **–û—Ç–∫–ª—é—á–∏—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
   - Bluetooth (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
   - WPA3 (–µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–∞ –ø–æ–≤—ã—à–µ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
   - WiFi provisioning

3. **–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –≤ SPIRAM:**
   - `CONFIG_SPIRAM_ALLOW_BSS_SEG_EXTERNAL_MEMORY=y` (—É–∂–µ –≤–∫–ª—é—á–µ–Ω–æ)
   - –ê—Ç—Ä–∏–±—É—Ç `EXT_RAM_BSS_ATTR` –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–∞—Å—Å–∏–≤–æ–≤

### –í–∞—Ä–∏–∞–Ω—Ç 2: –£–ø—Ä–æ—Å—Ç–∏—Ç—å WiFi —ç–∫—Ä–∞–Ω

1. –£–±—Ä–∞—Ç—å –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π UI)
2. –£–º–µ–Ω—å—à–∏—Ç—å MAX_NETWORKS –¥–æ 5
3. –£–±—Ä–∞—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞

### –í–∞—Ä–∏–∞–Ω—Ç 3: –õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WiFi

–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å WiFi —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —ç–∫—Ä–∞–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫, –¥–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏.

---

## üìã –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

### ‚úÖ –ì–æ—Ç–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- Network Manager (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω)
- WiFi Settings Screen (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ–µ–∫—Ç (–∑–∞–≤–µ—Ä—à–µ–Ω–∞)

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã:
- DRAM overflow ~10KB
- WiFi –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω –≤ `app_main.c`

### üîú –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DRAM (idf.py size-components)
2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä—ã —Å—Ç–µ–∫–æ–≤
3. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ª–µ–Ω–∏–≤—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é WiFi
4. –í–∫–ª—é—á–∏—Ç—å WiFi –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

## üìÑ –ö–æ–¥ –≥–æ—Ç–æ–≤, –Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω

–í `main/app_main.c` WiFi –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞:
```c
// –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û - –ø—Ä–æ–±–ª–µ–º–∞ DRAM overflow (~10KB)
// TODO: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∞–º—è—Ç—å –ø–µ—Ä–µ–¥ –≤–∫–ª—é—á–µ–Ω–∏–µ–º WiFi
/*
ret = network_manager_init();
...
*/
ESP_LOGW(TAG, "  [SKIP] Network Manager - requires DRAM optimization first");
```

WiFi —ç–∫—Ä–∞–Ω –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –º–µ–Ω—é, –Ω–æ –±—É–¥–µ—Ç –≤—ã–¥–∞–≤–∞—Ç—å –æ—à–∏–±–∫—É –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Ä–∞–±–æ—Ç—ã —Å WiFi.

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô –ü–û–î–•–û–î**: –õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

1. –ù–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å WiFi –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å WiFi —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ WiFi —ç–∫—Ä–∞–Ω–∞
3. –î–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —ç–∫—Ä–∞–Ω–∞
4. –≠–∫–æ–Ω–æ–º–∏—è: ~10KB DRAM –∫–æ–≥–¥–∞ WiFi –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```c
// –í wifi_settings_screen_on_show():
network_manager_init();
network_manager_load_and_connect();

// –í wifi_settings_screen_on_hide():
network_manager_deinit();
```

---

**–ì–æ—Ç–æ–≤ –∫ –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏!** üöÄ

