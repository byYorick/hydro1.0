# üîç –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–∞–º—è—Ç–∏: –ü–æ—á–µ–º—É —Å–ª–æ–º–∞–ª–æ—Å—å –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**–î–∞—Ç–∞:** 2025-10-16  
**–ü—Ä–æ–±–ª–µ–º–∞:** –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–ª–æ, –ø–æ—Å–ª–µ - mutex contention –∏ watchdog timeout  

---

## üìä –ß–¢–û –ë–´–õ–û –î–û –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò (—Ä–∞–±–æ—Ç–∞–ª–æ!)

### –ò—Å—Ö–æ–¥–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è LVGL –±—É—Ñ–µ—Ä–æ–≤:

```c
// components/lcd_ili9341/lcd_ili9341.c (–æ—Ä–∏–≥–∏–Ω–∞–ª)

static lv_color_t disp_buf1[LCD_H_RES * 60];  // 28.8 KB –≤ SRAM
static lv_color_t disp_buf2[LCD_H_RES * 60];  // 28.8 KB –≤ SRAM

// –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:
‚úÖ –†–∞–∑–º–µ—â–µ–Ω—ã –≤ SRAM (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –±—ã—Å—Ç—Ä–∞—è –ø–∞–º—è—Ç—å)
‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∞—Å—Å–∏–≤—ã (–≤—ã–¥–µ–ª—è—é—Ç—Å—è –ø—Ä–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏)
‚úÖ –î–æ—Å—Ç—É–ø: ~1 —Ü–∏–∫–ª (240 MHz)
‚úÖ SPI DMA —á–∏—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –∏–∑ SRAM
‚úÖ Flush –∑–∞–Ω–∏–º–∞–µ—Ç ~20-30 –º—Å
```

### –ü–æ—á–µ–º—É —Ä–∞–±–æ—Ç–∞–ª–æ:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ LVGL timer task                     ‚îÇ
‚îÇ   ‚Üì                                 ‚îÇ
‚îÇ lv_timer_handler()                  ‚îÇ
‚îÇ   ‚Üì                                 ‚îÇ
‚îÇ lvgl_flush_cb()                     ‚îÇ
‚îÇ   ‚Üì                                 ‚îÇ
‚îÇ esp_lcd_panel_draw_bitmap()         ‚îÇ
‚îÇ   ‚Üì                                 ‚îÇ
‚îÇ SPI DMA —á–∏—Ç–∞–µ—Ç –∏–∑ SRAM ‚ö°           ‚îÇ
‚îÇ   ‚Üì –ë–´–°–¢–†–û: 20-30 –º—Å                ‚îÇ
‚îÇ wait_for_flushing()                 ‚îÇ
‚îÇ   ‚Üì –ñ–¥–µ—Ç 20-30 –º—Å                   ‚îÇ
‚îÇ –ì–æ—Ç–æ–≤–æ! ‚úÖ                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Mutex held time: ~50-80 –º—Å
Display task timeout: 100 –º—Å ‚úÖ –£—Å–ø–µ–≤–∞–µ—Ç!
```

---

## üìä –ß–¢–û –°–¢–ê–õ–û –ü–û–°–õ–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!)

### –ù–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è LVGL –±—É—Ñ–µ—Ä–æ–≤:

```c
// components/lcd_ili9341/lcd_ili9341.c (–ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)

// –ë—É—Ñ–µ—Ä—ã –≤ PSRAM
disp_buf1 = heap_caps_malloc(LCD_H_RES * 40 * sizeof(lv_color_t), MALLOC_CAP_SPIRAM);  // 19.2 KB
disp_buf2 = heap_caps_malloc(LCD_H_RES * 40 * sizeof(lv_color_t), MALLOC_CAP_SPIRAM);  // 19.2 KB

// –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:
‚ö†Ô∏è –†–∞–∑–º–µ—â–µ–Ω—ã –≤ PSRAM (–≤–Ω–µ—à–Ω—è—è –º–µ–¥–ª–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å)
‚ö†Ô∏è –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ (malloc)
‚ö†Ô∏è –î–æ—Å—Ç—É–ø: ~4-8 —Ü–∏–∫–ª–æ–≤ (80 MHz OCT mode)
‚ö†Ô∏è SPI DMA –¥–æ–ª–∂–µ–Ω —á–∏—Ç–∞—Ç—å —á–µ—Ä–µ–∑ cache –∏–∑ PSRAM
‚ö†Ô∏è Flush –∑–∞–Ω–∏–º–∞–µ—Ç ~100-500 –º—Å! ‚Üê –ü–†–û–ë–õ–ï–ú–ê!
```

### –ü–æ—á–µ–º—É –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ LVGL timer task                     ‚îÇ
‚îÇ   ‚Üì                                 ‚îÇ
‚îÇ lv_timer_handler()                  ‚îÇ
‚îÇ   ‚Üì                                 ‚îÇ
‚îÇ lvgl_flush_cb()                     ‚îÇ
‚îÇ   ‚Üì                                 ‚îÇ
‚îÇ esp_lcd_panel_draw_bitmap()         ‚îÇ
‚îÇ   ‚Üì                                 ‚îÇ
‚îÇ SPI DMA —á–∏—Ç–∞–µ—Ç –∏–∑ PSRAM üêå          ‚îÇ
‚îÇ   ‚Üì –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å PSRAM: 4-8x         ‚îÇ
‚îÇ   ‚Üì Cache misses                    ‚îÇ
‚îÇ   ‚Üì –ú–µ–¥–ª–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø                ‚îÇ
‚îÇ   ‚Üì –ú–ï–î–õ–ï–ù–ù–û: 100-500 –º—Å! ‚ö†Ô∏è        ‚îÇ
‚îÇ wait_for_flushing()                 ‚îÇ
‚îÇ   ‚Üì –ñ–¥–µ—Ç 100-500 –º—Å                 ‚îÇ
‚îÇ   ‚Üì –î–µ—Ä–∂–∏—Ç mutex 500+ –º—Å            ‚îÇ
‚îÇ   ‚Üì Watchdog timeout! ‚ùå            ‚îÇ
‚îÇ Display task –ù–ï –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å mutex‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Mutex held time: 100-500+ –º—Å ‚ùå
Display task timeout: 500 –º—Å ‚ùå –ù–ï —É—Å–ø–µ–≤–∞–µ—Ç!
Watchdog timeout: > 5000 –º—Å ‚ùå
```

---

## üî¥ –ö–û–†–ï–ù–¨ –ü–†–û–ë–õ–ï–ú–´

### ESP32-S3 SPI DMA + PSRAM = –ü–†–û–ë–õ–ï–ú–ê!

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞:**

1. **SPI DMA –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä ESP32-S3:**
   - –ú–æ–∂–µ—Ç –Ω–∞–ø—Ä—è–º—É—é —á–∏—Ç–∞—Ç—å –∏–∑ SRAM (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ø–∞–º—è—Ç—å)
   - –ù–ï –º–æ–∂–µ—Ç –Ω–∞–ø—Ä—è–º—É—é —á–∏—Ç–∞—Ç—å –∏–∑ PSRAM (–≤–Ω–µ—à–Ω—è—è –ø–∞–º—è—Ç—å)
   - –ù—É–∂–µ–Ω –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –±—É—Ñ–µ—Ä –∏–ª–∏ cache

2. **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–∑ PSRAM:**
   ```
   SPI DMA request ‚Üí CPU cache ‚Üí PSRAM read ‚Üí Cache fill ‚Üí DMA read ‚Üí SPI transfer
   
   –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:
   - SRAM: 1 —Ü–∏–∫–ª (4 –Ω—Å @ 240 MHz)
   - PSRAM: 4-8 —Ü–∏–∫–ª–æ–≤ + cache overhead (40-80 –Ω—Å @ 80 MHz)
   - –†–∞–∑–Ω–∏—Ü–∞: 10-20x –º–µ–¥–ª–µ–Ω–Ω–µ–µ!
   ```

3. **–î–ª—è 19.2 KB –±—É—Ñ–µ—Ä–∞:**
   - –ò–∑ SRAM: 19200 bytes / (40 MHz SPI / 16) ‚âà 15 –º—Å
   - –ò–∑ PSRAM: 15 –º—Å √ó 10-20x –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å ‚âà **150-300 –º—Å!**
   - –ü—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö flush: **500-1000 –º—Å!**

---

## üí° –†–ï–®–ï–ù–ò–Ø

### –í–∞—Ä–∏–∞–Ω—Ç 1: ‚≠ê –í–µ—Ä–Ω—É—Ç—å –±—É—Ñ–µ—Ä—ã –≤ DRAM —Å DMA capability

```c
// –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º PSRAM, –∏—Å–ø–æ–ª—å–∑—É–µ–º DRAM —Å DMA —Ñ–ª–∞–≥–æ–º
disp_buf1 = heap_caps_malloc(LCD_H_RES * 40 * sizeof(lv_color_t), 
                              MALLOC_CAP_DMA | MALLOC_CAP_INTERNAL);
disp_buf2 = heap_caps_malloc(LCD_H_RES * 40 * sizeof(lv_color_t), 
                              MALLOC_CAP_DMA | MALLOC_CAP_INTERNAL);
```

**–ü–ª—é—Å—ã:**
- ‚úÖ SPI DMA –Ω–∞–ø—Ä—è–º—É—é –∏–∑ DRAM ‚Üí –±—ã—Å—Ç—Ä–æ!
- ‚úÖ Flush –∑–∞ 20-30 –º—Å –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- ‚úÖ Mutex hold time < 100 –º—Å
- ‚úÖ –ù–µ—Ç watchdog timeout

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ó–∞–Ω–∏–º–∞–µ—Ç 38.4 KB DRAM (–±—É—Ñ–µ—Ä—ã 2√ó19.2 KB)
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å DRAM overflow (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å!)

**–ü—Ä–æ–≤–µ—Ä–∫–∞ DRAM:**
```
–¢–µ–∫—É—â–∞—è DRAM: 266 KB / 328 KB (77.8%)
–ï—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å 38.4 KB –±—É—Ñ–µ—Ä—ã: 304 KB / 328 KB (92.7%)
–°–≤–æ–±–æ–¥–Ω–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è: 24 KB ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ –º–∞–ª–æ (–∫–∞–∫ –±—ã–ª–æ –¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –£–º–µ–Ω—å—à–∏—Ç—å –±—É—Ñ–µ—Ä—ã –¥–æ –º–∏–Ω–∏–º—É–º–∞

```c
// –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –±—É—Ñ–µ—Ä—ã 10-20 —Å—Ç—Ä–æ–∫
disp_buf1 = heap_caps_malloc(LCD_H_RES * 10 * sizeof(lv_color_t), 
                              MALLOC_CAP_DMA | MALLOC_CAP_INTERNAL);
```

**–†–∞—Å—á–µ—Ç:**
- 10 —Å—Ç—Ä–æ–∫: 240 √ó 10 √ó 2 = 4.8 KB √ó 2 = **9.6 KB DRAM**
- –¢–µ–∫—É—â–∞—è DRAM: 266 KB + 9.6 KB = 275.6 KB (80.6%)
- –°–≤–æ–±–æ–¥–Ω–æ: 52 KB ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ!

**–ü–ª—é—Å—ã:**
- ‚úÖ –ú–∞–ª–µ–Ω—å–∫–∏–π DRAM footprint (9.6 KB –≤–º–µ—Å—Ç–æ 38.4 KB)
- ‚úÖ SPI DMA –±—ã—Å—Ç—Ä—ã–π
- ‚úÖ –ù–µ—Ç mutex contention

**–ú–∏–Ω—É—Å—ã:**
- ‚ö†Ô∏è –ë–æ–ª—å—à–µ flush –≤—ã–∑–æ–≤–æ–≤ (320/10 = 32 –≤–º–µ—Å—Ç–æ 320/40 = 8)
- ‚ö†Ô∏è –û–±—â–µ–µ –≤—Ä–µ–º—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: Hybrid –ø–æ–¥—Ö–æ–¥ - 1 –±—É—Ñ–µ—Ä DRAM, 1 –±—É—Ñ–µ—Ä PSRAM

```c
// –û–¥–∏–Ω –±—É—Ñ–µ—Ä –≤ DRAM –¥–ª—è DMA, –≤—Ç–æ—Ä–æ–π –≤ PSRAM
disp_buf1 = heap_caps_malloc(LCD_H_RES * 40 * sizeof(lv_color_t), 
                              MALLOC_CAP_DMA | MALLOC_CAP_INTERNAL);  // 19.2 KB DRAM
disp_buf2 = heap_caps_malloc(LCD_H_RES * 40 * sizeof(lv_color_t), 
                              MALLOC_CAP_SPIRAM);  // 19.2 KB PSRAM
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- LVGL —Ä–∏—Å—É–µ—Ç –≤ –±—É—Ñ–µ—Ä 2 (PSRAM) –ø–æ–∫–∞ –±—É—Ñ–µ—Ä 1 (DRAM) –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è
- –ü–µ—Ä–µ–¥ flush –∫–æ–ø–∏—Ä—É–µ—Ç –∏–∑ PSRAM –≤ DRAM
- SPI DMA —á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∏–∑ DRAM

**–ü–ª—é—Å—ã:**
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è 19.2 KB DRAM
- ‚úÖ SPI flush –±—ã—Å—Ç—Ä—ã–π

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –ù—É–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ PSRAM‚ÜíDRAM –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º flush
- ‚ùå –£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ –∫–æ–¥–∞

---

### –í–∞—Ä–∏–∞–Ω—Ç 4: ‚≠ê –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å EDMA –¥–ª—è PSRAM (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é!)

ESP32-S3 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç EDMA (Enhanced DMA) –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å PSRAM:

```c
// –í—ã–¥–µ–ª—è–µ–º –≤ PSRAM —Å 8-byte alignment –¥–ª—è EDMA
disp_buf1 = heap_caps_aligned_alloc(8, LCD_H_RES * 40 * sizeof(lv_color_t), 
                                     MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT);
disp_buf2 = heap_caps_aligned_alloc(8, LCD_H_RES * 40 * sizeof(lv_color_t), 
                                     MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT);
```

**–ò –≤–∫–ª—é—á–∏—Ç—å EDMA –¥–ª—è SPI –≤ sdkconfig:**
```ini
CONFIG_LCD_RGB_ISR_IRAM_SAFE=y
CONFIG_SPI_MASTER_ISR_IN_IRAM=y
```

---

## üìä –°–†–ê–í–ù–ò–¢–ï–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –î–û (SRAM) | –ü–û–°–õ–ï (PSRAM) | –ü—Ä–æ–±–ª–µ–º–∞ |
|----------|-----------|---------------|----------|
| **–†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞** | 28.8 KB √ó 2 | 19.2 KB √ó 2 | ‚úÖ –ú–µ–Ω—å—à–µ |
| **–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ** | SRAM | PSRAM | ‚ö†Ô∏è –ú–µ–¥–ª–µ–Ω–Ω–µ–µ |
| **–î–æ—Å—Ç—É–ø SPI DMA** | –ü—Ä—è–º–æ–π | –ß–µ—Ä–µ–∑ cache | ‚ùå –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å |
| **Flush –≤—Ä–µ–º—è** | 20-30 –º—Å | 100-500 –º—Å | ‚ùå –í 10-20 —Ä–∞–∑ –º–µ–¥–ª–µ–Ω–Ω–µ–µ! |
| **Mutex hold** | 50-80 –º—Å | 500+ –º—Å | ‚ùå –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ |
| **Display timeout** | 100 –º—Å (OK) | 500 –º—Å (FAIL) | ‚ùå –ù–µ —É—Å–ø–µ–≤–∞–µ—Ç |
| **Watchdog** | OK | Timeout | ‚ùå –ö—Ä–∏—Ç–∏—á–Ω–æ |
| **DRAM usage** | 265 KB (overflow!) | 228 KB (OK) | ‚úÖ –†–µ—à–µ–Ω–æ |

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–û–ï –†–ï–®–ï–ù–ò–ï

### ‚≠ê –í–µ—Ä–Ω—É—Ç—å –ú–ê–õ–ï–ù–¨–ö–ò–ï –±—É—Ñ–µ—Ä—ã –≤ DRAM (10-20 —Å—Ç—Ä–æ–∫)

**–ö–æ–¥:**
```c
// components/lcd_ili9341/lcd_ili9341.c

// –£–º–µ–Ω—å—à–∞–µ–º –¥–æ 10 —Å—Ç—Ä–æ–∫ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ DRAM —Å DMA
if (disp_buf1 == NULL) {
    size_t buf_size = LCD_H_RES * 10 * sizeof(lv_color_t);  // 4.8 KB
    disp_buf1 = heap_caps_malloc(buf_size, MALLOC_CAP_DMA | MALLOC_CAP_INTERNAL);
    ESP_LOGI("LCD", "Display buffer 1 allocated in DRAM (DMA): %d bytes", buf_size);
}

if (disp_buf2 == NULL) {
    size_t buf_size = LCD_H_RES * 10 * sizeof(lv_color_t);  // 4.8 KB
    disp_buf2 = heap_caps_malloc(buf_size, MALLOC_CAP_DMA | MALLOC_CAP_INTERNAL);
    ESP_LOGI("LCD", "Display buffer 2 allocated in DRAM (DMA): %d bytes", buf_size);
}

// –ò –≤ lv_draw_buf_init:
lv_draw_buf_init(&draw_buf1, LCD_H_RES, 10, ...);
lv_draw_buf_init(&draw_buf2, LCD_H_RES, 10, ...);
```

**–†–∞—Å—á–µ—Ç DRAM:**
```
–¢–µ–∫—É—â–∞—è DRAM: 266 KB
–î–æ–±–∞–≤–∏–º –±—É—Ñ–µ—Ä—ã: +9.6 KB (2 √ó 4.8 KB)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û: 275.6 KB / 328 KB (84%)
–°–≤–æ–±–æ–¥–Ω–æ: 52 KB ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è WiFi (~10 KB)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
1. ‚úÖ SPI DMA –±—ã—Å—Ç—Ä—ã–π (–∏–∑ DRAM)
2. ‚úÖ Flush –∑–∞ 10-15 –º—Å (10 —Å—Ç—Ä–æ–∫ –≤–º–µ—Å—Ç–æ 40)
3. ‚úÖ Mutex hold < 50 –º—Å
4. ‚úÖ Display task —É—Å–ø–µ–≤–∞–µ—Ç (timeout 500 –º—Å)
5. ‚úÖ –ù–µ—Ç watchdog timeout
6. ‚úÖ DRAM –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω (84% –≤–º–µ—Å—Ç–æ 92%)

---

## üìà –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–û–ï –†–ï–®–ï–ù–ò–ï: –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä PSRAM –±—É—Ñ–µ—Ä–∞

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å PSRAM, –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å:

```c
// –û–≥—Ä–æ–º–Ω—ã–µ –±—É—Ñ–µ—Ä—ã –≤ PSRAM –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ flush
disp_buf1 = heap_caps_malloc(LCD_H_RES * 160 * sizeof(lv_color_t), MALLOC_CAP_SPIRAM);  // 76.8 KB
// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –û–î–ò–ù –±—É—Ñ–µ—Ä (single buffering)

lv_draw_buf_init(&draw_buf1, LCD_H_RES, 160, ...);
lv_display_set_draw_buffers(disp, &draw_buf1, NULL);  // –¢–æ–ª—å–∫–æ 1 –±—É—Ñ–µ—Ä
```

**–ò–¥–µ—è:** –í–µ—Å—å —ç–∫—Ä–∞–Ω –∑–∞ –æ–¥–∏–Ω flush ‚Üí —Ä–µ–¥–∫–∏–µ –Ω–æ –¥–æ–ª–≥–∏–µ flush

**–ü–ª—é—Å—ã:**
- –ú–µ–Ω—å—à–µ flush –≤—ã–∑–æ–≤–æ–≤ (320/160 = 2 –≤–º–µ—Å—Ç–æ 320/40 = 8)

**–ú–∏–Ω—É—Å—ã:**
- –ö–∞–∂–¥—ã–π flush 500+ –º—Å (–Ω–æ —Ä–µ–∂–µ)
- –ù–µ—Ç –¥–≤–æ–π–Ω–æ–π –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏
- –í—Å–µ —Ä–∞–≤–Ω–æ mutex contention

---

## üî¨ –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ü–†–ò–ß–ò–ù–ê

### SPI + PSRAM –Ω–∞ ESP32-S3:

**–ü—Ä–æ–±–ª–µ–º–∞:** ESP32-S3 SPI controller –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä—è–º–æ–π DMA –∏–∑ PSRAM!

```
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ESP32-S3:
"SPI DMA can only access internal SRAM. 
 For PSRAM, data must be copied to internal buffer first."
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. SPI DMA –ø—ã—Ç–∞–µ—Ç—Å—è —á–∏—Ç–∞—Ç—å –∏–∑ PSRAM
2. CPU –¥–µ–ª–∞–µ—Ç cache lookup –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞–π—Ç–∞
3. Cache miss ‚Üí –∑–∞–ø—Ä–æ—Å –≤ PSRAM (80 MHz vs 240 MHz SRAM)
4. –ñ–¥–µ—Ç –æ—Ç–≤–µ—Ç–∞ (–ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å 4-8 —Ü–∏–∫–ª–æ–≤)
5. –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –∫—ç—à–∞
6. –†–µ–∑—É–ª—å—Ç–∞—Ç: **–í 10-20 —Ä–∞–∑ –º–µ–¥–ª–µ–Ω–Ω–µ–µ!**

---

## ‚úÖ –í–´–í–û–î–´ –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. –î–û –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–ª–æ –ø–æ—Ç–æ–º—É —á—Ç–æ:
```
‚úÖ –ë—É—Ñ–µ—Ä—ã –≤ SRAM
‚úÖ SPI DMA –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø
‚úÖ Flush –±—ã—Å—Ç—Ä—ã–π (20-30 –º—Å)
‚úÖ Mutex –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–æ
```

### 2. –ü–û–°–õ–ï –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Ç–æ–º—É —á—Ç–æ:
```
‚ùå –ë—É—Ñ–µ—Ä—ã –≤ PSRAM
‚ùå SPI DMA —á–µ—Ä–µ–∑ cache
‚ùå Flush –º–µ–¥–ª–µ–Ω–Ω—ã–π (100-500 –º—Å)
‚ùå Mutex –¥–µ—Ä–∂–∏—Ç—Å—è –¥–æ–ª–≥–æ
‚ùå Watchdog timeout
```

### 3. –ù—É–∂–Ω–æ:
```
‚≠ê –í–µ—Ä–Ω—É—Ç—å –±—É—Ñ–µ—Ä—ã –≤ DRAM (10-20 —Å—Ç—Ä–æ–∫)
‚≠ê –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MALLOC_CAP_DMA
‚≠ê –†–∞–∑–º–µ—Ä: 2 √ó 10 —Å—Ç—Ä–æ–∫ = 9.6 KB DRAM
‚≠ê DRAM –∏—Ç–æ–≥–æ: 275 KB (84%) ‚úÖ OK
```

---

## üöÄ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –°–ï–ô–ß–ê–°

–ü—Ä–∏–º–µ–Ω—è—é —Ä–µ—à–µ–Ω–∏–µ: **10-—Å—Ç—Ä–æ—á–Ω—ã–µ –±—É—Ñ–µ—Ä—ã –≤ DRAM —Å DMA**

–≠—Ç–æ –¥–∞—Å—Ç:
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π SPI flush
- ‚úÖ –ú–∞–ª—ã–π DRAM footprint
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- ‚úÖ WiFi –≤—Å–µ –µ—â–µ –≤–ª–µ–∑–∞–µ—Ç

