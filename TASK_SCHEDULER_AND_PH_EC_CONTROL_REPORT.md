# Отчет по планировщику задач и системе коррекции pH/EC

## Обзор

Данный отчет описывает реализацию планировщика задач и системы автоматической коррекции параметров pH и EC с помощью перистальтических насосов для системы гидропоники.

## Новые компоненты

### 1. task_scheduler - Планировщик задач

**Назначение:** Централизованное управление выполнением задач по расписанию с поддержкой повторяющихся задач.

**Основные функции:**
- Создание и управление задачами
- Поддержка повторяющихся задач (ежедневно, еженедельно, ежемесячно, по расписанию)
- Приоритизация задач
- Callback система для исполнителей задач
- Условия выполнения задач
- Статистика и мониторинг

**Типы задач:**
- `TASK_TYPE_PUMP_CONTROL` - Управление насосами
- `TASK_TYPE_PH_CORRECTION` - Коррекция pH
- `TASK_TYPE_EC_CORRECTION` - Коррекция EC
- `TASK_TYPE_SENSOR_READING` - Чтение датчиков
- `TASK_TYPE_SYSTEM_CHECK` - Проверка системы
- `TASK_TYPE_DATA_LOG` - Логирование данных
- `TASK_TYPE_NOTIFICATION` - Уведомления
- `TASK_TYPE_CUSTOM` - Пользовательские задачи

**Приоритеты задач:**
- `TASK_PRIORITY_LOW` - Низкий
- `TASK_PRIORITY_NORMAL` - Обычный
- `TASK_PRIORITY_HIGH` - Высокий
- `TASK_PRIORITY_CRITICAL` - Критический

**Повторяемость:**
- `TASK_REPEAT_NONE` - Однократно
- `TASK_REPEAT_DAILY` - Ежедневно
- `TASK_REPEAT_WEEKLY` - Еженедельно
- `TASK_REPEAT_MONTHLY` - Ежемесячно
- `TASK_REPEAT_CUSTOM` - По пользовательскому расписанию

### 2. ph_ec_controller - Контроллер pH/EC

**Назначение:** Автоматическая коррекция параметров pH и EC с помощью перистальтических насосов.

**Конфигурация насосов:**
- **pH UP** (насос 0) - повышение pH
- **pH DOWN** (насос 1) - понижение pH
- **EC A** (насос 2) - раствор A для EC
- **EC B** (насос 3) - раствор B для EC
- **EC C** (насос 4) - раствор C для EC
- **WATER** (насос 5) - подача воды

**Параметры насосов:**
- Скорость потока (мл/сек)
- Минимальная/максимальная длительность работы
- Время охлаждения между включениями
- Коэффициент концентрации раствора

**Алгоритм коррекции pH:**
1. Проверка отклонения от целевого значения
2. Расчет необходимого объема коррекции
3. Выбор насоса (pH UP или pH DOWN)
4. Расчет длительности работы насоса
5. Выполнение коррекции с контролем безопасности

**Алгоритм коррекции EC:**
1. Проверка отклонения от целевого значения
2. Выбор типа раствора (A, B или C)
3. Расчет необходимого объема коррекции
4. Расчет длительности работы насоса
5. Выполнение коррекции с контролем безопасности

## Интегрированное приложение

### app_main_advanced.c

**Архитектура:**
- Многозадачная система с 6 основными задачами
- Планировщик задач для автоматического управления
- Контроллер pH/EC для коррекции параметров
- Интеграция всех компонентов системы

**Задачи:**
1. **sensor_task** - Чтение данных с датчиков
2. **display_task** - Обновление пользовательского интерфейса
3. **notification_task** - Обработка уведомлений
4. **data_logger_task** - Логирование данных
5. **scheduler_task** - Выполнение запланированных задач
6. **ph_ec_task** - Обработка контроллера pH/EC

**Автоматические задачи:**
- Системная проверка каждые 5 минут
- Чтение датчиков каждые 2 секунды
- Автоматическая коррекция pH и EC при отклонениях
- Мониторинг состояния насосов

## Ключевые особенности

### 1. Безопасность
- Контроль минимальных и максимальных интервалов между коррекциями
- Ограничение максимального объема коррекции за раз
- Время охлаждения насосов между включениями
- Экстренная остановка всех операций

### 2. Точность
- Расчет объема коррекции на основе концентрации растворов
- Учет скорости потока насосов
- Компенсация задержек в системе

### 3. Гибкость
- Настраиваемые параметры для каждого насоса
- Различные типы растворов для EC
- Условия выполнения задач
- Приоритизация задач

### 4. Мониторинг
- Статистика работы насосов
- История коррекций
- Логирование всех операций
- Уведомления о событиях

## Использование

### Создание задачи коррекции pH
```c
task_scheduler_create_ph_correction_task(6.8f, 6.2f, 5000);
```

### Создание задачи коррекции EC
```c
task_scheduler_create_ec_correction_task(1.5f, 1.2f, 0, 3000); // раствор A
```

### Создание задачи управления насосом
```c
task_scheduler_create_pump_control_task(0, true, 2000, "pH correction");
```

### Ручная коррекция pH
```c
ph_ec_controller_correct_ph(6.2f, 6.8f, "manual correction");
```

### Ручная коррекция EC
```c
ph_ec_controller_correct_ec(1.2f, 1.5f, 0, "manual correction"); // раствор A
```

### Настройка автоматической коррекции
```c
ph_ec_controller_set_auto_correction_enabled(true, true);
```

## Конфигурация

### Настройка насосов
```c
pump_config_t config = {
    .name = "pH UP",
    .enabled = true,
    .flow_rate_ml_per_sec = 1.0f,
    .min_duration_ms = 100,
    .max_duration_ms = 30000,
    .cooldown_ms = 5000,
    .concentration_factor = 1.0f
};
ph_ec_controller_set_pump_config(0, &config);
```

### Настройка коррекции pH
```c
ph_correction_config_t ph_config = {
    .target_ph = 6.8f,
    .tolerance = 0.1f,
    .ph_up_concentration = 0.1f,
    .ph_down_concentration = 0.1f,
    .max_correction_ml = 50.0f,
    .min_interval_ms = 300000,
    .auto_correction_enabled = true
};
ph_ec_controller_set_ph_config(&ph_config);
```

### Настройка коррекции EC
```c
ec_correction_config_t ec_config = {
    .target_ec = 1.5f,
    .tolerance = 0.1f,
    .solution_a_concentration = 0.1f,
    .solution_b_concentration = 0.1f,
    .solution_c_concentration = 0.1f,
    .max_correction_ml = 100.0f,
    .min_interval_ms = 600000,
    .auto_correction_enabled = true
};
ph_ec_controller_set_ec_config(&ec_config);
```

## Алгоритмы коррекции

### Коррекция pH
```
Объем_коррекции = |текущий_pH - целевой_pH| / концентрация_раствора * базовый_коэффициент
Длительность_насоса = Объем_коррекции / скорость_потока_насоса
```

### Коррекция EC
```
Объем_коррекции = |текущий_EC - целевой_EC| / концентрация_раствора * базовый_коэффициент
Длительность_насоса = Объем_коррекции / скорость_потока_насоса
```

## Безопасные режимы

### Ограничения по времени
- Минимальный интервал между коррекциями: 5 минут (pH), 10 минут (EC)
- Максимальная длительность работы насоса: 30 секунд
- Время охлаждения насоса: 5 секунд

### Ограничения по объему
- Максимальный объем коррекции pH: 50 мл за раз
- Максимальный объем коррекции EC: 100 мл за раз
- Контроль переполнения резервуаров

### Мониторинг состояния
- Проверка готовности насосов к работе
- Контроль температуры насосов
- Мониторинг уровня растворов

## Статистика и аналитика

### Статистика насосов
- Общее время работы
- Количество включений
- Общий объем перекачанной жидкости
- Время последней работы

### Статистика коррекций
- Количество коррекций pH/EC
- Общий объем использованных растворов
- Эффективность коррекций
- История изменений параметров

### Статистика планировщика
- Общее количество задач
- Выполненные задачи
- Неудачные задачи
- Время последнего выполнения

## Интеграция с существующими компонентами

### Конфигурация
- Использование настроек из config_manager
- Сохранение параметров насосов в NVS
- Синхронизация с системными настройками

### Уведомления
- Уведомления о работе насосов
- Алерты о критических отклонениях
- Предупреждения о технических проблемах

### Логирование
- Логирование всех операций коррекции
- Запись статистики работы насосов
- Отслеживание эффективности системы

## Планы развития

### 1. Машинное обучение
- Адаптивные алгоритмы коррекции
- Прогнозирование потребности в коррекции
- Оптимизация времени и объема коррекций

### 2. Расширенная аналитика
- Анализ трендов параметров
- Корреляционный анализ датчиков
- Рекомендации по оптимизации

### 3. Удаленное управление
- Веб-интерфейс для управления насосами
- Мобильное приложение
- API для интеграции с внешними системами

### 4. Дополнительные датчики
- Датчики уровня растворов
- Датчики давления в системе
- Контроль качества воды

## Заключение

Реализованная система планировщика задач и коррекции pH/EC обеспечивает:

- **Автоматизацию** - полная автоматизация коррекции параметров
- **Безопасность** - многоуровневая система защиты от ошибок
- **Точность** - точные расчеты объемов и времени коррекции
- **Гибкость** - настраиваемые параметры для различных условий
- **Надежность** - отказоустойчивая архитектура с мониторингом

Система готова к использованию в промышленных и домашних гидропонных установках, обеспечивая стабильные условия для роста растений.
