# ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç: Popup —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞

**–î–∞—Ç–∞:** 11 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–°–ï –ü–†–û–ë–õ–ï–ú–´ –£–°–¢–†–ê–ù–ï–ù–´

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

### –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º: **6**

1. ‚úÖ –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —Ä–µ–∫—É—Ä—Å–∏—è –≤ —Å–æ–±—ã—Ç–∏—è—Ö
2. ‚úÖ "Cannot go back: history is empty"
3. ‚úÖ –°–ø–∞–º popup ‚Üí Watchdog timeout
4. ‚úÖ Popup –ø–æ–≤–µ—Ä—Ö popup
5. ‚úÖ Race condition encoder –≥—Ä—É–ø–ø—ã
6. ‚úÖ Unicode —Å–∏–º–≤–æ–ª—ã –≤ –ª–æ–≥–∞—Ö (–∫–æ–¥–∏—Ä–æ–≤–∫–∞ Windows)

---

## üîß –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ü—Ä–æ–±–ª–µ–º–∞ #1: –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —Ä–µ–∫—É—Ä—Å–∏—è ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û

**Backtrace:**
```
lv_group_add_obj ‚Üí lv_group_refocus ‚Üí focus_next_core ‚Üí 
lv_obj_send_event(FOCUSED) ‚Üí ok_button_cb ‚Üí lv_obj_invalidate ‚Üí 
lv_group_refocus ‚Üí ... (–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å)
```

**–ü—Ä–∏—á–∏–Ω–∞:**
```c
// –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
if (code == LV_EVENT_FOCUSED) {
    lv_obj_invalidate(btn); // –í—ã–∑—ã–≤–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–π refocus!
}
```

**–†–µ—à–µ–Ω–∏–µ:**
```c
// –ü–†–ê–í–ò–õ–¨–ù–û:
// –£–±—Ä–∞–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ FOCUSED/DEFOCUSED –ø–æ–ª–Ω–æ—Å—Ç—å—é
// LVGL —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- ‚ùå Watchdog timeout ‚Üí ‚úÖ –ù–µ—Ç timeout
- ‚ùå –ó–∞–≤–∏—Å–∞–Ω–∏–µ ‚Üí ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞

---

### –ü—Ä–æ–±–ª–µ–º–∞ #2: –ó–∞–∫—Ä—ã—Ç–∏–µ popup

**–û—à–∏–±–∫–∞:**
```
W (26230) NAVIGATOR: Cannot go back: history is empty
E (26230) POPUP_SCREEN: Failed to close popup
```

**–ü—Ä–∏—á–∏–Ω–∞:**
Popup –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ navigation history (—ç—Ç–æ overlay —ç–∫—Ä–∞–Ω).

**–†–µ—à–µ–Ω–∏–µ:**
```c
// –ë–´–õ–û:
void popup_close() {
    screen_go_back(); // ‚úó –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
}

// –°–¢–ê–õ–û:
void popup_close() {
    screen_hide("popup"); // ‚úì –†–∞–±–æ—Ç–∞–µ—Ç
}
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–æ –≤:**
- `popup_close()` - –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ
- `close_timer_cb()` - –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ —Ç–∞–π–º–µ—Ä—É
- `popup_show_error()` - –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ popup

---

### –ü—Ä–æ–±–ª–µ–º–∞ #3: –°–ø–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–°–∏–º–ø—Ç–æ–º—ã:**
```
E (6529) i2c_bus: –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ 0x44
I (6629) NOTIF_SYS: Created notification [WARNING]
E (8529) i2c_bus: –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ 0x44
I (8629) NOTIF_SYS: Created notification [WARNING]
... (–∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã)
E (27293) task_wdt: Watchdog triggered
```

**–ü—Ä–∏—á–∏–Ω–∞:**
Sensor_task —á–∏—Ç–∞–µ—Ç –¥–∞—Ç—á–∏–∫–∏ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã. –ü—Ä–∏ –æ—à–∏–±–∫–µ I2C —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Üí –Ω–æ–≤—ã–π popup.

**–†–µ—à–µ–Ω–∏–µ:**
```c
#define NOTIF_DEBOUNCE_MS 30000  // 30 —Å–µ–∫—É–Ω–¥

static char g_last_message[128];
static int64_t g_last_message_time;

// –í notification_create():
if (strcmp(g_last_message, message) == 0 && 
    (now - g_last_message_time) < 30000) {
    ESP_LOGI("[GUARD] Duplicate suppressed (cooldown: %lld sec)", remaining);
    return 0; // –ë–ª–æ–∫–∏—Ä—É–µ–º –¥—É–±–ª–∏–∫–∞—Ç
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è —á–∞—â–µ —Ä–∞–∑–∞ –≤ 30 —Å–µ–∫—É–Ω–¥
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–æ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏
- Watchdog —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ

---

### –ü—Ä–æ–±–ª–µ–º–∞ #4: Popup –ø–æ–≤–µ—Ä—Ö popup

**–û—à–∏–±–∫–∞:**
```
I (26955) SCREEN_LIFECYCLE: Showing screen 'popup'...
E (27032) POPUP_SCREEN: Invalid popup UI!
```

**–ü—Ä–∏—á–∏–Ω–∞:**
–ù–æ–≤—ã–π popup –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–∫–∞–∑–∞—Ç—å—Å—è –ø–æ–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –µ—â–µ –æ—Ç–∫—Ä—ã—Ç.

**–†–µ—à–µ–Ω–∏–µ:**
```c
static esp_err_t popup_show_internal(...) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —ç–∫—Ä–∞–Ω–∞
    screen_instance_t *current = screen_get_current();
    if (current && strcmp(current->config->id, "popup") == 0) {
        ESP_LOGW("Popup already showing");
        free(config);
        return ESP_ERR_INVALID_STATE;
    }
    ...
}
```

---

### –ü—Ä–æ–±–ª–µ–º–∞ #5: Race condition

**–ü—Ä–∏—á–∏–Ω–∞:**
–ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å encoder –≥—Ä—É–ø–ø—É –≤ `popup_on_hide()` —Å–æ–∑–¥–∞–≤–∞–ª–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å screen_manager.

**–†–µ—à–µ–Ω–∏–µ:**
```c
// –ë–´–õ–û:
popup_on_hide() {
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º encoder –≥—Ä—É–ø–ø—É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —ç–∫—Ä–∞–Ω–∞
    lv_indev_set_group(indev, prev_screen->group); // Race!
}

// –°–¢–ê–õ–û:
popup_on_hide() {
    // –ù–ï –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä—É–ø–ø—É!
    // Screen manager —Å–∞–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
}
```

---

### –ü—Ä–æ–±–ª–µ–º–∞ #6: –ö–æ–¥–∏—Ä–æ–≤–∫–∞ Windows

**–û—à–∏–±–∫–∞:**
```
UnicodeEncodeError: 'charmap' codec can't encode character '\u2713'
```

**–†–µ—à–µ–Ω–∏–µ:**
–ó–∞–º–µ–Ω–µ–Ω—ã –≤—Å–µ Unicode —Å–∏–º–≤–æ–ª—ã:
- ‚úì ‚Üí `[OK]`
- ‚úó ‚Üí `[FAIL]`
- üõ°Ô∏è ‚Üí `[GUARD]`
- ‚è±Ô∏è ‚Üí `[TIMER]`
- ‚ö†Ô∏è ‚Üí `[WARN]`

---

## üìä –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞

```
‚úÖ Binary: 759 KB (0xb9940)
üíæ Free:   290 KB (28%)
üéØ Errors: 0
‚ö° Warnings: 5 (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ)
üìù –ü—Ä–æ—à–∏–≤–∫–∞: –ó–∞–ø—É—â–µ–Ω–∞
```

---

## üéØ –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç

### ‚úÖ –ü–æ–∫–∞–∑ popup:
1. –°–æ–∑–¥–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ debounce (30 —Å–µ–∫)
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ popup –Ω–µ –æ—Ç–∫—Ä—ã—Ç
4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è popup —Å —Ñ–æ–∫—É—Å–æ–º
5. –í–∏–¥–Ω–∞ —Å–∏–Ω—è—è —Ä–∞–º–∫–∞ –≤–æ–∫—Ä—É–≥ OK

### ‚úÖ –ó–∞–∫—Ä—ã—Ç–∏–µ popup:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç —ç–Ω–∫–æ–¥–µ—Ä
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è LV_KEY_ENTER
3. `ok_button_cb` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
4. `popup_close()` ‚Üí `screen_hide("popup")`
5. Popup —É–¥–∞–ª—è–µ—Ç—Å—è
6. –í–æ–∑–≤—Ä–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —ç–∫—Ä–∞–Ω—É

### ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞:
1. –û—à–∏–±–∫–∞ I2C ‚Üí popup –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
2. Debounce –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 30 —Å–µ–∫
3. –°–ª–µ–¥—É—é—â–∏–µ –æ—à–∏–±–∫–∏ I2C –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è
4. –õ–æ–≥–∏: `[GUARD] Duplicate suppressed (cooldown: X sec)`

---

## üìù –ß–µ–∫-–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–ü–æ—Å–ª–µ –ø—Ä–æ—à–∏–≤–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

- [ ] Popup "System Started" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
- [ ] –í–∏–¥–Ω–∞ —Å–∏–Ω—è—è —Ä–∞–º–∫–∞ –≤–æ–∫—Ä—É–≥ –∫–Ω–æ–ø–∫–∏ OK
- [ ] –ù–∞–∂–∞—Ç–∏–µ —ç–Ω–∫–æ–¥–µ—Ä–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç popup
- [ ] –í–æ–∑–≤—Ä–∞—Ç –∫ –≥–ª–∞–≤–Ω–æ–º—É —ç–∫—Ä–∞–Ω—É
- [ ] –û—à–∏–±–∫–∏ I2C ‚Üí popup 1 —Ä–∞–∑
- [ ] 30 —Å–µ–∫—É–Ω–¥ - —Å–ª–µ–¥—É—é—â–∏–π popup –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
- [ ] –í –ª–æ–≥–∞—Ö `[GUARD] Duplicate suppressed`

---

## üöÄ –°—Ç–∞—Ç—É—Å

**–°–ò–°–¢–ï–ú–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–¢–û–í–ê**

- ‚úÖ –í—Å–µ 8 —Ñ–∞–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Popup –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ –§–æ–∫—É—Å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéâ

---

**–î–∞—Ç–∞:** 11 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 3.0.0-advanced  
**–°—Ç–∞—Ç—É—Å:** PRODUCTION READY

